<script>
// Content settings API test
// Run with browser_tests --gtest_filter=ExtensionApiTest.ContentSettings

var cs = chrome.experimental.contentSettings;
var default_content_settings = {
  "cookies": "session_only",
  "images": "allow",
  "javascript": "block",
  "plugins": "allow",
  "popups": "block",
  // TODO(bauerb)
  // "geolocation": "ask",
  "notifications": "ask"
};

var settings = {
  "cookies": "block",
  "images": "allow",
  "javascript": "block",
  "plugins": "block",
  "popups": "allow",
  // "geolocation": "block",
  "notifications": "block"
};

Object.prototype.forEach = function(f) {
  for (key in this) {
    if (this.hasOwnProperty(key))
      f(key, this[key]);
  }
}


function expect(expected, message) {
  return chrome.test.callbackPass(function(value) {
    chrome.test.assertEq(expected, value, message);
  });
}
chrome.test.runTests([
  function getThirdPartyCookiesAllowed() {
    cs.global.thirdPartyCookiesAllowed.get(
        {}, 
        expect({ 'value': false,
                 'levelOfControl': "controllable_by_this_extension" },
               "third-party cookies should be blocked"));
  },
  function getReferrersEnabled() {
    cs.global.referrersEnabled.get(
        {},
        expect({ 'value': false,
                 'levelOfControl': "controllable_by_this_extension" },
               "referrers should be disabled"));
  },
  function setThirdPartyCookiesAllowed() {
    cs.global.thirdPartyCookiesAllowed.set(
        {'value': true},
        chrome.test.callbackPass());
  },
  function setReferrersEnabled() {
    cs.global.referrersEnabled.set(
        {'value': true},
        chrome.test.callbackPass());
  },
  function setDefaultContentSettings() {
    default_content_settings.forEach(function(type, setting) {
      cs[type].set({
        'topLevelPattern': '<all_urls>',
        'embeddedPattern': '<all_urls>',
        'setting': setting
      }, chrome.test.callbackPass());
    });
  },
  function setContentSettings() {
    settings.forEach(function(type, setting) {
      cs[type].set({
        'topLevelPattern': 'http://*.google.com/*',
        'embeddedPattern': 'http://*.google.com/*',
        'setting': setting
      }, chrome.test.callbackPass());
    });
  },
  function getContentSettings() {
    settings.forEach(function(type, setting) {
      var message = "Setting for " + type + " should be " + setting;
      cs[type].get({
        'topLevelUrl': 'http://www.google.com',
        'embeddedUrl': 'http://www.google.com'
      }, expect({'setting':setting}, message));
    });
  },
  function invalidSettings() {
    cs.cookies.get({
      'topLevelUrl': '',
      'embeddedUrl': 'moo'
    }, chrome.test.callbackFail("The URL \"moo\" is invalid."));
    cs.plugins.set({
      'topLevelPattern': 'http://example.com/*',
      'embeddedPattern': 'http://example.com/path',
      'setting': 'block'
    }, chrome.test.callbackFail("Specific paths are not allowed."));
    cs.javascript.set({
      'topLevelPattern': 'http://example.com/*',
      'embeddedPattern': 'file:///home/hansmoleman/*',
      'setting': 'allow'
    }, chrome.test.callbackFail("Path wildcards in file URL patterns are not allowed."));
  }
]);
</script>
