<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script>
// Returns the current size of the displayed popup view.
function getCurrentWindowSize() {
  return {
    "top": window.screenTop,
    "left": window.screenLeft,
    "width": window.outerWidth,
    "height": window.outerHeight
  };
}

// Utility that captures the size of the popup window before and after a browser
// move and notifies the test's parent view of the respective sizes.
function doSizingValidation() {
  var initialSize = getCurrentWindowSize();

  // Move the browser, and ensure that the popup is repositioned correctly,
  // and retains its proper size.
  var offset = {'x': 5, 'y': 5};
  chrome.windows.getCurrent(function(browserWindow) {
    chrome.windows.update(browserWindow.id,
                          {
                            "left": browserWindow.left + offset.x,
                            "top": browserWindow.top + offset.y
                          },
                          function(UpdatedWindow) {
      // Yield so that the window move notification may be processed before
      // invoking the callback.  This is required because chrome.windows.update
      // calls its callback in a race with the windows message that repositions
      // the browser.
      // TODO:  Fix this race condition so that the update callback is invoked
      // after all of the update machinery has been invoked.
      var updatePoller = setInterval(function() {
        var newPosition = getCurrentWindowSize();
        if (newPosition.top != initialSize.top) {
          clearInterval(updatePoller);
          chrome.experimental.popup.getParentWindow().onWindowMoveCompleted(
              offset,
              initialSize,
              newPosition);
          window.close();
        }
      }, 50);
    });
  });
}

window.onload = function() {
  // Delay invocation of the sizing test so that layout of the popup may
  // complete.  On windows, onload is called before layout has been performed,
  // so window.screenTop, and the other fields used in getCurrentWindowSize will
  // return 0 until the layout has been performed.
  // TODO: Fix the order of the onload and layout processing.
  var positionPoller = setInterval(function() {
    var initialSize = getCurrentWindowSize();
    if (initialSize.width != 0) {
      clearInterval(positionPoller);
      doSizingValidation();
    }
  }, 50);
}
</script>
</head>
<body style='width:128px; height:128px'>
Testing Popup Sizing
</body>
</html>
