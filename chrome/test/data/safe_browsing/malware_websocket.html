<title>Test whether a WebSocket connection triggers a SafeBrowsing interstitial</title>
<script>
const url = new URL(document.location.href);
const type = url.searchParams.get('type');
// Construct the WebSocket URL from the page URL. The server should not be
// configured to accept a WebSocket handshake at this endpoint, or the "not
// blocked" test will fail. A 404 error is perfect.
const wsUrl = new URL('/safe_browsing/malware-ws', url);
wsUrl.protocol = 'ws';

function workerTest() {
  const src = `
const ws = new WebSocket('${wsUrl}');
ws.onerror = () => {
  postMessage('COMPLETED');
};
`;
  const blob = new Blob([src]);
  const srcUrl = URL.createObjectURL(blob);
  const worker = new Worker(srcUrl);
  worker.onmessage = signalComplete;
}

switch (type) {
  case 'worker':
    workerTest();
    break;

  default:
    windowTest();
    break;
}

function windowTest() {
  const ws = new WebSocket(wsUrl.href);
  ws.onerror = signalComplete;
}

function signalComplete() {
  // The "not blocked" test looks for this title change to verify that the
  // request has not been blocked.
  document.title = 'COMPLETED';
}
</script>
