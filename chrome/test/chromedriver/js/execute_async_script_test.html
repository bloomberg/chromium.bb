<!DOCTYPE HTML>
<html>
<script src='test.js'></script>
<script src='execute_async_script.js'></script>
<script>

async function testScriptThrows() {
  let promise = executeAsyncScript('f(123);', [], true).then((result) => {
    assert(false);
  }).catch((error) => {
    assertEquals(StatusCode.JAVASCRIPT_ERROR, error.code);
    return 1;
  });

  let result = await promise;
  assertEquals(1, result);

  executeAsyncScript('f(123);', [], false).then((result) => {
    assert(false);
  }).catch((error) => {
    assertEquals(StatusCode.UNKNOWN_ERROR, error.code);
    return 1;
  });
  result = await promise;
  assertEquals(1, result);
}

async function testUserScriptWithArgs() {
  var injectedArgs = null;
  function captureArguments(args) {
    injectedArgs = args;
  }
  // Pass function captureArguments as the first argument. It is used to capture
  // the injected arguments to the following script.
  var script =
      'var args = arguments; args[0](args); args[args.length - 1](args[1]);';
  var script_args = [captureArguments, 1];
  await executeAsyncScript(script, script_args, true).then((result) => {
    assertEquals(1, result);
  });
  assertEquals(3, injectedArgs.length);
  assertEquals(captureArguments, injectedArgs[0]);
  assertEquals(1, injectedArgs[1]);
}

async function testNonUserScript() {
  await executeAsyncScript('arguments[1](arguments[0])', [33],
                           false).then((result) => {
    assertEquals(33, result);
  });

  await executeAsyncScript('arguments[2](new Error("ERR"))', [33],
                           false).then((result) => {
    assert(false);
  }).catch((error) => {
    assertEquals(StatusCode.UNKNOWN_ERROR, error.code);
    assertEquals(0, error.message.indexOf('ERR'));
  });

  await executeAsyncScript(`
    var e = new Error("ERR");
    e.code = 111;
    arguments[1](e)`,
    [], false).then((result) => { assert(false); }).catch((error) => {
      assertEquals(111, error.code);
      assertEquals(0,   error.message.indexOf('ERR'));
  });
}
async function testFirstScriptFinishAfterSecondScriptExecute() {
  let firstCompleted = false;
  executeAsyncScript(
    `var f = arguments[0];
     setTimeout(function(){ f(1); }, 100000);`, []).then((result) => {
        firstCompleted = true;
  });
  await executeAsyncScript('var fn = arguments[0]; fn(2);',
                           []).then((result) => {
    assert(!firstCompleted);
    assertEquals(2, result);
  });
}

</script>
<body>
</body>
</html>
