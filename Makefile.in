CFLAGS = @GCC_CFLAGS@

prefix = @prefix@
exec_prefix = @exec_prefix@
udev_rules_dir = @sysconfdir@/udev/rules.d

libs = libwayland-server.so libwayland.so
egl_clients = gears
cairo_clients = flower screenshot terminal image view
compositors = wayland-system-compositor
clients = $(egl_clients) $(cairo_clients)

all : $(libs) $(compositors) $(clients)

libwayland-server.so :				\
	wayland.o				\
	event-loop.o				\
	connection.o				\
	wayland-util.o				\
	wayland-hash.o				\
	wayland-protocol.o

libwayland.so :					\
	wayland-client.o			\
	connection.o				\
	wayland-util.o				\
	wayland-hash.o				\
	wayland-protocol.o

$(libs) : CFLAGS += -fPIC @FFI_CFLAGS@
$(libs) : LDLIBS += @FFI_LIBS@
$(libs) :
	gcc -shared $^ $(LDLIBS)  -o $@

wayland-system-compositor :			\
	wayland-system-compositor.o		\
	evdev.o					\
	cairo-util.o				\
	wayland-util.o

wayland-system-compositor : CFLAGS += @EGL_COMPOSITOR_CFLAGS@
wayland-system-compositor : LDLIBS += ./libwayland-server.so @EGL_COMPOSITOR_LIBS@ -rdynamic -lrt -lEGL

flower : flower.o wayland-glib.o
gears : gears.o window.o wayland-glib.o cairo-util.o
screenshot : screenshot.o wayland-glib.o
terminal : terminal.o window.o wayland-glib.o cairo-util.o
image : image.o window.o wayland-glib.o cairo-util.o
view : view.o window.o wayland-glib.o cairo-util.o

terminal : LDLIBS += -lutil
image : CFLAGS += @GDK_PIXBUF_CFLAGS@
image : LDLIBS += @GDK_PIXBUF_LIBS@
view : CFLAGS += @POPPLER_CFLAGS@
view : LDLIBS += @POPPLER_LIBS@

$(egl_clients) : CFLAGS += @EGL_CLIENT_CFLAGS@
$(egl_clients) : LDLIBS += -L. -lwayland @EGL_CLIENT_LIBS@ -lrt -lEGL
$(cairo_clients) : CFLAGS += @CAIRO_CLIENT_CFLAGS@
$(cairo_clients) : LDLIBS += ./libwayland.so @CAIRO_CLIENT_LIBS@ -lrt

install : $(libs) $(compositors)
	install -d @libdir@ @libdir@/pkgconfig ${udev_rules_dir}
	install $(libs) @libdir@
	install wayland-server.pc wayland.pc @libdir@/pkgconfig
	install wayland-util.h wayland-client.h @includedir@
	install 70-wayland.rules ${udev_rules_dir}

clean :
	rm -f $(clients) $(compositors) *.o *.so

Makefile : Makefile.in
	./config.status
