// Copyright 2018 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

syntax = "proto2";

option optimize_for = LITE_RUNTIME;

package autofill_assistant;

// Context contains client environment details. It's used to filter the
// scripts that can be surfaced to the user.
message ClientContextProto {
  required string chrome_version = 1;
}

// Get the list of scripts that can potentially be run on a url.
message SupportsScriptRequestProto {
  required string url = 1;
  required ClientContextProto client_context = 2;
}

// Response of the list of supported scripts.
message SupportsScriptResponseProto {
  repeated SupportedScriptProto scripts = 1;
}

// Supported script.
message SupportedScriptProto {
  // This is the internal name of the script.
  required string path = 1;

  message PresentationProto {
    // Name to use when suggesting this script to users.
    optional string name = 1;

    // Precondition contains a set of conditions that must hold for a script to
    // be executed. No precondition means that a script can run in any
    // case.
    optional ScriptPreconditionProto precondition = 2;
  }
  optional PresentationProto presentation = 2;
}

message ScriptPreconditionProto {
  // Combined with AND: the elements referenced here must be present.
  repeated ElementReferenceProto elements_exist = 1;
}

enum PolicyType {
  UNKNOWN_POLICY = 0;
  SCRIPT = 1;
  PAGE = 2;
  VALIDATION = 3;
  TRACE = 4;
}

// Initial request to get a script's actions.
message InitialScriptActionsRequestProto {
  message QueryProto {
    required string script_path = 1;
    optional PolicyType policy = 2;
  }
  required QueryProto query = 1;
}

// Next request to get a script's actions.
message NextScriptActionsRequestProto {
  // The server payload received from the previous response.
  required bytes server_payload = 1;
}

// Response of a script's actions.
message ActionsResponseProto {
  // Opaque data that should not be interpreted and must pass this back
  // unchanged in the next request.
  optional bytes server_payload = 1;

  // Actions to be performed in order.
  // Should stop processing as soon as an action fails.
  repeated AssistantActionProto actions = 2;
}

// An assistant action could be performed.
message AssistantActionProto {
  // Next action id: 3.
  oneof action_info {
    ClickProto click = 1;
    TellProto tell = 2;
    UseAddressProto use_address = 3;
    UseCreditCardProto use_card = 4;
    WaitForDomProto wait_for_dom = 5;
  }
}

// A reference to an unique element on the page, possibly nested in frames.
message ElementReferenceProto {
  // A sequence of CSS selectors. Any non-final CSS selector is expected to
  // arrive at a frame or an iframe, i.e. an element that contains another
  // document.
  // APIs are free to reject element references that do not refer to unique
  // elements (i.e. resolve to more than one element on the page).
  repeated string selectors = 1;
}

// Contain all arguments to perform a click.
message ClickProto {
  required ElementReferenceProto element_to_click = 1;
}

// Contain a message to tell the user.
message TellProto {
  required string message = 1;
}

// TODO(crbug.com/806868): Handle it better when there is no local address.
// Ask user to fill a form with a local address if there is, otherwise fail this
// action.
message UseAddressProto {
  // Optional message to show usage of the address, like billing or shipping
  // address.
  optional string usage = 1;

  // Reference to an element in the form that should be filled.
  required ElementReferenceProto form_field_element = 2;
}

// TODO(crbug.com/806868): Handle it better when there is no local credit card.
// Ask user to fill a form with a local credit card if there is, otherwise fail
// this action.
message UseCreditCardProto {
  // A reference to the card number field in the form that should be filled.
  optional ElementReferenceProto form_field_element = 1;
}

// Ask Chrome to wait for an element in the DOM. This can be used to only
// proceed to the next action once the page is ready.
message WaitForDomProto {
  // The element to wait.
  required ElementReferenceProto element = 1;

  // Fail after waiting this amount of time.
  optional int32 timeout_ms = 2;

  // If true, wait for the given element to be absent, otherwise wait for
  // existence.
  optional bool check_for_absence = 3;
}
