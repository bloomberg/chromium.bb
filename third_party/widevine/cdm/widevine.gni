# Copyright 2015 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import("//build/config/chrome_build.gni")
import("//media/media_options.gni")

declare_args() {
  # Enables Widevine key system support. Enabled by default in Google Chrome or
  # on Android. Can be optionally enabled in Chromium.
  enable_widevine = is_chrome_branded || is_android
}

# The Widevine CDM can be updated as a component. This only applies to platforms
# where the CDM is a standalone library (enable_library_cdms == true). Currently
# it's only supported on Windows and Mac. The CDM can still be bundled when it's
# a component, see below.
enable_widevine_cdm_component =
    enable_widevine && enable_library_cdms && (is_win || is_mac)

# The Widevine CDM is bundled as part of Google Chrome builds.
# TODO(hmchen): Provide prebuilt libraries for ARM64.
should_bundle_widevine_cdm = enable_widevine && is_chrome_branded &&
                             enable_library_cdms && target_cpu != "arm64"

enable_widevine_cdm_host_verification =
    enable_widevine && enable_cdm_host_verification

template("widevine_sign_file") {
  # For official builds, generate a signature file for |file| which will
  # be used by Widevine. If |signature_file| is not specified, the signature
  # file will be in the same directory as |file|.
  action(target_name) {
    forward_variables_from(invoker,
                           [
                             "file",
                             "signature_file",
                             "flags",
                             "deps",
                           ])
    assert(defined(file), "File to be signed must be specified.")
    if (!defined(signature_file)) {
      signature_file = "$file.sig"
    }
    if (!defined(flags)) {
      flags = 0
    }

    script = "//third_party/widevine/scripts/signature_generator.py"
    sources = [
      "$file",
    ]
    outputs = [
      "$signature_file",
    ]
    args = [
      "--input_file",
      rebase_path("$file", root_build_dir),
      "--output_file",
      rebase_path("$signature_file", root_build_dir),
      "--flags",
      "$flags",
    ]
  }
}
