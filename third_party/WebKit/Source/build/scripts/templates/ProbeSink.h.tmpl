// Copyright 2017 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

{% from 'macros.tmpl' import source_files_for_generated_file %}
{{source_files_for_generated_file(template_file, input_files)}}

{% set sink_class = (name | to_singular) + "Sink" %}
{% set export_header = config["settings"]["export_header"] %}
{% set export_symbol = config["settings"]["export_symbol"] %}

#ifndef {{sink_class}}_h
#define {{sink_class}}_h

#include <atomic>

#include "{{export_header}}"
#include "platform/heap/HeapAllocator.h"

namespace blink {

{% for agent in agents %}
class {{ agent | agent_name_to_class }};
{% endfor %}

class {{export_symbol}} {{sink_class}} : public GarbageCollectedFinalized<{{sink_class}}> {
  WTF_MAKE_NONCOPYABLE({{sink_class}});

 public:
  enum AgentType : unsigned {
{% for agent in agents %}
    k{{agent | agent_name_to_class }} = 1u << {{loop.index0}},
{% endfor %}
  };

  {{sink_class}}();
  ~{{sink_class}}();
  void Trace(Visitor*);

{% for agent in agents %}
{% set class_name = agent | agent_name_to_class %}
{% set getter_name = class_name | to_lower_case %}
  bool has{{class_name}}s() const { return !m_{{getter_name}}s.IsEmpty(); }
  const HeapHashSet<Member<{{class_name}}>>& {{getter_name}}s() const { return m_{{getter_name}}s; }
  void add{{class_name}}({{class_name}}* agent);
  void remove{{class_name}}({{class_name}}* agent);

{% endfor %}
  // Queries process-wide. Intended for fast-return cases only.
  static bool HasAgentsGlobal(unsigned mask) {
    return s_existingAgents.load(std::memory_order_acquire) & mask;
  }

 private:
{% for agent in agents %}
{% set class_name = agent | agent_name_to_class %}
{% set getter_name = class_name | to_lower_case %}
  HeapHashSet<Member<{{class_name}}>> m_{{getter_name}}s;
{% endfor %}

  // Number of sinks with an enabled agent of each type, used to keep
  // |s_existingAgents| up to date.
  // Access must be guarded by AgentCountMutex in the source file.
{% for agent in agents %}
  static unsigned s_numSinksWith{{agent | agent_name_to_class}};
{% endfor %}

  // Bit-set of types of enabled agent which exist in this process.
  // Always a bitwise-or of AgentType enumerators.
  static std::atomic<unsigned> s_existingAgents;
};

} // namespace blink

#endif // !defined({{sink_class}}_h)
