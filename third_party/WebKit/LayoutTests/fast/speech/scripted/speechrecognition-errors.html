<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<script src="../../../resources/js-test.js"></script>
<script src="file:///gen/layout_test_data/mojo/public/js/mojo_bindings.js"></script>
<script src="file:///gen/third_party/blink/public/mojom/speech/speech_recognizer.mojom.js"></script>
<script src="mock-speechrecognizer.js"></script>
</head>
<body>
<script type="text/javascript">
description('Test Speech JavaScript API errors');

function run() {
    // Check availability of constructors.
    shouldBeTrue("'webkitSpeechRecognition' in self");
    shouldBeFalse("webkitSpeechRecognition == null");

    notAllowedTest();
}

function setDefaultHandlers(r) {
    for (var prop in r) {
        if (prop.match('^on')) {
            r[prop] = function() {
                testFailed('unexpected ' + event.type + ' event!');
                finishJSTest();
            }
        }
    }
}

function notAllowedTest() {
    debug('\nnotAllowedTest():');
    var r = new webkitSpeechRecognition();
    setDefaultHandlers(r);
    window.count = 0;

    r.start();
    mockSpeechRecognizer.setMockSpeechRecognitionError(blink.mojom.SpeechRecognitionErrorCode.kNotAllowed);

    // Check that we get an error event.
    r.onerror = function() {
        debug('onerror');
        shouldBe('count', '0');
        count++;
        shouldBeEqualToString('event.error', 'not-allowed');
        shouldBeEqualToString('event.message', '');
        shouldBeEqualToString('event.type', 'error');
    }

    // Check that we get an end event after the error event.
    r.onend = function() {
        debug('onend');
        shouldBe('count', '1');
        finishJSTest();
    }
}

window.onload = run;
window.jsTestIsAsync = true;
</script>
</body>
</html>
