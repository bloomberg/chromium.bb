<!DOCTYPE html>
<meta charset=utf-8>
<title>Web Locks API: Lock held until callback result resolves</title>
<link rel=help href="https://github.com/inexorabletash/web-locks">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
'use strict';

// For uncaught rejections.
setup({allow_uncaught_exception: true});

function snooze(t, ms) { return new Promise(r => t.step_timeout(r, ms)); }

promise_test(async t => {
  const p = navigator.locks.acquire('resource', lock => 123);
  assert_equals(Promise.resolve(p), p, 'acquire() result is a Promise');
  assert_equals(await p, 123, 'promise resolves to the returned value');
}, 'callback\'s result is promisified if not async');

promise_test(async t => {
  // Resolved when the lock is granted.
  let granted;
  const lock_granted_promise = new Promise(r => { granted = r; });

  // Lock is held until this is resolved.
  let resolve;
  const lock_release_promise = new Promise(r => { resolve = r; });

  const order = [];

  navigator.locks.acquire('resource', lock => {
    granted(lock);
    return lock_release_promise;
  });
  await lock_granted_promise;

  await Promise.all([
    snooze(t, 50).then(() => {
      order.push('1st lock released');
      resolve();
    }),
    navigator.locks.acquire('resource', () => {
      order.push('2nd lock granted');
    })
  ]);

  assert_array_equals(order, ['1st lock released', '2nd lock granted']);
}, 'lock is held until callback\'s returned promise resolves');

promise_test(async t => {
  // Resolved when the lock is granted.
  let granted;
  const lock_granted_promise = new Promise(r => { granted = r; });

  // Lock is held until this is rejected.
  let reject;
  const lock_release_promise = new Promise((_, r) => { reject = r; });

  const order = [];

  navigator.locks.acquire('resource', lock => {
    granted(lock);
    return lock_release_promise;
  });
  await lock_granted_promise;

  await Promise.all([
    snooze(t, 50).then(() => {
      order.push('reject');
      reject(new Error('this uncaught rejection is expected'));
    }),
    navigator.locks.acquire('resource', () => {
      order.push('2nd lock granted');
    })
  ]);

  assert_array_equals(order, ['reject', '2nd lock granted']);
}, 'lock is held until callback\'s returned promise rejects');

</script>
