<html>
<head>
<script src="../inspector-test.js"></script>
<script src="service-workers-test.js"></script>
<script src="../resources-test.js"></script>
<script src="../console-test.js"></script>
<script>
function test()
{
    var scriptURL = "http://127.0.0.1:8000/inspector/service-workers/resources/service-worker-empty.js";
    var scope1 = "http://127.0.0.1:8000/inspector/service-workers/resources/scope1/";
    var scope2 = "http://127.0.0.1:8000/inspector/service-workers/resources/scope2/";
    var expectedTitle1 = "Scope: /inspector/service-workers/resources/scope1/";
    var expectedTitle2 = "Scope: /inspector/service-workers/resources/scope2/";
    var registrationIDs = {};

    InspectorTest.addSniffer(WebInspector.ServiceWorkersView.prototype, "_registrationUpdated", registrationUpdated, true);
    function registrationUpdated(event)
    {
        var registration = event.data;
        registrationIDs[registration.scopeURL] = registration.registrationId;
    }

    InspectorTest.addSniffer(WebInspector.ServiceWorkersView.prototype, "_versionUpdated", versionUpdated, true);
    function dumpServiceWorkersView()
    {
        var swView = WebInspector.panels.resources.visibleView;
        InspectorTest.addResult("==== ServiceWorkersView ====");
        InspectorTest.addResult(swView.root.querySelector(".service-workers-origin-title").innerText);
        var registrationElements = swView.root.querySelectorAll(".service-workers-registration");
        for (var i = 0; i < registrationElements.length; i++) {
            var registrationElement = registrationElements[i];
            var title = registrationElement.querySelector(".service-workers-registration-title").innerText;
            if (title.indexOf(expectedTitle1) == -1 && title.indexOf(expectedTitle2) == -1)
                continue;
            InspectorTest.addResult(title);
            var versionElements = registrationElement.querySelectorAll(".service-workers-version-row");
            for (var j = 0; j < versionElements.length; j++)
                InspectorTest.addResult(versionElements[j].innerText);
        }
        InspectorTest.addResult("============================");
    }

    function versionUpdated(event)
    {
        var version = event.data;
        if (version.registrationId == registrationIDs[scope1] && version.status == "activated" && version.runningStatus == "running") {
            dumpServiceWorkersView();
            InspectorTest.addResult("Register ServiceWorker for scope2");
            InspectorTest.registerServiceWorker(scriptURL, scope2);
        } else if (version.registrationId == registrationIDs[scope2] && version.status == "activated" && version.runningStatus == "running") {
            dumpServiceWorkersView();
            InspectorTest.addResult("Unegister ServiceWorker for scope1");
            InspectorTest.unregisterServiceWorker(scope1);
        } else if (version.registrationId == registrationIDs[scope1] && version.status == "redundant") {
            dumpServiceWorkersView();
            InspectorTest.addResult("Unegister ServiceWorker for scope1");
            InspectorTest.unregisterServiceWorker(scope2);
        } else if (version.registrationId == registrationIDs[scope2] && version.status == "redundant") {
            InspectorTest.completeTest();
        }
    }

    InspectorTest.addResult("Select ServiceWorkers tree element.");
    WebInspector.panels.resources.serviceWorkersTreeElement.select();
    InspectorTest.addResult("Register ServiceWorker for scope1");
    InspectorTest.registerServiceWorker(scriptURL, scope1);
}

</script>
</head>
<body onload="runTest()">
<p>Tests ServiceWorkersView on resources panel.</p>
</body>
</html>
