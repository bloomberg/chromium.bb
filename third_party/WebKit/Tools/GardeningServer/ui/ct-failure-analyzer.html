<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<polymer-element name="ct-failure-analyzer" attributes="failures status builderLatestRevisions">
  <script>
    Polymer({
      failures: {},
      pendingUnexpectedFailures: [],
      builderLatestRevisions: {},

      update: function() {
        this._updateFailingBuilders();
        this._updateUnexpectedFailures();
      },

      _updateFailingBuilders: function() {
        builders.buildersFailingNonLayoutTests().then((function(builders) {
          this.failures.builders = builders;
        }).bind(this));
      },

      _updateBuilderLatestRevisions: function() {
        this.builderLatestRevisions = {};
        Object.keys(config.builders, function(builder) {
          this.builderLatestRevisions[builder] = {
            blink: model.state.resultsByBuilder[builder].blink_revision,
          };
        }.bind(this));
      },

      _updateUnexpectedFailures: function() {
        this.pendingUnexpectedFailures = [];
        var numberOfTestsAnalyzed = 0;
        this.status = 'Updating ...';
        Promise.all([model.updateRecentCommits(), model.updateResultsByBuilder()]).then(function() {
          this.status = 'Analyzing test failures ...';
          model.analyzeUnexpectedFailures(function(failureAnalysis, total) {
            this.status = 'Analyzing test failures ... ' + ++numberOfTestsAnalyzed + '/' + total + ' tests analyzed.';
            this.pendingUnexpectedFailures.push(failureAnalysis);
          }.bind(this)).then(function() {
            this.status = 'Done';
            this.failures.unexpected = this.pendingUnexpectedFailures;
            this._updateBuilderLatestRevisions();
          }.bind(this));
        }.bind(this));
      },
    });
  </script>
</polymer-element>
