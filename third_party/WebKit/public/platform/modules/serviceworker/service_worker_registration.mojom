// Copyright 2017 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

module blink.mojom;

import "third_party/WebKit/public/platform/modules/serviceworker/service_worker_error_type.mojom";
import "url/mojo/url.mojom";

const int32 kInvalidServiceWorkerRegistrationHandleId = -1;
const int64 kInvalidServiceWorkerRegistrationId = -1;

// Represents options for register():
// https://w3c.github.io/ServiceWorker/#dictdef-registrationoptions
struct ServiceWorkerRegistrationOptions {
  url.mojom.Url scope;
  // TODO(yuryu): Other values will be added as they are supported later.
};

// Describes a ServiceWorkerRegistration:
// https://w3c.github.io/ServiceWorker/#serviceworkerregistration-interface
//
// This struct is mostly internal metadata about the ServiceWorkerRegistration.
struct ServiceWorkerRegistrationObjectInfo {
  // The globally unique identifier of a service worker registration entity.
  int64 registration_id = kInvalidServiceWorkerRegistrationId;

  // The id to differentiate a service worker registration entity against
  // multiple JavaScript execution contexts for service worker clients or
  // service worker itself, it is also unique globally.
  // Blink either mints a new ServiceWorkerRegistration object or reuses an
  // existing one based on |handle_id|. This allows ServiceWorkerRegistration
  // objects in different execution contexts to be different, even if they
  // represent the same registration entity (registration_id is equal). They
  // must be different since they should have different prototypes.
  int32 handle_id = kInvalidServiceWorkerRegistrationHandleId;

  // The registration options attached with this registration object, including
  // some information such as scope of this registration.
  ServiceWorkerRegistrationOptions options;

  // Holds one mojo connection to browser process, acts as a reference count to
  // control lifetime of ServiceWorkerRegistration in the browser process.
  associated ServiceWorkerRegistrationObjectHost? host_ptr_info;

  // |request| is expected to be bound on the implementation of interface
  // ServiceWorkerRegistrationObject in the renderer process. The other end
  // point of this Mojo connection is held by the browser process.
  associated ServiceWorkerRegistrationObject&? request;
};

// This interface lives in the browser process, it corresponds to one
// ServiceWorkerRegistration JavaScript object. The renderer uses it to ask the
// browser to do operations needed to implement ServiceWorkerRegistration
// methods.
interface ServiceWorkerRegistrationObjectHost {
  // Corresponds to ServiceWorkerRegistration#update().
  // On success, |error| is kNone without |error_msg| set.
  // Otherwise, |error| and |error_msg| describe the failure.
  Update() => (ServiceWorkerErrorType error, string? error_msg);

  // TODO(leonhsl): Implement all methods.
  // Unregister() => (ServiceWorkerErrorType error, string? error_msg);
};

// This interface lives in the renderer process, it corresponds to one
// ServiceWorkerRegistration JavaScript object. The browser uses it to talk with
// the corresponding impl of ServiceWorkerRegistration in the renderer.
interface ServiceWorkerRegistrationObject {
  // TODO(leonhsl): Implement all methods.
  // SetVersionAttributes(int32 changed_mask,
  //                      ServiceWorkerVersionAttributes attrs);
  // UpdateFound();
};
