<!DOCTYPE html>
<meta charset="utf-8">
<title>Worklet: addModule() on a detached iframe</title>
<body>
</body>
<script src="../resources/testharness.js"></script>
<script src="../resources/testharnessreport.js"></script>
<script>

function with_iframe(url) {
  return new Promise(resolve => {
      let frame = document.createElement('iframe');
      frame.src = url;
      frame.onload = () => { resolve(frame); };
      document.body.appendChild(frame);
      add_result_callback(() => frame.remove());
    });
}

// These tests should not be upstreamed to WPT because the spec does not define
// behavior in the case where addModule() is called from a detached frame.

promise_test(async t => {
  const frame = await with_iframe('resources/blank.html');
  const worklet = frame.contentWindow.CSS.layoutWorklet;
  frame.remove();
  await promise_rejects(
      t, 'InvalidStateError',
      worklet.addModule('resources/empty-worklet-script.js'));
}, '[main thread worklet] addModule() on a detached iframe should be ' +
   'rejected.');

promise_test(async t => {
  const frame = await with_iframe('resources/blank.html');
  const worklet = frame.contentWindow.CSS.animationWorklet;
  frame.remove();
  await promise_rejects(
      t, 'InvalidStateError',
      worklet.addModule('resources/empty-worklet-script.js'));
}, '[off main thread worklet] addModule() on a detached iframe should be ' +
   'rejected.');

promise_test(async t => {
  const frame = await with_iframe('resources/blank.html');
  const worklet = frame.contentWindow.CSS.layoutWorklet;
  const promise = worklet.addModule('resources/empty-worklet-script.js');
  frame.remove();

  // Wait a moment to confirm that asynchronous addModule() operation on the
  // detached iframe doesn't crash. We cannot wait for the promise returned by
  // addModule() because it's never settled after context destruction.
  await new Promise(resolve => setTimeout(resolve, 10));
}, '[main thread worklet] detaching an iframe after addModule() should not ' +
   'crash.');

promise_test(async t => {
  const frame = await with_iframe('resources/blank.html');
  const worklet = frame.contentWindow.CSS.animationWorklet;
  const promise = worklet.addModule('resources/empty-worklet-script.js');
  frame.remove();

  // Wait a moment to confirm that asynchronous addModule() operation on the
  // detached iframe doesn't crash. We cannot wait for the promise returned by
  // addModule() because it's never settled after context destruction.
  await new Promise(resolve => setTimeout(resolve, 10));
}, '[off main thread worklet] detaching an iframe after addModule() should ' +
   'not crash.');

</script>
