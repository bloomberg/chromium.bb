<!doctype html>
<html>
  <head>
    <title>Test GC of Stopped ConstantSourceNode </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../resources/audit-util.js"></script>
    <script src="../resources/audit.js"></script>
  </head>
  <body>
    <script>
      let audit = Audit.createTaskRunner();

      audit.define('Test GC of Stopped ConstantSourceNodes', (task, should) => {
        let context = new AudioContext();
        let gain = new GainNode(context, {gain: 1e-10});
        gain.connect(context.destination);

        // When |lastSrc0| stops, it will run gc.
        let lastSrc0 = new ConstantSourceNode(context);
        lastSrc0.connect(gain);

        // When |lastSrc1| stops, we'll verify that the number of handlers left
        // is correct.
        let lastSrc1 = new ConstantSourceNode(context);
        lastSrc1.connect(gain);

        gc();
        let initialCount = internals.audioHandlerCount();

        // Create a bunch of sources for testing.  Since we call stop(), these
        // should all get collected, even though they're no longer connected to
        // the destination.
        for (let k = 0; k < 1000; ++k) {
          let src = new ConstantSourceNode(context);
          src.start();
          src.connect(gain);
          src.stop();
          src.disconnect();
        }

        // Start source and stop it after 0.5 sec so give some time for the
        // above sources time to stop.
        lastSrc0.start();
        lastSrc0.stop(context.currentTime + 0.5);
        lastSrc0.onended = () => {
          should(() => gc(), 'GC').notThrow();
        };

        // Start source and stop it after 0.75 sec so give some time for the
        // above sourcess time to stop, and for lastSrc0 to trigger gc,
        // allowing 0.25 sec for gc to finish.
        lastSrc1.start();
        lastSrc1.stop(context.currentTime + 0.75);
        lastSrc1.onended = () => {
          // All the disconnected oscillators should have been collected by now.
          should(internals.audioHandlerCount(), 'Number of handlers after GC')
              .beEqualTo(initialCount);
          task.done();
        };

        should(internals.audioHandlerCount(), 'Audio handlers still alive')
            .beGreaterThan(initialCount);
      });

      audit.run();
    </script>
  </body>
</html>
