#!/bin/sh

# Copyright 2018 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Simple script used to regenerate zip files used for unit-testing the
# crazy linker zip parser. This outputs a fragment of C code through 'xdd'
# on Linux that can be copied into crazy_linker_zip_unittest.cpp directly.

set -e

PROGNAME=$(basename "$0")

die () {
  echo "ERROR: $@"
  exit 1
}

TMP_DIR=/tmp/zip-files-tmp-$$
OUTPUT_DIR=/tmp/zip-files

# Preparing temporary directory.
mkdir -p $TMP_DIR
rm -rf $TMP_DIR/*
cd $TMP_DIR

printf "// START OF AUTO-GENERATED SECTION - DO NOT EDIT\n"
printf "// This section was generated by $PROGNAME\n\n"

printf "// An empty zip archive\n"
touch empty_file
zip -q empty_archive empty_file
zip -q -d empty_archive empty_file 2>/dev/null
xxd -i empty_archive.zip
printf "\n"

printf "// A zip archive with a single file named 'hello_world.txt' that\n"
printf "// contains the bytes for 'Hello World Hello World\\\n' without\n"
printf "// compression.\n"
echo "Hello World Hello World" > hello_world.txt
zip -q -0 hello.zip hello_world.txt
xxd -i hello.zip
printf "\n"

printf "// The same zip archive, but with the file stored compressed.\n"
zip -q -9 hello_compressed.zip hello_world.txt
xxd -i hello_compressed.zip
printf "\n"

printf "// END OF AUTO-GENERATED SECTION\n\n"

rm -rf $TMP_DIR
