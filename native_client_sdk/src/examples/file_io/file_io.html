<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!--
  Copyright (c) 2012 The Chromium Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
  -->
<head>
  <title>File I/O Example</title>

  <script type="text/javascript">
    FileIoModule = null;  // Global application object.
    statusText = 'NO-STATUS';

    // Request file system space and indicate successful load
    function moduleDidLoad() {
      FileIoModule = document.getElementById('file_io');
    }

    function createNaClModule() {
      // Dynamically generate this HTML:
      // <embed name="nacl_module"
      // id="file_io"
      // width=0 height=0
      // src="file_io.nmf"
      // type="application/x-nacl" />
      var listenerDiv = document.getElementById('listener');
      var naclModule = document.createElement('embed');
      naclModule.setAttribute('name', 'nacl_module');
      naclModule.setAttribute('id', 'file_io');
      naclModule.setAttribute('width', 0);
      naclModule.setAttribute('height', 0);
      naclModule.setAttribute('src', 'file_io.nmf');
      naclModule.setAttribute('type', 'application/x-nacl');
      listenerDiv.appendChild(naclModule);
    }

    // If the page loads before the Native Client module loads, then set the
    // status message indicating that the module is still loading.  Otherwise,
    // do not change the status message.
    function pageDidLoad() {
      // Request file system space
      updateStatus('Allocating storage...');
      window.webkitStorageInfo.requestQuota(window.PERSISTENT, 1024*1024,
          function(bytes) {
            updateStatus('Allocated '+bytes+' bytes of persistant storage.');
            createNaClModule();
          },
          function(e) { alert('Failed to allocate space') });
    }

    // Set the global status message.  If the element with id 'statusField'
    // exists, then set its HTML to the status message as well.
    // opt_message The message test.  If this is null or undefined, then
    // attempt to set the element with id 'statusField' to the value of
    // |statusText|.
    function updateStatus(opt_message) {
      if (opt_message)
        statusText = opt_message;
      var statusField = document.getElementById('status_field');
      if (statusField) {
        statusField.innerHTML = statusText;
        statusField.style.color = "black";
      }
    }

    function loadFile() {
      if (FileIoModule) {
        var fileName = document.getElementById('file_name').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name
        var msg = "ld " + fileName.length + " " + fileName;
        FileIoModule.postMessage(msg);
      }
    }

    function saveFile() {
      if (FileIoModule) {
        var fileName = document.getElementById('file_name').value;
        var fileText = document.getElementById('file_editor').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name file_contents
        var msg = "sv " + fileName.length + " " + fileName + " " + fileText;
        FileIoModule.postMessage(msg);
      }
    }

    function deleteFile() {
      if (FileIoModule) {
        var fileName = document.getElementById('file_name').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name
        var msg = "de " + fileName.length + " " + fileName;
        FileIoModule.postMessage(msg);
      }
    }

    function handleMessage(message_event) {
      var messageParts = message_event.data.split("|", 3);

      if (messageParts[0] == "ERR") {
        updateStatus(messageParts[1]);
        document.getElementById('status_field').style.color = "red";
      }
      else if(messageParts[0] == "STAT") {
        updateStatus(messageParts[1]);
      }
      else if (messageParts[0] == "DISP") {
        // Display the message in the file edit box
        document.getElementById('file_editor').value = messageParts[1];
      }
      else if (messageParts[0] == "READY") {
        var statusField = document.getElementById('status_field'); 
        updateStatus(statusField.innerHTML + ' Ready!');
      }
    }


  </script>
</head>
<body onload="pageDidLoad()">

<h1>File I/O example</h1>
This example demonstrates the use of the persistent file system
<p>
The window below allows creating and editing files in the file store.
<p>
  <!-- Load the published .nexe.  This includes the 'nacl' attribute which
  shows how to load multi-architecture modules.  Each entry in the "nexes"
  object in the .nmf manifest file is a key-value pair: the key is the
  instruction set architecture ('x86-32', 'x86-64', etc.); the value is a URL
  for the desired NaCl module.
  To load the debug versions of your .nexes, set the 'nacl' attribute to the
  _dbg.nmf version of the manifest file.

  Note: The <EMBED> element is wrapped inside a <DIV>, which has both a 'load'
    and a 'message' event listener attached.  This wrapping method is used
    instead of attaching the event listeners directly to the <EMBED> element
    to ensure that the listeners are active before the NaCl module 'load'
    event fires.
  -->
  <div id="listener">
    <script type="text/javascript">
      var listener = document.getElementById('listener');
      listener.addEventListener('load', moduleDidLoad, true);
      listener.addEventListener('message', handleMessage, true);
    </script>

    <textarea id="file_editor"
      cols="40"
      rows="10"
      wrap="hard"
      placeholder="Enter some text to save in a file..."></textarea>
    <br>File Name
    <input type="text" id="file_name" action=""/>
    <button id="save_but" onclick="saveFile()" action="">Save</button>
    <button id="load_but" onclick="loadFile()" action="">Load</button>
    <button id="delete_but" onclick="deleteFile()" action="">Delete</button>
  </div>
</p>



<h2>Status</h2>
<div id="status_field">NO-STATUS</div>
</body>
</html>
