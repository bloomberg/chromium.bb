# define a bunch of variables for readability

set_variable MODULE i(4444)
set_variable INSTANCE i(5555)
set_variable SHM_SIZE 65536
set_variable BUF_SIZE 16384
set_variable NUM_FRAMES 4096

echo
echo "*** INIT MODULE"
replay 1 PPB_GetInterface:s:i  s("PPB_Core;0.3") * i(1)
# the results contain a process id which is non-determinisitic
rpc PPP_InitializeModule hide-results i(0) ${MODULE} h(pepper_desc) s("${service_string}") * i(0) i(0)

echo
echo "*** INIT INSTANCE"
set_variable TAGS C(23,id\000name\000src\000style\000type\000)
set_variable VALUES C(74,naclModule\000naclModule\000ppapi.nexe\000background-color:gray\000application/x-nacl\000)
replay 1 PPB_GetInterface:s:i s("PPB_AudioConfig;0.5") * i(1)
replay 1 PPB_AudioConfig_RecommendSampleFrameCount:ii:i i(44100) i(${NUM_FRAMES}) * i(${NUM_FRAMES})
replay 1 PPB_AudioConfig_CreateStereo16Bit:iii:i ${INSTANCE} i(44100) i(${NUM_FRAMES}) * i(30)
replay 3 PPB_Core_AddRefResource:i: i(30) *
replay 3 PPB_Core_ReleaseResource:i: i(30) *
replay 1 PPB_GetInterface:s:i s("PPB_Audio;0.5") * i(1)
replay 1 PPB_Audio_Create:ii:i ${INSTANCE} i(30) * i(34)
replay 1 PPB_Audio_IsAudio:i:i i(34) * i(1)

replay 1 PPB_AudioConfig_IsAudioConfig:i:i i(30) * i(1)
replay 1 PPB_AudioConfig_GetSampleRate:i:i  i(30) * i(44100)
replay 1 PPB_AudioConfig_GetSampleFrameCount:i:i  i(30) * i(${NUM_FRAMES})
replay 1 PPB_Audio_StartPlayback:i:i i(34) * i(1)
replay 1 PPB_Core_CallOnMainThread:iii: i(10000) i(1) i(0) *
rpc PPP_Instance_DidCreate ${INSTANCE} i(5) ${TAGS} ${VALUES} * i(0)

echo
echo "*** TRIGGER REPAINT"
rpc PPP_Instance_DidChangeView ${INSTANCE} I(4,8,79,400,400) I(4,0,0,400,400) *

echo
echo "*** SETTING UP AUDIO SHARED MEMORY"
shmem audio_handle audio_address ${SHM_SIZE}
memset ${audio_address} 0  ${SHM_SIZE} 0
checksum ${audio_address} 0 ${SHM_SIZE}

echo
echo "*** SETTING UP AUDIO SYNC SOCKET"
sync_socket_create sync_in sync_out

echo
echo "*** AUDIO STREAM"
rpc PPP_Audio_StreamCreated i(34) h(audio_handle) i(${BUF_SIZE}) h(sync_out) *

echo
echo "*** AUDIO STREAM SYNC"
# By writing a byte into the sync sock we wake up the other side, the actual
# value does not matter as long as it is not -1.
# once the other side has woken up it is supposed to write into the buffer
# associated with audio_handle as quickly as possible.
# We wait 1sec to give it time to do that.
# Note: the shmem area is actually bigger then the buffer.
# We compute a checksum over the part that is used and that isn't.
# The latter checksum should not change
sync_socket_write sync_in 0
sleep 1
checksum ${audio_address} 0 ${BUF_SIZE}
checksum ${audio_address} ${BUF_SIZE} 49152

echo
echo "*** AUDIO STREAM SYNC"
sync_socket_write sync_in 1
sleep 1
checksum ${audio_address} 0 ${BUF_SIZE}
checksum ${audio_address} ${BUF_SIZE} 49152

echo
echo "*** AUDIO STREAM SYNC"
sync_socket_write sync_in 2
sleep 1
checksum ${audio_address} 0 ${BUF_SIZE}
checksum ${audio_address} ${BUF_SIZE} 49152

echo
echo "*** AUDIO STREAM SYNC"
sync_socket_write sync_in 3
sleep 1
checksum ${audio_address} 0 ${BUF_SIZE}
checksum ${audio_address} ${BUF_SIZE} 49152

echo
echo "*** TERMINATE AUDIO STREAM"
sync_socket_write sync_in -1
checksum ${audio_address} 0 ${BUF_SIZE}
checksum ${audio_address} ${BUF_SIZE} 49152

sleep 1
rpc PPP_ShutdownModule *
