<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<!--
  Copyright 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->
<head>
  <title>PPAPI Runtime Feature Test</title>
  <meta HTTP-EQUIV="Pragma" CONTENT="no-cache" />
  <meta HTTP-EQUIV="Expires" CONTENT="-1" />
  <script type="text/javascript" src="nacltest.js"></script>
  <script type="text/javascript" src="dynamic_library_helper.js"></script>
</head>

<body id="body">

<script type="text/javascript">
//<![CDATA[
var rpc = new RPCWrapper();
rpc.startup();

var log = function(message) {
  rpc.log('test', message);
};

// This is based on the test in ppapi_core.html.
// Deliberately global - this what the nexe expects.
var CallOnMainThreadCallback_FromMainThread = function() {
  log('Received CallOnMainThread callback!');
  rpc.pass('test');
  rpc.shutdown();
};

function $(id) {
  return document.getElementById(id);
}

var onWindowLoad = function() {
  log('in onWindowLoad()');
  var plugin = $('naclDSOModule');
  var nexe_names = {
    'x86-32': './ppapi_core_x86-32.nexe',
    'x86-64': './ppapi_core_x86-64.nexe',
    'arm': './ppapi_core_arm.nexe',
  };
  var lib_names = {
    'x86-32': 'lib',
    'x86-64': 'lib',
    'arm': 'lib',
  };
  var onPluginStart = function() {
    log('started OK');
    var value = plugin.testCallOnMainThread_FromMainThread();
    if (value !== true) {
      rpc.fail('test', 'Unexpected value: ' + value);
    }
  };

  // TODO(bradchen): Rewrite this test.
  // This entire test will be rewritten when the new nexe loading
  // support is available. In the mean time we wait.
  var sleepTime = 500; // in milliseconds for setTimeout
  var maxTries = 100;  // give up after 100 tries == 50 seconds
  var whenPluginReady = function () {
    log('in whenPluginReady');
    if (maxTries == 0) {
      rpc.client_error("Plugin did not load.");
      return;
    }
    maxTries = maxTries - 1;
    try {
      // If the plugin is not ready, the call to __getSandboxISA will
      // raise an exception, triggering another call after a brief nap.
      var isa = plugin.__getSandboxISA();
      startPluginInstance(plugin, lib_names, log, nexe_names, onPluginStart);
    } catch (err) {
      setTimeout(whenPluginReady, sleepTime);
    }
  }
  whenPluginReady();
};

window.onload = onWindowLoad
//]]>
</script>

<embed id="naclDSOModule"
       name="naclDSOModule"
       type="application/x-nacl"
       width=0 height=0 />

</body>
</html>
