<!DOCTYPE html>
<script src="/resources/testharness.js"></script>
<script src="/speculation-rules/prerender/resources/utils.js"></script>
<script>
const params = new URLSearchParams(location.search);
const uid = params.get('uid');

async function startPostMessage() {
  assert_true(document.prerendering);
  assert_not_equals(navigator.serviceWorker.controller, null,
                    'prerendered page should be controlled');

  const messagePromise =
      new Promise(resolve => navigator.serviceWorker.onmessage = resolve);
  navigator.serviceWorker.controller.postMessage('postmessage to worker');
  const result = await messagePromise;

  const bc = new PrerenderChannel('prerender-channel', uid);
  bc.postMessage(result.data);
  bc.close();
}

startPostMessage();
</script>
