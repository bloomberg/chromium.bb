<!DOCTYPE html>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<video id="target"
       onloadeddata="loaded()" src="/media/test.ogv"></video>
<script>

assert_true(document.prerendering);

async function requestPictureInPicture() {
  const bc = new BroadcastChannel('prerender-channel');

  try {
    document.pictureInPictureEnabled = true;
    await target.requestPictureInPicture();
    bc.postMessage('unexpected success');
  } catch (err) {
    if (err.name == 'NotAllowedError')
      bc.postMessage('request failed for a user gesture');
    else
      bc.postMessage(err.message);
  } finally {
    bc.close();
  }
}

function loaded() {
  requestPictureInPicture();
}
</script>
