<!DOCTYPE html>
<script src="utils.js"></script>
<a id="target" download="download-link" href="cache.txt">here</a>
<script>

const params = new URLSearchParams(location.search);

// The main test page (restriction-download.html) loads the initiator page,
// then the initiator page will prerender itself with the `prerendering`
// parameter.
const isPrerenderingTarget = params.has('prerendering');

if (!isPrerenderingTarget) {
  loadInitiatorPage();
} else {
  window.addEventListener('load', () => {
    if (document.prerendering) {
      // If prerendering, tell the initiator that this page finished
      // loading, so it can attempt activation.

      // Used to communicate with the initiator page.
      const prerenderChannel = new BroadcastChannel('prerender-channel');

      document.getElementById('target').click();

      // Inform the initiator page that this page was loaded.
      prerenderChannel.postMessage('readyToActivate');
      prerenderChannel.close();
    } else {
      // If not prerendering, and `load` was fired with the `prerendering`
      // parameter, we know this page was not prerendered and it was loaded by
      // a new navigation. This means the prerender was cancelled.

      // Used to communicate with the main test page.
      const testChannel = new BroadcastChannel('test-channel');
      testChannel.postMessage('prerendering is canceled');
      testChannel.close();
    }
  });

  document.addEventListener('prerenderingchange', () => {
    // Used to communicate with the main test page.
    const testChannel = new BroadcastChannel('test-channel');
    testChannel.postMessage('unexpectedly activated');
    testChannel.close();
  });
}

</script>
