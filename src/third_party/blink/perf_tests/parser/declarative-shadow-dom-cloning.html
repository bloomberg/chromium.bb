<!DOCTYPE html>
<html>
<body>
<script src="../resources/runner.js"></script>
<script>

const hostChildren = 100;

function createDeepShadowTemplateContent(levels, slotted) {
  const nestedContent = levels > 0 ? createDeepShadowTemplateContent(levels-1) : '<span>End</span>';
  if (slotted) {
    return `<div><template shadowroot=open><slot></slot></template>${nestedContent}</div>`;
  } else {
    return `<div><template shadowroot=open>${nestedContent}</template></div>`;
  }
}

// Build templates once
const templateSlotted = document.createElement('template');
document.body.appendChild(templateSlotted);
templateSlotted.content.allowDeclarativeShadowDom = true;
templateSlotted.innerHTML = createDeepShadowTemplateContent(hostChildren, true);

const templateNested = document.createElement('template');
document.body.appendChild(templateNested);
templateNested.content.allowDeclarativeShadowDom = true;
templateNested.innerHTML = createDeepShadowTemplateContent(hostChildren, false);

if (!templateSlotted.content.firstChild.shadowRoot) {
  PerfTestRunner.logFatalError("Declarative Shadow DOM must be enabled for this test.");
}

PerfTestRunner.measureRunsPerSecond({
    description: "This benchmark tests cloning of templates containing declarative Shadow DOM",

    setup: function() {
        const wrapper = document.createElement('div');
        wrapper.id = 'wrapper';
        document.body.appendChild(wrapper);
    },

    run: function() {
        const wrapper = document.querySelector('#wrapper');
        for (var i = 0; i < 100; i++) {
            wrapper.appendChild(templateSlotted.content.cloneNode(true));
            wrapper.appendChild(templateNested.content.cloneNode(true));
        }
    },

    teardown: function() {
        wrapper.remove();
    }});

</script>
</body>
</html>