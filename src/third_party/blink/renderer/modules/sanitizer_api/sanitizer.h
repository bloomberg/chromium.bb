// Copyright 2020 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#ifndef THIRD_PARTY_BLINK_RENDERER_MODULES_SANITIZER_API_SANITIZER_H_
#define THIRD_PARTY_BLINK_RENDERER_MODULES_SANITIZER_API_SANITIZER_H_

#include "third_party/blink/renderer/core/dom/node.h"
#include "third_party/blink/renderer/modules/modules_export.h"
#include "third_party/blink/renderer/platform/bindings/script_wrappable.h"
#include "third_party/blink/renderer/platform/wtf/text/wtf_string.h"

namespace blink {

class Document;
class DocumentFragment;
class ExceptionState;
class ExecutionContext;
class SanitizerConfig;
class ScriptState;
class StringOrDocumentFragmentOrDocument;
class StringOrTrustedHTMLOrDocumentFragmentOrDocument;

enum ElementKind {
  kCustom,
  kUnknown,
  kRegular,
};

class MODULES_EXPORT Sanitizer final : public ScriptWrappable {
  DEFINE_WRAPPERTYPEINFO();

 public:
  static Sanitizer* Create(ExecutionContext*,
                           const SanitizerConfig*,
                           ExceptionState&);
  explicit Sanitizer(ExecutionContext*, const SanitizerConfig*);
  ~Sanitizer() override;

  String sanitizeToString(ScriptState*,
                          StringOrDocumentFragmentOrDocument&,
                          ExceptionState&);
  DocumentFragment* sanitize(ScriptState*,
                             StringOrTrustedHTMLOrDocumentFragmentOrDocument&,
                             ExceptionState&);

  void Trace(Visitor*) const override;

 private:
  Node* DropElement(Node*, DocumentFragment*);
  Node* BlockElement(Node*, DocumentFragment*, ExceptionState&);
  Node* KeepElement(Node*, DocumentFragment*, String&, LocalDOMWindow*);

  void ElementFormatter(HashSet<String>&, const Vector<String>&);
  void AttrFormatter(HashMap<String, Vector<String>>&,
                     const Vector<std::pair<String, Vector<String>>>&);

  DocumentFragment* PrepareFragment(LocalDOMWindow*,
                                    ScriptState*,
                                    StringOrDocumentFragmentOrDocument&,
                                    ExceptionState&);
  DocumentFragment* DoSanitizing(DocumentFragment*,
                                 LocalDOMWindow*,
                                 ExceptionState&);
  DocumentFragment* SanitizeImpl(ScriptState*,
                                 StringOrDocumentFragmentOrDocument&,
                                 ExceptionState&);

  HashSet<String> allow_elements_ = {};
  HashSet<String> block_elements_ = {};
  HashSet<String> drop_elements_ = {};
  HashMap<String, Vector<String>> allow_attributes_ = {};
  HashMap<String, Vector<String>> drop_attributes_ = {};

  bool allow_custom_elements_ = false;

  // TODO(lyf): make it all-oilpan.
  const HashSet<String> baseline_drop_elements_ = {
      "APPLET",   "BASE",    "EMBED",    "IFRAME", "NOEMBED",
      "NOFRAMES", "NOLAYER", "NOSCRIPT", "OBJECT", "FRAME",
      "FRAMESET", "PARAM",   "SCRIPT"};
  const HashSet<String> default_allow_elements_ = {
      "A",          "ABBR",    "ACRONYM", "ADDRESS",  "AREA",     "ARTICLE",
      "ASIDE",      "AUDIO",   "B",       "BDI",      "BDO",      "BIG",
      "BLOCKQUOTE", "BODY",    "BR",      "BUTTON",   "CANVAS",   "CAPTION",
      "CENTER",     "CITE",    "CODE",    "COL",      "COLGROUP", "DATALIST",
      "DD",         "DEL",     "DETAILS", "DIALOG",   "DFN",      "DIR",
      "DIV",        "DL",      "DT",      "EM",       "FIELDSET", "FIGCAPTION",
      "FIGURE",     "FONT",    "FOOTER",  "FORM",     "H1",       "H2",
      "H3",         "H4",      "H5",      "H6",       "HEAD",     "HEADER",
      "HGROUP",     "HR",      "HTML",    "I",        "IMG",      "INPUT",
      "INS",        "KBD",     "KEYGEN",  "LABEL",    "LEGEND",   "LI",
      "LINK",       "LISTING", "MAP",     "MARK",     "MENU",     "META",
      "METER",      "NAV",     "NOBR",    "OL",       "OPTGROUP", "OPTION",
      "OUTPUT",     "P",       "PICTURE", "PRE",      "PROGRESS", "Q",
      "RB",         "RP",      "RT",      "RTC",      "RUBY",     "S",
      "SAMP",       "SECTION", "SELECT",  "SMALL",    "SOURCE",   "SPAN",
      "STRIKE",     "STRONG",  "SUB",     "SUMMARY",  "SUP",      "STYLE",
      "TABLE",      "TBODY",   "TD",      "TEXTAREA", "TFOOT",    "TH",
      "THEAD",      "TIME",    "TR",      "TRACK",    "TT",       "U",
      "UL",         "VAR",     "VIDEO",   "WBR"};
  const Vector<String> kVectorStar = Vector<String>({"*"});
  const HashMap<String, Vector<String>> baseline_drop_attributes_ = {
      {"onabort", kVectorStar},
      {"onafterprint", kVectorStar},
      {"onanimationstart", kVectorStar},
      {"onanimationiteration", kVectorStar},
      {"onanimationend", kVectorStar},
      {"onauxclick", kVectorStar},
      {"onbeforecopy", kVectorStar},
      {"onbeforecut", kVectorStar},
      {"onbeforepaste", kVectorStar},
      {"onbeforeprint", kVectorStar},
      {"onbeforeunload", kVectorStar},
      {"onblur", kVectorStar},
      {"oncancel", kVectorStar},
      {"oncanplay", kVectorStar},
      {"oncanplaythrough", kVectorStar},
      {"onchange", kVectorStar},
      {"onclick", kVectorStar},
      {"onclose", kVectorStar},
      {"oncontextmenu", kVectorStar},
      {"oncopy", kVectorStar},
      {"oncuechange", kVectorStar},
      {"oncut", kVectorStar},
      {"ondblclick", kVectorStar},
      {"ondrag", kVectorStar},
      {"ondragend", kVectorStar},
      {"ondragenter", kVectorStar},
      {"ondragleave", kVectorStar},
      {"ondragover", kVectorStar},
      {"ondragstart", kVectorStar},
      {"ondrop", kVectorStar},
      {"ondurationchange", kVectorStar},
      {"onemptied", kVectorStar},
      {"onended", kVectorStar},
      {"onerror", kVectorStar},
      {"onfocus", kVectorStar},
      {"onfocusin", kVectorStar},
      {"onfocusout", kVectorStar},
      {"onformdata", kVectorStar},
      {"ongotpointercapture", kVectorStar},
      {"onhashchange", kVectorStar},
      {"oninput", kVectorStar},
      {"oninvalid", kVectorStar},
      {"onkeydown", kVectorStar},
      {"onkeypress", kVectorStar},
      {"onkeyup", kVectorStar},
      {"onlanguagechange", kVectorStar},
      {"onload", kVectorStar},
      {"onloadeddata", kVectorStar},
      {"onloadedmetadata", kVectorStar},
      {"onloadstart", kVectorStar},
      {"onlostpointercapture", kVectorStar},
      {"onmessage", kVectorStar},
      {"onmessageerror", kVectorStar},
      {"onmousedown", kVectorStar},
      {"onmouseenter", kVectorStar},
      {"onmouseleave", kVectorStar},
      {"onmousemove", kVectorStar},
      {"onmouseout", kVectorStar},
      {"onmouseover", kVectorStar},
      {"onmouseup", kVectorStar},
      {"onmousewheel", kVectorStar},
      {"ononline", kVectorStar},
      {"onoffline", kVectorStar},
      {"onorientationchange", kVectorStar},
      {"onoverscroll", kVectorStar},
      {"onpagehide", kVectorStar},
      {"onpageshow", kVectorStar},
      {"onpaste", kVectorStar},
      {"onpause", kVectorStar},
      {"onplay", kVectorStar},
      {"onplaying", kVectorStar},
      {"onpointercancel", kVectorStar},
      {"onpointerdown", kVectorStar},
      {"onpointerenter", kVectorStar},
      {"onpointerleave", kVectorStar},
      {"onpointermove", kVectorStar},
      {"onpointerout", kVectorStar},
      {"onpointerover", kVectorStar},
      {"onpointerrawupdate", kVectorStar},
      {"onpointerup", kVectorStar},
      {"onpopstate", kVectorStar},
      {"onportalactivate", kVectorStar},
      {"onprogress", kVectorStar},
      {"onratechange", kVectorStar},
      {"onreset", kVectorStar},
      {"onresize", kVectorStar},
      {"onscroll", kVectorStar},
      {"onscrollend", kVectorStar},
      {"onsearch", kVectorStar},
      {"onseeked", kVectorStar},
      {"onseeking", kVectorStar},
      {"onselect", kVectorStar},
      {"onselectstart", kVectorStar},
      {"onselectionchange", kVectorStar},
      {"onshow", kVectorStar},
      {"onstalled", kVectorStar},
      {"onstorage", kVectorStar},
      {"onsuspend", kVectorStar},
      {"onsubmit", kVectorStar},
      {"ontimeupdate", kVectorStar},
      {"ontimezonechange", kVectorStar},
      {"ontoggle", kVectorStar},
      {"ontouchstart", kVectorStar},
      {"ontouchmove", kVectorStar},
      {"ontouchend", kVectorStar},
      {"ontouchcancel", kVectorStar},
      {"ontransitionend", kVectorStar},
      {"onunload", kVectorStar},
      {"onvolumechange", kVectorStar},
      {"onwaiting", kVectorStar},
      {"onwebkitanimationstart", kVectorStar},
      {"onwebkitanimationiteration", kVectorStar},
      {"onwebkitanimationend", kVectorStar},
      {"onwebkitfullscreenchange", kVectorStar},
      {"onwebkitfullscreenerror", kVectorStar},
      {"onwebkittransitionend", kVectorStar},
      {"onwheel", kVectorStar},

      // SVG events: Un-specced. This is temporarily here until the spec has
      // a full solution to SVG.
      {"onbegin", kVectorStar},
      {"onend", kVectorStar},
      {"onrepeat", kVectorStar},
      {"onabort", kVectorStar},
      {"onerror", kVectorStar},
      {"onresize", kVectorStar},
      {"onscroll", kVectorStar},
      {"onunload", kVectorStar},
      {"oncopy", kVectorStar},
      {"oncut", kVectorStar},
      {"onpaste", kVectorStar},
      {"oncancel", kVectorStar},
      {"oncanplay", kVectorStar},
      {"oncanplaythrough", kVectorStar},
      {"onchange", kVectorStar},
      {"onclick", kVectorStar},
      {"onclose", kVectorStar},
      {"oncuechange", kVectorStar},
      {"ondblclick", kVectorStar},
      {"ondrag", kVectorStar},
      {"ondragend", kVectorStar},
      {"ondragenter", kVectorStar},
      {"ondragexit", kVectorStar},
      {"ondragleave", kVectorStar},
      {"ondragover", kVectorStar},
      {"ondragstart", kVectorStar},
      {"ondrop", kVectorStar},
      {"ondurationchange", kVectorStar},
      {"onemptied", kVectorStar},
      {"onended", kVectorStar},
      {"onerror", kVectorStar},
      {"onfocus", kVectorStar},
      {"oninput", kVectorStar},
      {"oninvalid", kVectorStar},
      {"onkeydown", kVectorStar},
      {"onkeypress", kVectorStar},
      {"onkeyup", kVectorStar},
      {"onload", kVectorStar},
      {"onloadeddata", kVectorStar},
      {"onloadedmetadata", kVectorStar},
      {"onloadstart", kVectorStar},
      {"onmousedown", kVectorStar},
      {"onmouseenter", kVectorStar},
      {"onmouseleave", kVectorStar},
      {"onmousemove", kVectorStar},
      {"onmouseout", kVectorStar},
      {"onmouseover", kVectorStar},
      {"onmouseup", kVectorStar},
      {"onmousewheel", kVectorStar},
      {"onpause", kVectorStar},
      {"onplay", kVectorStar},
      {"onplaying", kVectorStar},
      {"onprogress", kVectorStar},
      {"onratechange", kVectorStar},
      {"onreset", kVectorStar},
      {"onresize", kVectorStar},
      {"onscroll", kVectorStar},
      {"onseeked", kVectorStar},
      {"onseeking", kVectorStar},
      {"onselect", kVectorStar},
      {"onshow", kVectorStar},
      {"onstalled", kVectorStar},
      {"onsubmit", kVectorStar},
      {"onsuspend", kVectorStar},
      {"ontimeupdate", kVectorStar},
      {"ontoggle", kVectorStar},
      {"onvolumechange", kVectorStar},
      {"onwaiting", kVectorStar},
      {"onactivate", kVectorStar},
      {"onfocusin", kVectorStar},
      {"onfocusout", kVectorStar},
  };
  const HashMap<String, Vector<String>> default_allow_attributes_ = {
      {"abbr", kVectorStar},
      {"accept", kVectorStar},
      {"accept-charset", kVectorStar},
      {"accesskey", kVectorStar},
      {"action", kVectorStar},
      {"align", kVectorStar},
      {"alink", kVectorStar},
      {"allow", kVectorStar},
      {"allowfullscreen", kVectorStar},
      {"alt", kVectorStar},
      {"anchor", kVectorStar},
      {"archive", kVectorStar},
      {"as", kVectorStar},
      {"async", kVectorStar},
      {"autocapitalize", kVectorStar},
      {"autocomplete", kVectorStar},
      {"autocorrect", kVectorStar},
      {"autofocus", kVectorStar},
      {"autopictureinpicture", kVectorStar},
      {"autoplay", kVectorStar},
      {"axis", kVectorStar},
      {"background", kVectorStar},
      {"behavior", kVectorStar},
      {"bgcolor", kVectorStar},
      {"border", kVectorStar},
      {"bordercolor", kVectorStar},
      {"capture", kVectorStar},
      {"cellpadding", kVectorStar},
      {"cellspacing", kVectorStar},
      {"challenge", kVectorStar},
      {"char", kVectorStar},
      {"charoff", kVectorStar},
      {"charset", kVectorStar},
      {"checked", kVectorStar},
      {"cite", kVectorStar},
      {"class", kVectorStar},
      {"classid", kVectorStar},
      {"clear", kVectorStar},
      {"code", kVectorStar},
      {"codebase", kVectorStar},
      {"codetype", kVectorStar},
      {"color", kVectorStar},
      {"cols", kVectorStar},
      {"colspan", kVectorStar},
      {"compact", kVectorStar},
      {"content", kVectorStar},
      {"contenteditable", kVectorStar},
      {"controls", kVectorStar},
      {"controlslist", kVectorStar},
      {"conversiondestination", kVectorStar},
      {"coords", kVectorStar},
      {"crossorigin", kVectorStar},
      {"csp", kVectorStar},
      {"data", kVectorStar},
      {"datetime", kVectorStar},
      {"declare", kVectorStar},
      {"decoding", kVectorStar},
      {"default", kVectorStar},
      {"defer", kVectorStar},
      {"dir", kVectorStar},
      {"direction", kVectorStar},
      {"dirname", kVectorStar},
      {"disabled", kVectorStar},
      {"disablepictureinpicture", kVectorStar},
      {"disableremoteplayback", kVectorStar},
      {"disallowdocumentaccess", kVectorStar},
      {"download", kVectorStar},
      {"draggable", kVectorStar},
      {"elementtiming", kVectorStar},
      {"enctype", kVectorStar},
      {"end", kVectorStar},
      {"enterkeyhint", kVectorStar},
      {"event", kVectorStar},
      {"exportparts", kVectorStar},
      {"face", kVectorStar},
      {"for", kVectorStar},
      {"form", kVectorStar},
      {"formaction", kVectorStar},
      {"formenctype", kVectorStar},
      {"formmethod", kVectorStar},
      {"formnovalidate", kVectorStar},
      {"formtarget", kVectorStar},
      {"frame", kVectorStar},
      {"frameborder", kVectorStar},
      {"headers", kVectorStar},
      {"height", kVectorStar},
      {"hidden", kVectorStar},
      {"high", kVectorStar},
      {"href", kVectorStar},
      {"hreflang", kVectorStar},
      {"hreftranslate", kVectorStar},
      {"hspace", kVectorStar},
      {"http-equiv", kVectorStar},
      {"id", kVectorStar},
      {"imagesizes", kVectorStar},
      {"imagesrcset", kVectorStar},
      {"importance", kVectorStar},
      {"impressiondata", kVectorStar},
      {"impressionexpiry", kVectorStar},
      {"incremental", kVectorStar},
      {"inert", kVectorStar},
      {"inputmode", kVectorStar},
      {"integrity", kVectorStar},
      {"invisible", kVectorStar},
      {"is", kVectorStar},
      {"ismap", kVectorStar},
      {"keytype", kVectorStar},
      {"kind", kVectorStar},
      {"label", kVectorStar},
      {"lang", kVectorStar},
      {"language", kVectorStar},
      {"latencyhint", kVectorStar},
      {"leftmargin", kVectorStar},
      {"link", kVectorStar},
      {"list", kVectorStar},
      {"loading", kVectorStar},
      {"longdesc", kVectorStar},
      {"loop", kVectorStar},
      {"low", kVectorStar},
      {"lowsrc", kVectorStar},
      {"manifest", kVectorStar},
      {"marginheight", kVectorStar},
      {"marginwidth", kVectorStar},
      {"max", kVectorStar},
      {"maxlength", kVectorStar},
      {"mayscript", kVectorStar},
      {"media", kVectorStar},
      {"method", kVectorStar},
      {"min", kVectorStar},
      {"minlength", kVectorStar},
      {"multiple", kVectorStar},
      {"muted", kVectorStar},
      {"name", kVectorStar},
      {"nohref", kVectorStar},
      {"nomodule", kVectorStar},
      {"nonce", kVectorStar},
      {"noresize", kVectorStar},
      {"noshade", kVectorStar},
      {"novalidate", kVectorStar},
      {"nowrap", kVectorStar},
      {"object", kVectorStar},
      {"open", kVectorStar},
      {"optimum", kVectorStar},
      {"part", kVectorStar},
      {"pattern", kVectorStar},
      {"ping", kVectorStar},
      {"placeholder", kVectorStar},
      {"playsinline", kVectorStar},
      {"policy", kVectorStar},
      {"poster", kVectorStar},
      {"preload", kVectorStar},
      {"pseudo", kVectorStar},
      {"readonly", kVectorStar},
      {"referrerpolicy", kVectorStar},
      {"rel", kVectorStar},
      {"reportingorigin", kVectorStar},
      {"required", kVectorStar},
      {"resources", kVectorStar},
      {"rev", kVectorStar},
      {"reversed", kVectorStar},
      {"role", kVectorStar},
      {"placeholder", kVectorStar},
      {"playsinline", kVectorStar},
      {"policy", kVectorStar},
      {"poster", kVectorStar},
      {"preload", kVectorStar},
      {"pseudo", kVectorStar},
      {"readonly", kVectorStar},
      {"referrerpolicy", kVectorStar},
      {"rel", kVectorStar},
      {"reportingorigin", kVectorStar},
      {"required", kVectorStar},
      {"resources", kVectorStar},
      {"rev", kVectorStar},
      {"reversed", kVectorStar},
      {"role", kVectorStar},
      {"rows", kVectorStar},
      {"rowspan", kVectorStar},
      {"rules", kVectorStar},
      {"sandbox", kVectorStar},
      {"scheme", kVectorStar},
      {"scope", kVectorStar},
      {"scopes", kVectorStar},
      {"scrollamount", kVectorStar},
      {"scrolldelay", kVectorStar},
      {"scrolling", kVectorStar},
      {"select", kVectorStar},
      {"selected", kVectorStar},
      {"shadowroot", kVectorStar},
      {"shadowrootdelegatesfocus", kVectorStar},
      {"shape", kVectorStar},
      {"size", kVectorStar},
      {"sizes", kVectorStar},
      {"slot", kVectorStar},
      {"span", kVectorStar},
      {"spellcheck", kVectorStar},
      {"src", kVectorStar},
      {"srcdoc", kVectorStar},
      {"srclang", kVectorStar},
      {"srcset", kVectorStar},
      {"standby", kVectorStar},
      {"start", kVectorStar},
      {"step", kVectorStar},
      {"style", kVectorStar},
      {"summary", kVectorStar},
      {"tabindex", kVectorStar},
      {"target", kVectorStar},
      {"text", kVectorStar},
      {"title", kVectorStar},
      {"topmargin", kVectorStar},
      {"translate", kVectorStar},
      {"truespeed", kVectorStar},
      {"trusttoken", kVectorStar},
      {"type", kVectorStar},
      {"usemap", kVectorStar},
      {"valign", kVectorStar},
      {"value", kVectorStar},
      {"valuetype", kVectorStar},
      {"version", kVectorStar},
      {"virtualkeyboardpolicy", kVectorStar},
      {"vlink", kVectorStar},
      {"vspace", kVectorStar},
      {"webkitdirectory", kVectorStar},
      {"width", kVectorStar},
      {"wrap", kVectorStar}};
};

}  // namespace blink

#endif  // THIRD_PARTY_BLINK_RENDERER_MODULES_SANITIZER_API_SANITIZER_H_
