From a9b15fae20d7d6950111568c5338d72ad7ec509d Mon Sep 17 00:00:00 2001
From: Joseph Chao <josephchao@google.com>
Date: Wed, 16 Mar 2022 18:33:19 +0000
Subject: [PATCH 3/3] Adding SamePackagePolicy

---
 .../PolicyScheduler.java                      |  2 ++
 .../policies/SamePackagePolicy.java           | 29 +++++++++++++++++++
 2 files changed, 31 insertions(+)
 create mode 100644 src/main/java/com/android/tools/r8/horizontalclassmerging/policies/SamePackagePolicy.java

diff --git a/src/main/java/com/android/tools/r8/horizontalclassmerging/PolicyScheduler.java b/src/main/java/com/android/tools/r8/horizontalclassmerging/PolicyScheduler.java
index 5e76e2dc6..b4821aa85 100644
--- a/src/main/java/com/android/tools/r8/horizontalclassmerging/PolicyScheduler.java
+++ b/src/main/java/com/android/tools/r8/horizontalclassmerging/PolicyScheduler.java
@@ -51,6 +51,7 @@ import com.android.tools.r8.horizontalclassmerging.policies.SameFeatureSplit;
 import com.android.tools.r8.horizontalclassmerging.policies.SameInstanceFields;
 import com.android.tools.r8.horizontalclassmerging.policies.SameMainDexGroup;
 import com.android.tools.r8.horizontalclassmerging.policies.SameNestHost;
+import com.android.tools.r8.horizontalclassmerging.policies.SamePackagePolicy;
 import com.android.tools.r8.horizontalclassmerging.policies.SameParentClass;
 import com.android.tools.r8.horizontalclassmerging.policies.SyntheticItemsPolicy;
 import com.android.tools.r8.horizontalclassmerging.policies.VerifyPolicyAlwaysSatisfied;
@@ -202,6 +203,7 @@ public class PolicyScheduler {
     ImmediateProgramSubtypingInfo immediateSubtypingInfo =
         ImmediateProgramSubtypingInfo.create(appView);
     builder.add(
+        new SamePackagePolicy(),
         new CheckAbstractClasses(appView),
         new NoClassAnnotationCollisions(),
         new SameFeatureSplit(appView),
diff --git a/src/main/java/com/android/tools/r8/horizontalclassmerging/policies/SamePackagePolicy.java b/src/main/java/com/android/tools/r8/horizontalclassmerging/policies/SamePackagePolicy.java
new file mode 100644
index 000000000..b05380e17
--- /dev/null
+++ b/src/main/java/com/android/tools/r8/horizontalclassmerging/policies/SamePackagePolicy.java
@@ -0,0 +1,29 @@
+// Copyright (c) 2022, the R8 project authors. Please see the AUTHORS file
+// for details. All rights reserved. Use of this source code is governed by a
+// BSD-style license that can be found in the LICENSE file.
+
+package com.android.tools.r8.horizontalclassmerging.policies;
+
+import com.android.tools.r8.graph.DexProgramClass;
+import com.android.tools.r8.horizontalclassmerging.MultiClassSameReferencePolicy;
+
+public class SamePackagePolicy extends MultiClassSameReferencePolicy<String> {
+
+  @Override
+  public String getMergeKey(DexProgramClass clazz) {
+    String packageName = clazz.getType().toDescriptorString().replaceAll("\\$.*", "");
+    if (isClassesInPackageEligibleForMerging(packageName)) {
+      return packageName;
+    }
+    return ineligibleForClassMerging();
+  }
+
+  private boolean isClassesInPackageEligibleForMerging(String packageName) {
+    return true;
+  }
+
+  @Override
+  public String getName() {
+    return "SamePackagePolicy";
+  }
+}
-- 
2.35.1.894.gb6a874cedc-goog

