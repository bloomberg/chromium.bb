# Copyright 2018 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

source_set("msgs") {
  sources = [
    target_gen_dir + "/osp_messages.cc",
    target_gen_dir + "/osp_messages.h",
  ]

  public_deps = [
    ":cddl_gen",
  ]
  deps = [
    "//third_party/abseil",
    "//third_party/tinycbor",
  ]
}

config("cddl_gen_config") {
  include_dirs = [ "$root_gen_dir" ]
}

action("cddl_gen") {
  script = "//tools/cddl/cddl.py"
  sources = [
    "osp_messages.cddl",
  ]
  outputs_src = rebase_path([
                              "osp_messages.h",
                              "osp_messages.cc",
                            ],
                            "//")
  outputs = []
  foreach(o, outputs_src) {
    outputs += [ root_gen_dir + "/" + o ]
  }
  public_configs = [ ":cddl_gen_config" ]

  args = [
           "--header",
           outputs_src[0],
           "--cc",
           outputs_src[1],
           "--gen-dir",
           rebase_path(root_gen_dir, root_build_dir),
         ] + rebase_path(sources, root_build_dir)

  deps = [
    "//tools/cddl",
  ]
}

source_set("unittests") {
  testonly = true

  sources = [
    "messages_unittest.cc",
  ]

  deps = [
    ":msgs",
    "//third_party/googletest:gtest",
  ]
}
