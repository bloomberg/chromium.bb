typeof GLGE=="undefined"&&(GLGE={}),function(a){function b(){var b=a.Vec([1,2,3,4]),c=a.Vec4(a.getVec4(b,3),a.get1basedVec4(b,3),a.getVec4(b,1),a.getVec4(b,0)),d=a.identMatrix(),e=a.mulMat4Vec4(d,c);if(a.getVec4(e,0)!=4||a.getVec4(e,1)!=3||a.getVec4(e,2)!=2||a.getVec4(e,3)!=1)throw"Unit Test 1 failed MatVecMul "+e;var f=a.Mat4([3,4,5,0,.5,.75,0,0,.75,.5,0,0,.25,.25,1,1]),g=a.Mat4([2,1,8,2,1,4,3,2,1,.5,6.5,2,8,3,1,.25]),h=a.mulMat4(f,g),i=a.Mat4([15,21.5,68.5,24,1.75,3.5,6.25,2.5,2,2.75,7.5,2.5,9.75,4.75,10.25,3.25]);for(var j=0;j<4;++j)for(var k=0;k<4;++k){var l=a.getMat4(h,j,k)-a.getMat4(i,j,k);if(l>=1e-6||l<=-1e-6)throw"Unit Test 1 failed Multiplication "+a.getMat4(h,j,k)+" != "+a.getMat4(i,j,k)}var m=a.inverseMat4(f),n=a.mulMat4(f,m),o=a.mulMat4(m,f);for(var j=0;j<4;++j)for(var k=0;k<4;++k){var l=a.getMat4(n,j,k)-a.getMat4(d,j,k);if(l>=1e-4||l<=-1e-4)throw"Unit Test 1 failed Inverse "+a.getMat4(n,j,k)+" != "+a.getMat4(d,j,k)}}a.Vec=function(a){return a.slice(0)},a.Vec3=function(a,b,c){return[a,b,c]},a.Vec4=function(a,b,c,d){return[a,b,c,d]},a.get1basedVec4=function(a,b){return a[b-1]},a.get1basedVec3=function(a,b){return a[b-1]},a.getVec4=function(a,b){return a[b]},a.getVec3=function(a,b){return a[b]},a.addVec4=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},a.addVec3=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},a.subVec4=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},a.subVec3=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},a.dotVec3=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.dotVec4=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},a.scaleVec4=function(a,b){return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},a.scaleVec3=function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},a.crossVec3=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},a.toUnitVec3=function(a){var b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],c=1;b>0&&(c=Math.pow(b,.5));return[a[0]/c,a[1]/c,a[2]/c]},a.toUnitVec4=function(a){var b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3],c=1;b>0&&(c=Math.pow(b,.5));return[a[0]/c,a[1]/c,a[2]/c,a[3]/c]},a.lengthVec3=function(a){return Math.pow(a[0]*a[0]+a[1]*a[1]+a[2]*a[2],.5)},a.distanceVec3=function(b,c){return a.lengthVec3(a.subVec3(b,c))},a.lengthVec4=function(a,b){return Math.pow(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3],.5)},a.distanceVec4=function(b,c){return a.lengthVec4(a.subVec4(b,c))},a.angleVec3=function(b,c){b=a.toUnitVec3(b),c=a.toUnitVec3(c),d=a.dotVec3(b,c),d<-1&&(d=-1),d>1&&(d=1);return Math.acos(d)},a.angleVec4=function(b,c){b=a.toUnitVec4(b),c=a.toUnitVec4(c),d=a.dotVec4(b,c),d<-1&&(d=-1),d>1&&(d=1);return Math.acos(d)},GLGE_math_use_webgl_float=!1,a.Mat3=GLGE_math_use_webgl_float?function(a){if(a.length==9)return new Float32Array(a);if(a.length==16)return new Float32Array([a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]);throw"invalid matrix length"}:function(a){var b;if(a.length==9)b=a.slice(0);else if(a.length==16)b=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];else throw"invalid matrix length";b.get=function(a){return this[a]};return b},a.Mat=GLGE_math_use_webgl_float?function(a){return new Float32Array(a)}:function(a){var b=a.slice(0);b.get=function(a){return this[a]};return b},a.Mat4=function(a){var b;if(a.length==9)b=[a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1];else if(a.length==16)b=a.slice(0);else throw"invalid matrix length";b.get=function(a){return this[a]};return b},a.determinantMat4=function(a){return a[12]*a[9]*a[6]*a[3]-a[8]*a[13]*a[6]*a[3]-a[12]*a[5]*a[10]*a[3]+a[4]*a[13]*a[10]*a[3]+a[8]*a[5]*a[14]*a[3]-a[4]*a[9]*a[14]*a[3]-a[12]*a[9]*a[2]*a[7]+a[8]*a[13]*a[2]*a[7]+a[12]*a[1]*a[10]*a[7]-a[0]*a[13]*a[10]*a[7]-a[8]*a[1]*a[14]*a[7]+a[0]*a[9]*a[14]*a[7]+a[12]*a[5]*a[2]*a[11]-a[4]*a[13]*a[2]*a[11]-a[12]*a[1]*a[6]*a[11]+a[0]*a[13]*a[6]*a[11]+a[4]*a[1]*a[14]*a[11]-a[0]*a[5]*a[14]*a[11]-a[8]*a[5]*a[2]*a[15]+a[4]*a[9]*a[2]*a[15]+a[8]*a[1]*a[6]*a[15]-a[0]*a[9]*a[6]*a[15]-a[4]*a[1]*a[10]*a[15]+a[0]*a[5]*a[10]*a[15]},a.inverseMat4=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q;return[(k*p*i-o*l*i+o*h*m-g*p*m-k*h*q+g*l*q)/r,(o*l*e-k*p*e-o*d*m+c*p*m+k*d*q-c*l*q)/r,(g*p*e-o*h*e+o*d*i-c*p*i-g*d*q+c*h*q)/r,(k*h*e-g*l*e-k*d*i+c*l*i+g*d*m-c*h*m)/r,(n*l*i-j*p*i-n*h*m+f*p*m+j*h*q-f*l*q)/r,(j*p*e-n*l*e+n*d*m-b*p*m-j*d*q+b*l*q)/r,(n*h*e-f*p*e-n*d*i+b*p*i+f*d*q-b*h*q)/r,(f*l*e-j*h*e+j*d*i-b*l*i-f*d*m+b*h*m)/r,(j*o*i-n*k*i+n*g*m-f*o*m-j*g*q+f*k*q)/r,(n*k*e-j*o*e-n*c*m+b*o*m+j*c*q-b*k*q)/r,(f*o*e-n*g*e+n*c*i-b*o*i-f*c*q+b*g*q)/r,(j*g*e-f*k*e-j*c*i+b*k*i+f*c*m-b*g*m)/r,(n*k*h-j*o*h-n*g*l+f*o*l+j*g*p-f*k*p)/r,(j*o*d-n*k*d+n*c*l-b*o*l-j*c*p+b*k*p)/r,(n*g*d-f*o*d-n*c*h+b*o*h+f*c*p-b*g*p)/r,(f*k*d-j*g*d+j*c*h-b*k*h-f*c*l+b*g*l)/r]},a.mulMat4Vec3=function(b,c){return a.Vec3(b[0]*c[0]+b[1]*c[1]+b[2]*c[2]+b[3],b[4]*c[0]+b[5]*c[1]+b[6]*c[2]+b[7],b[8]*c[0]+b[9]*c[1]+b[10]*c[2]+b[11])},a.mulMat4Vec4=function(b,c){return a.Vec4(b[0]*c[0]+b[1]*c[1]+b[2]*c[2]+b[3]*c[3],b[4]*c[0]+b[5]*c[1]+b[6]*c[2]+b[7]*c[3],b[8]*c[0]+b[9]*c[1]+b[10]*c[2]+b[11]*c[3],b[12]*c[0]+b[13]*c[1]+b[14]*c[2]+b[15]*c[3])},a.scaleMat4=function(b,c){return a.Mat([b[0]*c,b[1]*c,b[2]*c,b[3]*c,b[4]*c,b[5]*c,b[6]*c,b[7]*c,b[8]*c,b[9]*c,b[10]*c,b[11]*c,b[12]*c,b[13]*c,b[14]*c,b[15]*c])},a.scaleInPlaceMat4=function(a,b){a.set(0,a[0]*b),a.set(1,a[1]*b),a.set(2,a[2]*b),a.set(3,a[3]*b),a.set(4,a[4]*b),a.set(5,a[5]*b),a.set(6,a[6]*b),a.set(7,a[7]*b),a.set(8,a[8]*b),a.set(9,a[9]*b),a.set(10,a[10]*b),a.set(11,a[11]*b),a.set(12,a[12]*b),a.set(13,a[13]*b),a.set(14,a[14]*b),a.set(15,a[15]*b);return a},a.addInPlaceMat4=function(a,b){a.set(0,a[0]+b[0]),a.set(1,a[1]+b[1]),a.set(2,a[2]+b[2]),a.set(3,a[3]+b[3]),a.set(4,a[4]+b[4]),a.set(5,a[5]+b[5]),a.set(6,a[6]+b[6]),a.set(7,a[7]+b[7]),a.set(8,a[8]+b[8]),a.set(9,a[9]+b[9]),a.set(10,a[10]+b[10]),a.set(11,a[11]+b[11]),a.set(12,a[12]+b[12]),a.set(13,a[13]+b[13]),a.set(14,a[14]+b[14]),a.set(15,a[15]+b[15]);return a},a.addMat4=function(b,c){return a.Mat([b[0]+c[0],b[1]+c[1],b[2]+c[2],b[3]+c[3],b[4]+c[4],b[5]+c[5],b[6]+c[6],b[7]+c[7],b[8]+c[8],b[9]+c[9],b[10]+c[10],b[11]+c[11],b[12]+c[12],b[13]+c[13],b[14]+c[14],b[15]+c[15]])},a.subInPlaceMat4=function(a,b){a.set(0,a[0]-b[0]),a.set(1,a[1]-b[1]),a.set(2,a[2]-b[2]),a.set(3,a[3]-b[3]),a.set(4,a[4]-b[4]),a.set(5,a[5]-b[5]),a.set(6,a[6]-b[6]),a.set(7,a[7]-b[7]),a.set(8,a[8]-b[8]),a.set(9,a[9]-b[9]),a.set(10,a[10]-b[10]),a.set(11,a[11]-b[11]),a.set(12,a[12]-b[12]),a.set(13,a[13]-b[13]),a.set(14,a[14]-b[14]),a.set(15,a[15]-b[15]);return a},a.subMat4=function(b,c){return a.Mat([b[0]-c[0],b[1]-c[1],b[2]-c[2],b[3]-c[3],b[4]-c[4],b[5]-c[5],b[6]-c[6],b[7]-c[7],b[8]-c[8],b[9]-c[9],b[10]-c[10],b[11]-c[11],b[12]-c[12],b[13]-c[13],b[14]-c[14],b[15]-c[15]])},a.mulMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=a[0],t=a[1],u=a[2],v=a[3],w=a[4],x=a[5],y=a[6],z=a[7],A=a[8],B=a[9],C=a[10],D=a[11],E=a[12],F=a[13],G=a[14],H=a[15];return[s*c+t*g+u*k+v*o,s*d+t*h+u*l+v*p,s*e+t*i+u*m+v*q,s*f+t*j+u*n+v*r,w*c+x*g+y*k+z*o,w*d+x*h+y*l+z*p,w*e+x*i+y*m+z*q,w*f+x*j+y*n+z*r,A*c+B*g+C*k+D*o,A*d+B*h+C*l+D*p,A*e+B*i+C*m+D*q,A*f+B*j+C*n+D*r,E*c+F*g+G*k+H*o,E*d+F*h+G*l+H*p,E*e+F*i+G*m+H*q,E*f+F*j+G*n+H*r]},a.transposeInPlaceMat4=function(a){var b=a[1];a.set(1,a[4]),a.set(4,b),b=a[8],a.set(8,a[2]),a.set(2,b),b=a[3],a.set(3,a[12]),a.set(12,b),b=a[9],a.set(9,a[6]),a.set(6,b),b=a[13],a.set(13,a[7]),a.set(7,b),b=a[14],a.set(14,a[11]),a.set(11,b)},a.transposeMat4=function(b){return a.Mat4([b[0],b[4],b[8],b[12],b[1],b[5],b[9],b[13],b[2],b[6],b[10],b[14],b[3],b[7],b[11],b[15]])},a.mat4gl=function(a,b){b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]},a.set1basedMat4=function(a,b,c,d){a[(b-1)*4+(c-1)]=d,a.glData!==undefined&&delete a.glData},a.setMat4=function(a,b,c,d){a[b*4+c]=d,a.glData!==undefined&&delete a.glData},a.get1basedMat4=function(a,b,c){return a.get((b-1)*4+(c-1))},a.getMat4=function(a,b,c){return a[b*4+c]},a.glDataMat4=function(a){a.glArray=new Float32Array(a);return a.glArray},a.identMatrix=function(){return a.Mat([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},a.translateMatrix=function(b){var c,d,e;arguments.length==3?(c=arguments[0],d=arguments[1],e=arguments[2]):b.data?(c=b.data[0],d=b.data[1],e=b.data[2]):b instanceof Array&&(c=b[0],d=b[1],e=b[2]);return a.Mat([1,0,0,c,0,1,0,d,0,0,1,e,0,0,0,1])},a.scaleMatrix=function(b){var c,d,e;arguments.length==3?(c=arguments[0],d=arguments[1],e=arguments[2]):b.data?(c=b.data[0],d=b.data[1],e=b.data[2]):b instanceof Array&&(c=b[0],d=b[1],e=b[2]);return a.Mat([c,0,0,0,0,d,0,0,0,0,e,0,0,0,0,1])},a.ROT_XYZ=1,a.ROT_XZY=2,a.ROT_YXZ=3,a.ROT_YZX=4,a.ROT_ZXY=5,a.ROT_ZYX=6,a.rotateMatrix=function(b,c){var d,e,f;arguments.length>2?(d=arguments[0],e=arguments[1],f=arguments[2],c=arguments[3]):b.data?(d=b.data[0],e=b.data[1],f=b.data[2]):b instanceof Array&&(d=b[0],e=b[1],f=b[2]),c||(c=a.ROT_XYZ);var g=Math.cos(d),h=Math.sin(d),i=Math.cos(e),j=Math.sin(e),k=Math.cos(f),l=Math.sin(f),m=a.Mat([1,0,0,0,0,g,-h,0,0,h,g,0,0,0,0,1]),n=a.Mat([i,0,j,0,0,1,0,0,-j,0,i,0,0,0,0,1]),o=a.Mat([k,-l,0,0,l,k,0,0,0,0,1,0,0,0,0,1]);switch(c){case a.ROT_XYZ:return a.mulMat4(m,a.mulMat4(n,o));case a.ROT_XZY:return a.mulMat4(m,a.mulMat4(o,n));case a.ROT_YXZ:return a.mulMat4(n,a.mulMat4(m,o));case a.ROT_YZX:return a.mulMat4(n,a.mulMat4(o,m));case a.ROT_ZXY:return a.mulMat4(o,a.mulMat4(m,n));case a.ROT_ZYX:return a.mulMat4(o,a.mulMat4(n,m))}},a.angleAxis=function(b,c){var d,e,f,g,h,i,j,k,l;c=[c[0],c[1],c[2],0];var m=c[0],n=c[1],o=c[2],p=Math.cos(b),q=1-p,r=Math.sin(b);j=m*r,k=n*r,l=o*r,d=m*m,e=n*n,f=o*o,g=m*n,h=n*o,i=o*m;var s=[q*d+p,q*g-l,q*i+k,0,q*g+l,q*e+p,q*h-j,0,q*i-k,q*h+j,q*f+p,0,0,0,0,1];return a.Mat(s)},a.quatRotation=function(b,c,d,e){return a.Mat([1-2*c*c-2*d*d,2*b*c-2*d*e,2*b*d+2*c*e,0,2*b*c+2*d*e,1-2*b*b-2*d*d,2*c*d-2*b*e,0,2*b*d-2*c*e,2*c*d+2*b*e,1-2*b*b-2*c*c,0,0,0,0,1])},a.makeOrtho=function(b,c,d,e,f,g){var h=-(c+b)/(c-b),i=-(e+d)/(e-d),j=-(g+f)/(g-f);return a.Mat([2/(c-b),0,0,h,0,2/(e-d),0,i,0,0,-2/(g-f),j,0,0,0,1])},a.makeFrustum=function(b,c,d,e,f,g){var h=2*f/(c-b),i=2*f/(e-d),j=(c+b)/(c-b),k=(e+d)/(e-d),l=-(g+f)/(g-f),m=-2*g*f/(g-f);return a.Mat([h,0,j,0,0,i,k,0,0,0,l,m,0,0,-1,0])},a.makePerspective=function(b,c,d,e){var f=d*Math.tan(b*.00872664625972),g=-f,h=g*c,i=f*c;return a.makeFrustum(h,i,g,f,d,e)},a.matrix2Scale=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=Math.sqrt(b*b+c*c+d*d),l=Math.sqrt(e*e+f*f+g*g),m=Math.sqrt(h*h+i*i+j*j);return[k,l,m]},a.rotationMatrix2Quat=function(a){var b=a[0]+a[5]+a[10]+1,c,d,e,f,g;b>0?(c=.5/Math.sqrt(b),g=.25/c,d=(a[9]-a[6])*c,e=(a[2]-a[8])*c,f=(a[4]-a[1])*c):a[0]>a[5]&&a[0]>a[10]?(c=Math.sqrt(1+a[0]-a[5]-a[10])*2,g=(a[9]-a[6])/c,d=.25/c,e=(a[1]+a[4])/c,f=(a[2]+a[8])/c):a[5]>a[10]?(c=Math.sqrt(1+a[5]-a[0]-a[10])*2,g=(a[2]-a[8])/c,d=(a[1]+a[4])/c,e=.25/c,f=(a[6]+a[9])/c):(c=Math.sqrt(1+a[10]-a[0]-a[5])*2,g=(a[4]-a[1])/c,d=(a[2]+a[8])/c,e=(a[6]+a[9])/c,f=.25/c);var h=Math.sqrt(d*d+e*e+f*f+g*g);return[d/h,e/h,f/h,g/h]},a.rayToPlane=function(b,c){var d=a.toUnitVec3(c);return[d[0],d[1],d[2],a.dotVec3(b,d)]},a.rayIntersectPlane=function(b,c,d){var e=[d[0],d[1],d[2]],f=d[3],g=a.dotVec3(e,c);if(g<=0)return!1;var h=-(a.dotVec3(e,b)+f),i=h/g;if(i<=0)return!1;return a.addVec3(b,a.scaleVec3(c,i))},a.screenToDirection=function(b,c,d,e,f){xcoord=-(2*b/d-1)/f[0],ycoord=(2*c/e-1)/f[5],zcoord=1;return a.toUnitVec3([xcoord,ycoord,zcoord])},a.BoundingVolume=function(a,b,c,d,e,f){this.limits=[a,b,c,d,e,f],this.calcProps()},a.BoundingVolume.prototype.getCornerPoints=function(){return this.points},a.BoundingVolume.prototype.getSphereRadius=function(){return this.radius},a.BoundingVolume.prototype.getCenter=function(){return this.center},a.BoundingVolume.prototype.isNull=function(){return this.limits[0]==0&&this.limits[1]==0&&this.limits[2]==0&&this.limits[3]==0&&this.limits[4]==0&&this.limits[5]==0},a.BoundingVolume.prototype.addBoundingVolume=function(a){this.isNull()?(this.limits[0]=a.limits[0],this.limits[1]=a.limits[1],this.limits[2]=a.limits[2],this.limits[3]=a.limits[3],this.limits[4]=a.limits[4],this.limits[5]=a.limits[5]):a.isNull()||(this.limits[0]=Math.min(a.limits[0],this.limits[0]),this.limits[2]=Math.min(a.limits[2],this.limits[2]),this.limits[4]=Math.min(a.limits[4],this.limits[4]),this.limits[1]=Math.max(a.limits[1],this.limits[1]),this.limits[3]=Math.max(a.limits[3],this.limits[3]),this.limits[5]=Math.max(a.limits[5],this.limits[5])),this.calcProps()},a.BoundingVolume.prototype.applyMatrix=function(b){var c=a.mulMat4Vec4(b,[this.limits[0],this.limits[2],this.limits[4],1]),d=a.mulMat4Vec4(b,[this.limits[1],this.limits[2],this.limits[4],1]),e=a.mulMat4Vec4(b,[this.limits[0],this.limits[3],this.limits[4],1]),f=a.mulMat4Vec4(b,[this.limits[1],this.limits[3],this.limits[4],1]),g=a.mulMat4Vec4(b,[this.limits[0],this.limits[2],this.limits[5],1]),h=a.mulMat4Vec4(b,[this.limits[1],this.limits[2],this.limits[5],1]),i=a.mulMat4Vec4(b,[this.limits[0],this.limits[3],this.limits[5],1]),j=a.mulMat4Vec4(b,[this.limits[1],this.limits[3],this.limits[5],1]);this.limits[0]=Math.min(c[0],d[0],e[0],f[0],g[0],h[0],i[0],j[0]),this.limits[1]=Math.max(c[0],d[0],e[0],f[0],g[0],h[0],i[0],j[0]),this.limits[2]=Math.min(c[1],d[1],e[1],f[1],g[1],h[1],i[1],j[1]),this.limits[3]=Math.max(c[1],d[1],e[1],f[1],g[1],h[1],i[1],j[1]),this.limits[4]=Math.min(c[2],d[2],e[2],f[2],g[2],h[2],i[2],j[2]),this.limits[5]=Math.max(c[2],d[2],e[2],f[2],g[2],h[2],i[2],j[2]),this.calcProps()},a.BoundingVolume.prototype.calcProps=function(){var a=this.limits[0],b=this.limits[1],c=this.limits[2],d=this.limits[3],e=this.limits[4],f=this.limits[5];this.points=[[a,c,e],[b,c,e],[a,d,e],[b,d,e],[a,c,f],[b,c,f],[a,d,f],[b,d,f]],this.center=[(this.limits[1]-this.limits[0])/2+this.limits[0],(this.limits[3]-this.limits[2])/2+this.limits[2],(this.limits[5]-this.limits[4])/2+this.limits[4]];var g=this.limits[0]-this.center[0],h=this.limits[2]-this.center[1],i=this.limits[4]-this.center[2];this.radius=Math.sqrt(g*g+h*h+i*i)},a.BoundingVolume.prototype.clone=function(){return new a.BoundingVolume(this.limits[0],this.limits[1],this.limits[2],this.limits[3],this.limits[4],this.limits[5])},a.BoundingVolume.prototype.toString=function(){return this.limits.toString()},a.cameraViewProjectionToPlanes=function(b){var c=a.inverseMat4(b),d=a.mulMat4Vec4,e=a.subVec3,f=a.crossVec3,g=a.toUnitVec3,h=a.dotVec3,i=d(c,[-1,-1,-1,1]),j=d(c,[1,-1,-1,1]),k=d(c,[-1,-1,1,1]),l=d(c,[1,1,-1,1]),m=d(c,[1,1,1,1]),n=d(c,[-1,1,1,1]);i=[i[0]/i[3],i[1]/i[3],i[2]/i[3]],j=[j[0]/j[3],j[1]/j[3],j[2]/j[3]],k=[k[0]/k[3],k[1]/k[3],k[2]/k[3]],l=[l[0]/l[3],l[1]/l[3],l[2]/l[3]],m=[m[0]/m[3],m[1]/m[3],m[2]/m[3]],n=[n[0]/n[3],n[1]/n[3],n[2]/n[3]];var o=g(f(e(l,j),e(i,j))),p=g(f(e(n,k),e(m,k))),q=g(f(e(i,k),e(n,k))),r=g(f(e(m,l),e(l,j))),s=g(f(e(n,l),e(l,m))),t=g(f(e(i,j),e(k,i)));o.push(h(o,i)),p.push(h(p,k)),q.push(h(q,i)),r.push(h(r,j)),s.push(h(s,m)),t.push(h(t,i));return[o,p,q,r,s,t]},a.sphereInFrustumPlanes=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=b[4],l=b[5];return c*g[0]+d*g[1]+e*g[2]-g[3]-f>0||c*h[0]+d*h[1]+e*h[2]-h[3]-f>0||c*i[0]+d*i[1]+e*i[2]-i[3]-f>0||c*j[0]+d*j[1]+e*j[2]-j[3]-f>0||c*k[0]+d*k[1]+e*k[2]-k[3]-f>0||c*l[0]+d*l[1]+e*l[2]-l[3]-f>0?!1:!0},a.pointsInFrustumPlanes=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i,j,k;for(var l=0;l<a.length;l++){i=a[l][0],j=a[l][1],k=a[l][2];if(i*c[0]+j*c[1]+k*c[2]-c[3]>0&&i*d[0]+j*d[1]+k*d[2]-d[3]>0&&i*e[0]+j*e[1]+k*e[2]-f[3]>0&&i*f[0]+j*f[1]+k*f[2]-g[3]>0&&i*g[0]+j*g[1]+k*g[2]-g[3]>0&&i*h[0]+j*h[1]+k*h[2]-h[3]>0)return!1}return!0},b()}(GLGE),typeof GLGE=="undefined"&&(GLGE={}),function(a){var b=function(a){return typeof a!="number"?parseFloat(a):a};a.augment=function(a,b){for(proto in a.prototype)b.prototype[proto]=a.prototype[proto]},a.makeGlobal=function(){for(var b in a)window[b]=a[b]},a.New=function(b){return a[b].prototype.className!=""?new a[b]:!1},a.TRUE=1,a.FALSE=0,a.DRAW_TRIS=1,a.DRAW_LINES=2,a.DRAW_LINELOOPS=3,a.DRAW_LINESTRIPS=4,a.DRAW_POINTS=5,a.RENDER_DEFAULT=0,a.RENDER_SHADOW=1,a.RENDER_PICK=2,a.RENDER_NORMAL=3,a.RENDER_EMIT=4,a.RENDER_NULL=5,a.TEXT_BOXPICK=1,a.TEXT_TEXTPICK=1,a.P_EULER=1,a.P_QUAT=2,a.P_MATRIX=3,a.NONE=0,a.XAXIS=1,a.YAXIS=2,a.ZAXIS=3,a.POS_XAXIS=1,a.NEG_XAXIS=2,a.POS_YAXIS=3,a.NEG_YAXIS=4,a.POS_ZAXIS=5,a.NEG_ZAXIS=6,a.LINEAR_BLEND=function(a){return a},a.QUAD_BLEND=function(a){return a*a},a.SPECIAL_BLEND=function(a){a=a*(2-a);return a*a},a.error=function(a){console&&console.log&&console.log("GLGE error: "+a)},a.Assets={},a.Assets.assets={},a.REGISTER_ASSETS=!1,a.Assets.createUUID=function(){var a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],b=["8","9","A","B"];uuid="";for(var c=0;c<38;c++)switch(c){case 8:uuid=uuid+"-";break;case 13:uuid=uuid+"-";break;case 18:uuid=uuid+"-";break;case 14:uuid=uuid+"4";break;case 19:uuid=uuid+b[Math.round(Math.random()*3)];break;default:uuid=uuid+a[Math.round(Math.random()*15)]}return uuid},a.Assets.registerAsset=function(b,c){a.REGISTER_ASSETS&&(c||(c=a.Assets.createUUID()),b.uid=c,a.Assets.assets[c]=b)},a.Assets.unregisterAsset=function(b){delete a.Assets.assets[b]},a.Assets.get=function(b){var c=a.Assets.assets[b];return c?c:!1},a.fastHash=function(a){var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=a.length;a+="000000";while(n<o)h=a.charCodeAt(n++),i=a.charCodeAt(n++),j=a.charCodeAt(n++),k=a.charCodeAt(n++),l=a.charCodeAt(n++),m=a.charCodeAt(n++),b=(f+h+i)%255,c=(g+i+j)%255,d=(b+j+k)%255,e=(c+k+l)%255,f=(d+l+m)%255,g=(e+m+h)%255;var p=[String.fromCharCode(b),String.fromCharCode(c),String.fromCharCode(d),String.fromCharCode(e),String.fromCharCode(f),String.fromCharCode(g)];return p.join("")},a.getGLShader=function(b,c,d){var e=a.fastHash(d);b.shaderCache||(b.shaderCache={});if(!b.shaderCache[e]){var f=b.createShader(c);b.shaderSource(f,d),b.compileShader(f);if(!b.getShaderParameter(f,b.COMPILE_STATUS))try{a.error(b.getShaderInfoLog(f));return}catch(g){}b.shaderCache[e]=f}return b.shaderCache[e]};var c=0;a.getGLProgram=function(b,d,e){b.programCache||(b.programCache=[]);var f=b.programCache;for(var g=0;g<f.length;g++)if(f[g].fShader==e&&f[g].vShader==d)return f[g].program;var h=b.createProgram();h.progIdx=c++,b.attachShader(h,d),b.attachShader(h,e),b.linkProgram(h),b.getProgramParameter(h,b.LINK_STATUS)||a.error(b.getProgramInfoLog(h)),f.push({vShader:d,fShader:e,program:h});if(!h.uniformDetails){h.uniformDetails={};var i=b.getProgramParameter(h,b.ACTIVE_UNIFORMS);for(var g=0;g<i;++g){var j=b.getActiveUniform(h,g);h.uniformDetails[j.name]={loc:a.getUniformLocation(b,h,j.name),info:j}}}return h},a.getUniformLocation=function(a,b,c){b.uniformCache||(b.uniformCache={}),b.uniformChecked||(b.uniformChecked={}),b.uniformChecked[c]||(b.uniformCache[c]=a.getUniformLocation(b,c),b.uniformChecked[c]=!0);return b.uniformCache[c]},a.setUniform=function(a,b,c,d){typeof d=="string"&&(d=+d),c!=null&&a["uniform"+b](c,d)},a.setUniform3=function(a,b,c,d,e,f){typeof d=="string"&&(d=+d),typeof e=="string"&&(e=+e),typeof f=="string"&&(f=+f),c!=null&&a["uniform"+b](c,d,e,f)},a.setUniform4=function(a,b,c,d,e,f,g){c!=null&&a["uniform"+b](c,d,e,f,g)},a.setUniformMatrix=function(a,b,c,d,e){c!=null&&a["uniform"+b](c,d,e)},a.getAttribLocation=function(a,b,c){b.attribCache||(b.attribCache={}),b.attribCache[c]==undefined&&(b.attribCache[c]=a.getAttribLocation(b,c));return b.attribCache[c]},a.colorParse=function(a){var b,c,d,e,f={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};f[a]&&(a="#"+f[a]);if(a.substr&&a.substr(0,1)=="#")a=a.substr(1),a.length==8?(b=parseInt("0x"+a.substr(0,2))/255,c=parseInt("0x"+a.substr(2,2))/255,d=parseInt("0x"+a.substr(4,2))/255,e=parseInt("0x"+a.substr(6,2))/255):a.length==4?(b=parseInt("0x"+a.substr(0,1))/15,c=parseInt("0x"+a.substr(1,1))/15,d=parseInt("0x"+a.substr(2,1))/15,e=parseInt("0x"+a.substr(3,1))/15):a.length==6?(b=parseInt("0x"+a.substr(0,2))/255,c=parseInt("0x"+a.substr(2,2))/255,d=parseInt("0x"+a.substr(4,2))/255,e=1):a.length==3&&(b=parseInt("0x"+a.substr(0,1))/15,c=parseInt("0x"+a.substr(1,1))/15,d=parseInt("0x"+a.substr(2,1))/15,e=1);else if(a.substr&&a.substr(0,4)=="rgb("){var g=a.substr(4).split(",");b=parseInt(g[0])/255,c=parseInt(g[1])/255,d=parseInt(g[2])/255,e=1}else if(a.substr&&a.substr(0,5)=="rgba("){var g=a.substr(4).split(",");b=parseInt(g[0])/255,c=parseInt(g[1])/255,d=parseInt(g[2])/255,e=parseInt(g[3])/255}else b=0,c=0,d=0,e=0;return{r:b,g:c,b:d,a:e}}}(GLGE),function(a){a.Events=function(){},a.Events.prototype.fireEvent=function(a,b){if(this.events&&this.events[a]){var c=this.events[a];for(var d=0;d<c.length;d++)c[d].call(this,b)}},a.Events.prototype.addEventListener=function(a,b){this.events||(this.events={}),this.events[a]||(this.events[a]=[]),this.events[a].push(b)},a.Events.prototype.removeEventListener=function(a,b){var c=this.events[a].indexOf(b);c!=-1&&this.events[a].splice(c,1)}}(GLGE),function(a){a.QuickNotation=function(){},a.QuickNotation.prototype._=function(){var a;for(var b=0;b<arguments.length;b++){a=arguments[b];if(typeof a=="object")if(a.className&&this["add"+a.className])this["add"+a.className](a);else for(var c in a)this["set"+c]&&this["set"+c](a[c])}return this}}(GLGE),function(a){a.Animatable=function(){},a.augment(a.Events,a.Animatable),a.Animatable.prototype.animationStart=null,a.Animatable.prototype.animation=null,a.Animatable.prototype.blendStart=0,a.Animatable.prototype.blendTime=0,a.Animatable.prototype.lastFrame=null,a.Animatable.prototype.frameRate=30,a.Animatable.prototype.loop=a.TRUE,a.Animatable.prototype.paused=a.FALSE,a.Animatable.prototype.pausedTime=null,a.Animatable.prototype.blendFunction=a.LINEAR_BLEND,a.Animatable.prototype.blendTo=function(b,c,d){d||(d=a.LINEAR_BLEND);var e=new a.AnimationVector,f,g;for(prop in b)f=new a.AnimationCurve,f.setChannel(prop),g=new a.LinearPoint,g.setX(1),g.setY(b[prop]),f.addPoint(g),e.addAnimationCurve(f);this.setBlendFunction(d),this.setAnimation(e,c);return this},a.Animatable.prototype.setBlendFunction=function(a){this.blendFunction=a;return this},a.Animatable.prototype.getBlendFunction=function(){return this.blendFunction},a.Animatable.prototype.setName=function(a){this.name=a;return this},a.Animatable.prototype.getName=function(){return this.name},a.Animatable.prototype.getFrameNumber=function(a){this.startFrame||(this.startFrame=this.animation.startFrame),this.animFrames||(this.animFrames=this.animation.frames);var b;a||(a=parseInt((new Date).getTime())),this.animFrames>1?this.loop?b=(parseFloat(a)-parseFloat(this.animationStart))/1e3*this.frameRate%(this.animFrames-1)+1+this.startFrame:(b=(parseFloat(a)-parseFloat(this.animationStart))/1e3*this.frameRate+1+this.startFrame,b>=this.animFrames&&(b=this.animFrames)):b=1;return Math.round(b)},a.Animatable.prototype.setStartFrame=function(a,b,c){this.loop=c;var d=parseInt((new Date).getTime());b||(b=0),b>0&&(this.animation&&(this.blendInitValues=this.getInitialValues(this.animation,d),this.blendTime=b)),this.animationStart=d,this.lastFrame=null,this.animFinished=!1,this.startFrame=a;if(this.children)for(var e=0;e<this.children.length;e++)this.children[e].setStartFrame&&this.children[e].setStartFrame(a,b,c);return this},a.Animatable.prototype.setFrames=function(a){this.animFrames=a;if(this.children)for(var b=0;b<this.children.length;b++)this.children[b].setFrames&&this.children[b].setFrames(a);return this},a.Animatable.prototype.getInitialValues=function(a,b){var c={};this.animation&&(this.lastFrame=null,this.animate(b,!0));for(var d in a.curves)this["get"+d]&&(c[d]=this["get"+d]());return c},a.Animatable.prototype.animate=function(a,b){if(!this.paused&&this.animation){a||(a=parseInt((new Date).getTime()));var c=this.getFrameNumber(a);this.animation.animationCache||(this.animation.animationCache={});if(c!=this.lastFrame||this.blendTime!=0){this.lastFrame=c;if(this.blendTime==0)if(!this.animation.animationCache[c]||b){this.animation.animationCache[c]=[];if(this.animation.curves.LocX&&this.animation.curves.LocY&&this.animation.curves.LocZ&&this.animation.curves.ScaleX&&this.animation.curves.ScaleY&&this.animation.curves.ScaleZ&&this.animation.curves.QuatX&&this.animation.curves.QuatY&&this.animation.curves.QuatZ&&this.animation.curves.QuatW){for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));switch(property){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"LocX":case"LocY":case"LocZ":case"ScaleX":case"ScaleY":case"ScaleZ":break;default:this.animation.animationCache[c].push({property:property,value:d})}this["set"+property](d)}this.animation.animationCache[c].push({property:"StaticMatrix",value:this.getLocalMatrix()})}else{for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));switch(property){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"RotX":case"RotY":case"RotZ":var e=!0;break;default:this.animation.animationCache[c].push({property:property,value:d})}this["set"+property](d)}e&&(d=this.getRotMatrix(),this.animation.animationCache[c].push({property:"RotMatrix",value:d}))}}else{var f=this.animation.animationCache[c];for(var g=0;g<f.length;g++)this["set"+f[g].property]&&this["set"+f[g].property](f[g].value)}else{var h=a-this.animationStart;if(h<this.blendTime){var i=h/this.blendTime;i=this.blendFunction(i);for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));d=d*i+this.blendInitValues[property]*(1-i),this["set"+property](d)}}else this.blendTime=0}}}if(this.children)for(var g=0;g<this.children.length;g++)this.children[g].animate&&this.children[g].animate(a,b);this.animation&&!this.animFinished&&this.blendTime==0&&this.animation.frames==c&&!b&&(this.animFinished=!0,this.fireEvent("animFinished",{}))},a.Animatable.prototype.setAnimation=function(a,b,c){c==null&&(c=parseInt((new Date).getTime())),b||(b=0),b>0&&(this.blendInitValues=this.getInitialValues(a,c),this.blendTime=b),this.animFrames=null,this.startFrame=null,this.animationStart=c,this.lastFrame=null,this.animation=a,this.animFinished=!1;return this},a.Animatable.prototype.getAnimation=function(){return this.animation},a.Animatable.prototype.setFrameRate=function(a){this.frameRate=a;return this},a.Animatable.prototype.getFrameRate=function(){return this.frameRate},a.Animatable.prototype.setLoop=function(a){this.loop=a;return this},a.Animatable.prototype.getLoop=function(){return this.loop},a.Animatable.prototype.isLooping=a.Animatable.prototype.getLoop,a.Animatable.prototype.setPaused=function(a){a?this.pauseTime=parseInt((new Date).getTime()):this.animationStart=this.animationStart+(parseInt((new Date).getTime())-this.pauseTime),this.paused=a;return this},a.Animatable.prototype.getPaused=function(){return this.paused},a.Animatable.prototype.togglePaused=function(){this.setPaused(!this.getPaused());return this.paused}}(GLGE),function(a){a.Document=function(){this.listeners=[],this.documents=[]},a.Document.prototype.listeners=null,a.Document.prototype.documents=null,a.Document.prototype.rootURL=null,a.Document.prototype.loadCount=0,a.Document.prototype.version=0,a.Document.prototype.getElementById=function(a){var b=this.getElementsByTagName("*");for(var c=0;c<b.length;c++)if(b[c].getAttribute("id")==a)return b[c];return null},a.Document.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,8)=="https://")return a;b||(b=window.location.href);var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},a.Document.prototype.load=function(a){this.documents=[],this.rootURL=a,this.loadDocument(a,null)},a.Document.prototype.loadDocument=function(b,c){this.loadCount++,b=this.getAbsolutePath(b,c);var d=new XMLHttpRequest;d&&(d.docurl=b,d.docObj=this,d.overrideMimeType("text/xml"),d.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(this.responseXML.getElementById=this.docObj.getElementById,this.docObj.loaded(this.docurl,this.responseXML)):a.error("Error loading Document: "+this.docurl+" status "+this.status))},d.open("GET",b,!0),d.send(""))},a.Document.prototype.loaded=function(a,b){this.loadCount--,this.documents[a]={xml:b};var c=b.getElementsByTagName("glge");c[0]&&c[0].hasAttribute("version")&&(this.version=parseFloat(c[0].getAttribute("version")));var d=b.getElementsByTagName("import");for(var e=0;e<d.length;e++)this.documents[this.getAbsolutePath(d[e].getAttribute("url"),a)]||(this.documents[this.getAbsolutePath(d[e].getAttribute("url"),a)]={},this.loadDocument(d[e].getAttribute("url"),a));this.loadCount==0&&this.finishedLoading()},a.Document.prototype.finishedLoading=function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a](this.listeners.rootURL);this.onLoad()},a.Document.prototype.onLoad=function(){},a.Document.prototype.classString=function(a){if(!a)return!1;var b=a.split("_"),c="";for(var d=0;d<b.length;d++)c=c+b[d][0].toUpperCase()+b[d].substr(1);return c},a.Document.prototype.setProperties=function(b){var c,d,e;for(var f=0;f<b.attributes.length;f++)e=!1,c="set"+this.classString(b.attributes[f].nodeName),b.attributes[f].value[0]=="#"&&(e=this.getElement(b.attributes[f].value.substr(1),!0)),e||(typeof a[b.attributes[f].value]!="undefined"?e=a[b.attributes[f].value]:e=b.attributes[f].value),b.object[c]&&b.object[c](e),b.attributes[f].nodeName=="uid"&&(a.Assets.unregisterAsset(b.object.uid),b.object.uid=b.attributes[f].value,a.Assets.registerAsset(b.object,b.attributes[f].value))},a.Document.prototype.addChildren=function(a){var b,c=a.firstChild;while(c)b="add"+this.classString(c.tagName),a.object[b]&&a.object[b](this.getElement(c)),c=c.nextSibling},a.Document.prototype.getElement=function(b,c){var d,e;if(typeof b=="string")for(e in this.documents)if(this.documents[e].xml){d=this.documents[e].xml.getElementById(b);if(d){b=d;break}}if(typeof b=="string"){c||a.error("Element "+b+" not found in document");return!1}return this["get"+this.classString(b.tagName)]?this["get"+this.classString(b.tagName)](b):this.getDefault(b)},a.Document.prototype.getData=function(b){if(!b.object){b.object=this.parseArray(b);if(b.hasAttribute("type")){var c=b.getAttribute("type");switch(c){case"matrix":for(var d=0;d<b.object.length;d++)b.object[d]=a.Mat4(b.object[d].split(" "));break;case"links":for(var d=0;d<b.object.length;d++)b.object[d]=this.getElement(b.object[d].substr(1))}}}return b.object},a.Document.prototype.getDefault=function(b){b.object||(a[this.classString(b.tagName)]?(b.object=new(a[this.classString(b.tagName)]),this.setProperties(b),this.addChildren(b)):a.error("XML Parse Error: GLGE Object not found"));return b.object},a.Document.prototype.getTexture=function(b){if(!b.object){var c=this.getAbsolutePath(this.rootURL,null);b.object=new(a[this.classString(b.tagName)]),b.object.setSrc(this.getAbsolutePath(b.getAttribute("src"),c)),b.removeAttribute("src"),this.setProperties(b)}return b.object},a.Document.prototype.getTextureVideo=a.Document.prototype.getTexture,a.Document.prototype.parseArray=function(a){var b=a.firstChild,c="",d=[],e,f;while(b){e=(c+b.nodeValue).split(","),b=b.nextSibling,e[0]==""&&e.unshift(),b&&(c=e.pop());for(f=0;f<e.length;f++)d.push(e[f])}return d},a.Document.prototype.getMesh=function(b){if(this.version>0)return this.getDefault(b);if(!b.object){b.object=new a.Mesh,this.setProperties(b);var c=b.firstChild;while(c){switch(c.tagName){case"positions":b.object.setPositions(this.parseArray(c));break;case"normals":b.object.setNormals(this.parseArray(c));break;case"uv1":b.object.setUV(this.parseArray(c));break;case"uv2":b.object.setUV2(this.parseArray(c));break;case"faces":b.object.setFaces(this.parseArray(c));break;case"joint_names":var d=this.parseArray(c),e=[];for(var f=0;f<d.length;f++)d[f].substr(0,1)=="#"?e.push(this.getElement(d[f].substr(1))):e.push(d[f]);b.object.setJoints(e);break;case"bind_matrix":var g=this.parseArray(c),h=[];for(var f=0;f<g.length;f++)h.push(a.Mat4(g[f].split(" ")));b.object.setInvBindMatrix(h);break;case"joints":b.object.setVertexJoints(this.parseArray(c),c.getAttribute("count"));break;case"weights":b.object.setVertexWeights(this.parseArray(c),c.getAttribute("count"))}c=c.nextSibling}}return b.object},a.Document.prototype.addLoadListener=function(a){this.listeners.push(a)},a.Document.prototype.removeLoadListener=function(a){for(var b=0;b<this.listeners.length;b++)this.listeners[b]===a&&this.listeners.splice(b,1)},a.Document.prototype.parseScript=function(a){this.rootURL=window.location.toString();var b=document.getElementById(a);if(!b)return null;var c="",d=b.firstChild;while(d)d.nodeType==3&&(c+=d.textContent),d=d.nextSibling;var e=new DOMParser,f=e.parseFromString(c,"text/xml");f.getElementById=this.getElementById,this.documents["#"+a]={xml:f};var g=f.getElementsByTagName("import");for(var h=0;h<g.length;h++)this.documents[this.getAbsolutePath(g[h].getAttribute("url"),url)]||(this.documents[this.getAbsolutePath(g[h].getAttribute("url"),url)]={},this.loadDocument(g[h].getAttribute("url")));this.loadCount==0&&this.finishedLoading()}}(GLGE),function(a){a.Placeable=function(){},a.Placeable.prototype.locX=0,a.Placeable.prototype.locY=0,a.Placeable.prototype.locZ=0,a.Placeable.prototype.dLocX=0,a.Placeable.prototype.dLocY=0,a.Placeable.prototype.dLocZ=0,a.Placeable.prototype.quatX=0,a.Placeable.prototype.quatY=0,a.Placeable.prototype.quatZ=0,a.Placeable.prototype.quatW=0,a.Placeable.prototype.rotX=0,a.Placeable.prototype.rotY=0,a.Placeable.prototype.rotZ=0,a.Placeable.prototype.dRotX=0,a.Placeable.prototype.dRotY=0,a.Placeable.prototype.dRotZ=0,a.Placeable.prototype.scaleX=1,a.Placeable.prototype.scaleY=1,a.Placeable.prototype.scaleZ=1,a.Placeable.prototype.dScaleX=0,a.Placeable.prototype.dScaleY=0,a.Placeable.prototype.dScaleZ=0,a.Placeable.prototype.matrix=null,a.Placeable.prototype.rotOrder=a.ROT_XYZ,a.Placeable.prototype.lookAt=null,a.Placeable.prototype.mode=a.P_EULER,a.Placeable.prototype.getRoot=function(){if(this.type==a.G_ROOT)return this;if(this.parent){var b=this.parent.getRoot();return b?b:this}return this},a.Placeable.prototype.getRef=function(){return this.id?this.id:this.parent?this.parent.getRef():null},a.Placeable.prototype.setId=function(a){this.id=a;return this},a.Placeable.prototype.getId=function(){return this.id},a.Placeable.prototype.getLookat=function(){return this.lookAt},a.Placeable.prototype.setLookat=function(a){this.lookAt=a;return this},a.Placeable.prototype.Lookat=function(b){var c,d=this.getPosition();b.getPosition?c=b.getPosition():c={x:b[0],y:b[1],z:b[2]};var e=[d.x-c.x,d.y-c.y,d.z-c.z],f=a.toUnitVec3(e),g=a.toUnitVec3(a.crossVec3([0,0,1],f)),h=a.toUnitVec3(a.crossVec3(f,g));this.setRotMatrix(a.Mat4([g[0],h[0],f[0],0,g[1],h[1],f[1],0,g[2],h[2],f[2],0,0,0,0,1]))},a.Placeable.prototype.getRotOrder=function(){return this.rotOrder},a.Placeable.prototype.setRotOrder=function(a){this.rotOrder=a,this.matrix=null,this.rotmatrix=null;return this},a.Placeable.prototype.getRotMatrix=function(){if(!this.rotmatrix){var b=this.getRotation();this.mode==a.P_EULER&&(this.rotmatrix=a.rotateMatrix(b.x,b.y,b.z,this.rotOrder)),this.mode==a.P_QUAT&&(this.rotmatrix=a.quatRotation(b.x,b.y,b.z,b.w))}return this.rotmatrix},a.Placeable.prototype.setRotMatrix=function(b){this.mode=a.P_MATRIX,this.rotmatrix=b,this.updateMatrix();return this},a.Placeable.prototype.setLocX=function(a){this.locX=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setLocY=function(a){this.locY=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setLocZ=function(a){this.locZ=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setLoc=function(a,b,c){this.locX=a,this.locY=b,this.locZ=c,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDLocX=function(a){this.dLocX=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDLocY=function(a){this.dLocY=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDLocZ=function(a){this.dLocZ=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDLoc=function(a,b,c){this.dLocX=a,this.dLocY=b,this.dLocZ=c,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setQuatX=function(b){this.mode=a.P_QUAT,this.quatX=parseFloat(b),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setQuatY=function(b){this.mode=a.P_QUAT,this.quatY=parseFloat(b),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setQuatZ=function(b){this.mode=a.P_QUAT,this.quatZ=parseFloat(b),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setQuatW=function(b){this.mode=a.P_QUAT,this.quatW=parseFloat(b),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setQuat=function(b,c,d,e){this.mode=a.P_QUAT,this.quatX=b,this.quatY=c,this.quatZ=d,this.quatW=e,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setRotX=function(b){this.mode=a.P_EULER,this.rotX=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setRotY=function(b){this.mode=a.P_EULER,this.rotY=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setRotZ=function(b){this.mode=a.P_EULER,this.rotZ=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setRot=function(b,c,d){this.mode=a.P_EULER,this.rotX=b,this.rotY=c,this.rotZ=d,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDRotX=function(b){this.mode=a.P_EULER,this.dRotX=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDRotY=function(b){this.mode=a.P_EULER,this.dRotY=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDRotZ=function(b){this.mode=a.P_EULER,this.dRotZ=b,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDRot=function(b,c,d){this.mode=a.P_EULER,this.dRotX=b,this.dRotY=c,this.dRotZ=d,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setScaleX=function(a){if(this.ScaleX==a)return this;this.scaleX=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setScaleY=function(a){if(this.ScaleY==a)return this;this.scaleY=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setScaleZ=function(a){if(this.ScaleZ==a)return this;this.scaleZ=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setScale=function(a,b,c){b||(b=a,c=a),this.scaleX=a,this.scaleY=b,this.scaleZ=c,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDScaleX=function(a){if(this.dScaleX==a)return this;this.dScaleX=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDScaleY=function(a){if(this.dScaleY==a)return this;this.dScaleY=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDScaleZ=function(a){if(this.dScaleZ==a)return this;this.dScaleZ=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.setDScale=function(a,b,c){this.dScaleX=a,this.dScaleY=b,this.dScaleZ=c,this.staticMatrix==null,this.scaleMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.getLocX=function(){return this.locX},a.Placeable.prototype.getLocY=function(){return this.locY},a.Placeable.prototype.getLocZ=function(){return this.locZ},a.Placeable.prototype.getDLocX=function(){return this.dLocX},a.Placeable.prototype.getDLocY=function(){return this.dLocY},a.Placeable.prototype.getDLocZ=function(){return this.dLocZ},a.Placeable.prototype.getQuatX=function(){return this.quatX},a.Placeable.prototype.getQuatY=function(){return this.quatY},a.Placeable.prototype.getQuatZ=function(){return this.quatZ},a.Placeable.prototype.getQuatW=function(){return this.quatW},a.Placeable.prototype.getRotX=function(){return this.rotX},a.Placeable.prototype.getRotY=function(){return this.rotY},a.Placeable.prototype.getRotZ=function(){return this.rotZ},a.Placeable.prototype.getDRotX=function(){return this.dRotX},a.Placeable.prototype.getDRotY=function(){return this.dRotY},a.Placeable.prototype.getDRotZ=function(){return this.dRotZ},a.Placeable.prototype.getScaleX=function(){return this.scaleX},a.Placeable.prototype.getScaleY=function(){return this.scaleY},a.Placeable.prototype.getScaleZ=function(){return this.scaleZ},a.Placeable.prototype.getDScaleX=function(){return this.dScaleX},a.Placeable.prototype.getDScaleY=function(){return this.dScaleY},a.Placeable.prototype.getDScaleZ=function(){return this.dScaleZ},a.Placeable.prototype.getPosition=function(){var a={};a.x=parseFloat(this.locX)+parseFloat(this.dLocX),a.y=parseFloat(this.locY)+parseFloat(this.dLocY),a.z=parseFloat(this.locZ)+parseFloat(this.dLocZ);return a},a.Placeable.prototype.getRotation=function(){var b={};this.mode==a.P_EULER&&(b.x=parseFloat(this.rotX)+parseFloat(this.dRotX),b.y=parseFloat(this.rotY)+parseFloat(this.dRotY),b.z=parseFloat(this.rotZ)+parseFloat(this.dRotZ)),this.mode==a.P_QUAT&&(b.x=parseFloat(this.quatX),b.y=parseFloat(this.quatY),b.z=parseFloat(this.quatZ),b.w=parseFloat(this.quatW));return b},a.Placeable.prototype.getScale=function(){var a={};a.x=parseFloat(this.scaleX)+parseFloat(this.dScaleX),a.y=parseFloat(this.scaleY)+parseFloat(this.dScaleY),a.z=parseFloat(this.scaleZ)+parseFloat(this.dScaleZ);return a},a.Placeable.prototype.getScaleMatrix=function(){this.scaleMatrix||(this.scaleMatrix=a.scaleMatrix(parseFloat(this.scaleX)+parseFloat(this.dScaleX),parseFloat(this.scaleY)+parseFloat(this.dScaleY),parseFloat(this.scaleZ)+parseFloat(this.dScaleZ)));return this.scaleMatrix},a.Placeable.prototype.getTranslateMatrix=function(){this.translateMatrix||(this.translateMatrix=a.translateMatrix(parseFloat(this.locX)+parseFloat(this.dLocX),parseFloat(this.locY)+parseFloat(this.dLocY),parseFloat(this.locZ)+parseFloat(this.dLocZ)));return this.translateMatrix},a.Placeable.prototype.getLocalMatrix=function(){this.getModelMatrix();return this.localMatrix},a.Placeable.prototype.setStaticMatrix=function(a){this.staticMatrix=a,this.updateMatrix();return this},a.Placeable.prototype.clearStaticMatrix=function(){this.staticMatrix=null,this.updateMatrix();return this},a.Placeable.prototype.updateMatrix=function(){this.matrix=null;if(this.children)for(var a=0;a<this.children.length;a++)this.children[a].updateMatrix()},a.Placeable.prototype.getModelMatrix=function(){if(!this.matrix){this.invmatrix=null,this.transmatrix=null,this.transinvmatrix=null;if(this.staticMatrix){var b=this.staticMatrix;this.localMatrix=this.staticMatrix,this.parent&&(b=a.mulMat4(this.parent.getModelMatrix(),b)),this.matrix=b}else{var c=this.getTranslateMatrix(),d=this.getScaleMatrix(),b=a.mulMat4(c,a.mulMat4(this.getRotMatrix(),d));this.localMatrix=b,this.parent&&(b=a.mulMat4(this.parent.getModelMatrix(),b)),this.matrix=b}}return this.matrix},a.Placeable.prototype.getInverseModelMatrix=function(){this.matrix||this.getModelMatrix(),this.invmatrix||(this.invmatrix=a.transposeMat4(this.matrix));return this.invmatrix},a.Placeable.prototype.getTransposeModelMatrix=function(){this.matrix||this.getModelMatrix(),this.transmatrix||(this.transmatrix=a.transposeMat4(this.matrix));return this.transmatrix},a.Placeable.prototype.getTransposeInverseModelMatrix=function(){this.matrix||this.getModelMatrix(),this.transinvmatrix||(this.invtransmatrix=a.transposeMat4(this.getInverseModelMatrix()));return this.transinvmatrix}}(GLGE),function(a){a.JSONLoader=function(){},a.JSONLoader.prototype.downloadPriority=0,a.JSONLoader.prototype.setJSONSrc=function(b){var c=this;a.Message.messageLoader(b,function(a){c.setJSONString(a)},this.downloadPriority)},a.JSONLoader.prototype.setJSONString=function(b){var c=JSON.parse(b);c.type==this.className&&(c.uid=this.uid,c.command="update",a.Message.parseMessage(c))},a.JSONLoader.prototype.setDownloadPriority=function(a){this.downloadPriority=a},a.JSONLoader.prototype.getDownloadPriority=function(){return this.downloadPriority}}(GLGE),function(a){a.G_NODE=1,a.G_ROOT=2,a.Group=function(b){a.Assets.registerAsset(this,b),this.children=[];var c=this;this.downloadComplete=function(){c.isComplete()&&c.fireEvent("downloadComplete")}},a.augment(a.Placeable,a.Group),a.augment(a.Animatable,a.Group),a.augment(a.QuickNotation,a.Group),a.augment(a.JSONLoader,a.Group),a.Group.prototype.children=null,a.Group.prototype.className="Group",a.Group.prototype.type=a.G_NODE,a.Group.prototype.isComplete=function(){for(var a=0;a<this.children.length;a++)if(this.children[a].isComplete&&!this.children[a].isComplete())return!1;return!0},a.Group.prototype.setAction=function(a,b,c){a.start(b,c,this.getNames());return this},a.Group.prototype.getNames=function(a){a||(a={});var b=this.getName();b!=""&&(a[b]=this);for(var c=0;c<this.children.length;c++)this.children[c].getNames&&this.children[c].getNames(a);return a},a.Group.prototype.getBoundingVolume=function(b){this.boundingVolume=null;for(var c=0;c<this.children.length;c++)this.children[c].getBoundingVolume&&(this.boundingVolume?this.boundingVolume.addBoundingVolume(this.children[c].getBoundingVolume(!0)):this.boundingVolume=this.children[c].getBoundingVolume(!0).clone());this.boundingVolume||(this.boundingVolume=new a.BoundingVolume(0,0,0,0,0,0)),b?this.boundingVolume.applyMatrix(this.getLocalMatrix()):this.boundingVolume.applyMatrix(this.getModelMatrix());return this.boundingVolume},a.Group.prototype.getObjects=function(a){this.lookAt&&this.Lookat(this.lookAt),this.animation&&this.animate(),a||(a=[]);for(var b=0;b<this.children.length;b++)this.children[b].className=="Object"||this.children[b].className=="Text"||this.children[b].toRender?this.children[b].renderFirst?a.unshift(this.children[b]):a.push(this.children[b]):this.children[b].getObjects&&this.children[b].getObjects(a);return a},a.Group.prototype.getLights=function(a){a||(a=[]);for(var b=0;b<this.children.length;b++)this.children[b].className=="Light"?a.push(this.children[b]):this.children[b].getLights&&this.children[b].getLights(a);return a},a.Group.prototype.updateAllPrograms=function(){var a=this.getObjects();for(var b=0;b<a.length;b++)a[b].updateProgram&&a[b].updateProgram()},a.Group.prototype.addChild=function(a){a.parent&&a.parent.removeChild(a),a.matrix=null,a.parent=this,this.children.push(a);if(a.getLights&&a.getLights().length>0||a.className=="Light"){var b=a;while(b.parent)b=b.parent;b.updateAllPrograms()}a.addEventListener&&(a.addEventListener("shaderupdate",function(){var a=this;while(a.parent)a=a.parent;a.updateAllPrograms()}),a.addEventListener("downloadComplete",this.downloadComplete));return this},a.Group.prototype.addObject=a.Group.prototype.addChild,a.Group.prototype.addObjectInstance=a.Group.prototype.addChild,a.Group.prototype.addGroup=a.Group.prototype.addChild,a.Group.prototype.addLight=a.Group.prototype.addChild,a.Group.prototype.addText=a.Group.prototype.addChild,a.Group.prototype.addSkeleton=a.Group.prototype.addChild,a.Group.prototype.addCamera=a.Group.prototype.addChild,a.Group.prototype.addWavefront=a.Group.prototype.addChild,a.Group.prototype.removeChild=function(a){for(var b=0;b<this.children.length;b++)if(this.children[b]==a){this.children[b].removeEventListener&&this.children[b].removeEventListener(this.downloadComplete),this.children.splice(b,1),this.scene&&this.scene["remove"+a.className]&&this.scene["remove"+a.className](a);break}},a.Group.prototype.getChildren=function(){return this.children},a.Group.prototype.GLInit=function(a){this.gl=a;for(var b=0;b<this.children.length;b++)this.children[b].GLInit&&this.children[b].GLInit(a)},a.Group.prototype.getPickable=function(){return this.pickable},a.Group.prototype.setPickable=function(a){for(var b=0;b<this.children.length;b++)this.children[b].setPickable&&this.children[b].setPickable(a);this.pickable=a;return this}}(GLGE),function(a){a.Message={},a.Message.parseMessage=function(b){switch(b.command){case"create":var c=new a[b.type](b.uid);this.setAttributes(c,b.attributes),b.children&&a.Message.addChildren(c,b.children);return c;case"update":var c=a.Assets.get(b.uid);this.setAttributes(c,b.attributes),b.add&&a.Message.addChildren(c,b.add),b.remove&&a.Message.removeChildren(c,b.remove);return c}return null},a.Message.setAttributes=function(b,c){if(c)for(var d in c)b["set"+d]&&(c[d].command&&(c[d]=a.Message.parseMessage(c[d])),b["set"+d](c[d]));return this},a.Message.addChildren=function(b,c){c instanceof Array||(c=[c]);for(var d=0;d<c.length;d++){if(c[d].command)var e=a.Message.parseMessage(c[d]);else var e=a.Assets.get(c[d]);b["add"+e.className](e)}},a.Message.removeChildren=function(b,c){c instanceof Array||(c=[c]);for(var d=0;d<c.length;d++){var e=a.Assets.get(c[d]);b["add"+e.className](e)}},a.Message.toLoad=[],a.Message.messageLoader=function(b,c,d){a.Message.toLoad.push([b,c,d]),a.Message.toLoad.length==1&&a.Message.loadMessages()},a.Message.loadMessages=function(){var b=a.Message.toLoad.pop(),c=new XMLHttpRequest;c.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?b[1](this.responseText):a.error("Error loading Document: "+b[0]+" status "+this.status))},c.open("GET",b[0],!0),c.send(""),a.Message.toLoad.length>0&&a.Message.loadMessages()}}(GLGE),function(a){a.Action=function(b){a.Assets.registerAsset(this,b),this.channels=[]},a.augment(a.QuickNotation,a.Action),a.augment(a.JSONLoader,a.Action),a.augment(a.Events,a.Action),a.Action.prototype.start=function(a,b,c){b||(b=!1),a||(a=0);var d=this.channels,e=(new Date).getTime();this.animFinished=!1;for(var f=0;f<d.length;f++){var g=d[f].getAnimation(),h=this,i=d[f],j=i.getTarget();typeof j=="string"&&(c&&c[j]&&(j=c[j]));var k={};k.finishEvent=function(a){j.removeEventListener("animFinished",k.finishEvent),!h.animFinished&&j.animation==g&&(h.fireEvent("animFinished",{}),h.animFinished=!0)},j.addEventListener("animFinished",k.finishEvent),j.setAnimation(g,a,e),j.setLoop(b)}},a.Action.prototype.setStartFrame=function(a){for(var b=0;b<this.channels.length;b++)this.channels[b].getAnimation().setStartFrame(a);return this},a.Action.prototype.setFrames=function(a){for(var b=0;b<this.channels.length;b++)this.channels[b].getAnimation().setFrames(a);return this},a.Action.prototype.addActionChannel=function(a){this.channels.push(a);return this},a.Action.prototype.removeActionChannel=function(a){for(var b=0;b<this.channels.length;b++)if(this.channels[b]==channels){this.channels.splice(b,1);break}}}(GLGE),function(a){a.ActionChannel=function(b){a.Assets.registerAsset(this,b)},a.augment(a.QuickNotation,a.ActionChannel),a.augment(a.JSONLoader,a.ActionChannel),a.ActionChannel.prototype.setTarget=function(a){this.target=a},a.ActionChannel.prototype.setAnimation=function(a){this.animation=a},a.ActionChannel.prototype.getTarget=function(){return this.target},a.ActionChannel.prototype.getAnimation=function(){return this.animation}}(GLGE),function(e){e.AnimationCurve=function(a){e.Assets.registerAsset(this,a),this.keyFrames=[],this.solutions={},this.caches={}},e.augment(e.QuickNotation,e.AnimationCurve),e.augment(e.JSONLoader,e.AnimationCurve),e.AnimationCurve.prototype.className="AnimationCurve",e.AnimationCurve.prototype.keyFrames=null,e.AnimationCurve.prototype.addPoint=function(a){this.keyFrames.push(a);return this.keyFrames.length-1},e.AnimationCurve.prototype.addStepPoint=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.addLinearPoint=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.addBezTriple=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.coord=function(a,b){return{x:a,y:b}},e.AnimationCurve.prototype.setChannel=function(a){this.channel=a},e.AnimationCurve.prototype.getValue=function(a){if(this.keyFrames.length==0)return 0;if(this.caches[a])return this.caches[a];var b,c,d,f;if(a<this.keyFrames[0].x)return this.keyFrames[0].y;for(var g=0;g<this.keyFrames.length;g++){if(this.keyFrames[g].x==a)return this.keyFrames[g].y;this.keyFrames[g].x>a||b!=undefined&&this.keyFrames[g].x<=this.keyFrames[b].x?this.keyFrames[g].x<=a&&(d==undefined||this.keyFrames[g].x>this.keyFrames[d].x)&&(d=g):(d=b,b=g),this.keyFrames[g].x<=a||c!=undefined&&this.keyFrames[g].x>this.keyFrames[c].x?this.keyFrames[g].x>a&&(f==undefined||this.keyFrames[g].x<=this.keyFrames[f].x)&&(f=g):(f=c,c=g)}b==undefined&&(b=c,c=f),c==undefined&&(c=b,b=d);if(this.keyFrames[b]instanceof e.BezTriple&&this.keyFrames[c]instanceof e.BezTriple){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),j=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.LinearPoint&&this.keyFrames[c]instanceof e.BezTriple){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),j=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.BezTriple&&this.keyFrames[c]instanceof e.LinearPoint){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),j=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.LinearPoint&&this.keyFrames[c]instanceof e.LinearPoint){var l=(a-this.keyFrames[b].x)*(this.keyFrames[c].y-this.keyFrames[b].y)/(this.keyFrames[c].x-this.keyFrames[b].x)+this.keyFrames[b].y;return l}if(this.keyFrames[b]instanceof e.StepPoint)return this.keyFrames[b].y;this.keyFrames.preStartKey||(this.keyFrames.preStartKey=this.keyFrames[0].y),this.caches[a]=this.keyFrames.preStartKey;return this.caches[a]},e.AnimationCurve.prototype.B1=function(a){return a*a*a},e.AnimationCurve.prototype.B2=function(a){return 3*a*a*(1-a)},e.AnimationCurve.prototype.B3=function(a){return 3*a*(1-a)*(1-a)},e.AnimationCurve.prototype.B4=function(a){return(1-a)*(1-a)*(1-a)},e.AnimationCurve.prototype.getBezier=function(a,b,c,d,e){var f={};f.x=b.x*this.B1(a)+c.x*this.B2(a)+d.x*this.B3(a)+e.x*this.B4(a),f.y=b.y*this.B1(a)+c.y*this.B2(a)+d.y*this.B3(a)+e.y*this.B4(a);return f},e.AnimationCurve.prototype.Quad3Solve=function(a,b,c,d){ref=a+"-"+b+"--"+c+"-"+d;if(this.solutions[ref])return this.solutions[ref];b/=a,c/=a,d/=a;var e,f,g,h,i,j,k;e=(3*c-b*b)/9,f=-(27*d)+b*(9*c-2*(b*b)),f/=54,j=b/3,discrim=e*e*e+f*f,result=[],discrim>0?(h=f+Math.sqrt(discrim),h=h<0?-Math.pow(-h,1/3):Math.pow(h,1/3),i=f-Math.sqrt(discrim),i=i<0?-Math.pow(-i,1/3):Math.pow(i,1/3),result[0]=-j+h+i,j=j+(h+i)/2,result[1]=result[2]=-j,j=Math.sqrt(3)*(-i+h)/2):discrim==0?(k=f<0?-Math.pow(-f,1/3):Math.pow(f,1/3),result[1]=-j+2*k,result[1]=result[2]=-(k+j)):(e=-e,g=e*e*e,g=Math.acos(f/Math.sqrt(1)),k=2*Math.sqrt(e),result[0]=-j+k*Math.cos(g/3),result[1]=-j+k*Math.cos((g+2*Math.PI)/3),result[2]=-j+k*Math.cos((g+4*Math.PI)/3));var l=!1;result[0]>=0&&result[0]<=1&&(l=result[0]),!l&&result[1]>=0&&result[1]<=1&&(l=result[1]),!l&&result[2]>=0&&result[2]<=1&&(l=result[2]),this.solutions[ref]=l;return l},e.AnimationCurve.prototype.atX=function(e,f,g,h,i){a=f.x-g.x*3+h.x*3-i.x,b=g.x*3-h.x*6+i.x*3,c=h.x*3-i.x*3,d=i.x-e;return this.getBezier(this.Quad3Solve(a,b,c,d),f,g,h,i)}}(GLGE),function(a){a.AnimationVector=function(b){a.Assets.registerAsset(this,b),this.curves=[]},a.augment(a.QuickNotation,a.AnimationVector),a.augment(a.JSONLoader,a.AnimationVector),a.AnimationVector.prototype.curves=[],a.AnimationVector.prototype.frames=250,a.AnimationVector.prototype.startFrame=0,a.AnimationVector.prototype.addAnimationCurve=function(a){this.curves[a.channel]=a;return this},a.AnimationVector.prototype.removeAnimationCurve=function(a){delete this.curves[a]},a.AnimationVector.prototype.setFrames=function(a){this.frames=a;return this},a.AnimationVector.prototype.getFrames=function(){return this.frames},a.AnimationVector.prototype.setStartFrame=function(a){this.startFrame=a;return this},a.AnimationVector.prototype.getStartFrame=function(){return this.startFrame}}(GLGE),function(a){a.BezTriple=function(b){a.Assets.registerAsset(this,b)},a.augment(a.QuickNotation,a.BezTriple),a.augment(a.JSONLoader,a.BezTriple),a.BezTriple.prototype.className="BezTriple",a.BezTriple.prototype.setX1=function(a){this.x1=parseFloat(a);return this},a.BezTriple.prototype.setY1=function(a){this.y1=parseFloat(a);return this},a.BezTriple.prototype.setX2=function(a){this.x=parseFloat(a);return this},a.BezTriple.prototype.setY2=function(a){this.y=parseFloat(a);return this},a.BezTriple.prototype.setX3=function(a){this.x3=parseFloat(a);return this},a.BezTriple.prototype.setY3=function(a){this.y3=parseFloat(a);return this},a.LinearPoint=function(a){},a.augment(a.QuickNotation,a.LinearPoint),a.augment(a.JSONLoader,a.LinearPoint),a.LinearPoint.prototype.className="LinearPoint",a.LinearPoint.prototype.x=0,a.LinearPoint.prototype.y=0,a.LinearPoint.prototype.setX=function(a){this.x=parseFloat(a);return this},a.LinearPoint.prototype.setY=function(a){this.y=parseFloat(a);return this},a.StepPoint=function(a,b){this.x=parseFloat(a),this.y=b}}(GLGE),function(a){a.Mesh=function(b,c){a.Assets.registerAsset(this,b),this.GLbuffers=[],this.buffers=[],this.UV=[],this.boneWeights=[],this.setBuffers=[],this.faces={},c!==undefined?this.windingOrder=c:this.windingOrder=a.Mesh.WINDING_ORDER_CLOCKWISE},a.Mesh.WINDING_ORDER_UNKNOWN=2,a.Mesh.WINDING_ORDER_CLOCKWISE=1,a.Mesh.WINDING_ORDER_COUNTER=0,a.augment(a.QuickNotation,a.Mesh),a.augment(a.JSONLoader,a.Mesh),a.augment(a.Events,a.Mesh),a.Mesh.prototype.gl=null,a.Mesh.prototype.className="Mesh",a.Mesh.prototype.GLbuffers=null,a.Mesh.prototype.buffers=null,a.Mesh.prototype.setBuffers=null,a.Mesh.prototype.GLfaces=null,a.Mesh.prototype.faces=null,a.Mesh.prototype.UV=null,a.Mesh.prototype.joints=null,a.Mesh.prototype.invBind=null,a.Mesh.prototype.loaded=!1,a.Mesh.prototype.getBoundingVolume=function(){if(!this.boundingVolume){var b,c,d,e,f,g;for(var h=0;h<this.buffers.length;h++)if(this.buffers[h].name=="position")var i=this.buffers[h].data;for(var h=0;h<i.length;h=h+3)h==0?(b=c=i[h],d=e=i[h+1],f=g=i[h+2]):(b=Math.min(b,i[h]),c=Math.max(c,i[h]),d=Math.min(d,i[h+1]),e=Math.max(e,i[h+1]),f=Math.min(f,i[h+2]),g=Math.max(g,i[h+2]));this.boundingVolume=new a.BoundingVolume(b,c,d,e,f,g)}return this.boundingVolume},a.Mesh.prototype.setJoints=function(a){this.joints=a,this.fireEvent("shaderupdate",{});return this},a.Mesh.prototype.setInvBindMatrix=function(a){this.invBind=a,this.fireEvent("shaderupdate",{});return this},a.Mesh.prototype.setVertexJoints=function(a,b){b||(b=a.length*3/this.positions.length);if(b<5)this.setBuffer("joints1",a,b);else{var c=[],d=[];for(var e=0;e<a.length;e++)e%b<4?c.push(a[e]):d.push(a[e]);this.setBuffer("joints1",c,4),this.setBuffer("joints2",d,b-4)}this.fireEvent("shaderupdate",{});return this},a.Mesh.prototype.setVertexWeights=function(a,b){b||(b=a.length*3/this.positions.length);for(var c=0;c<a.length;c=c+parseInt(b)){var d=0;for(var e=0;e<b;e++)d+=parseFloat(a[c+e]);for(var e=0;e<b;e++)a[c+e]=a[c+e]/d}if(b<4)this.setBuffer("weights1",a,b);else{var f=[],g=[];for(var c=0;c<a.length;c++)c%b<4?f.push(a[c]):g.push(a[c]);this.setBuffer("weights1",f,4),this.setBuffer("weights2",g,b-4)}this.fireEvent("shaderupdate",{});return this},a.Mesh.prototype.clearBuffers=function(){this.GLFaces=null,delete this.GLFaces;for(i in this.buffers)this.buffers[i]=null,delete this.buffers[i];this.buffers=[],this.loaded=!1},a.Mesh.prototype.setUV=function(a){var b=0;for(var c=0;c<a.length;c=c+2)this.UV[b]=a[c],this.UV[b+1]=a[c+1],this.UV[b+2]||(this.UV[b+2]=a[c]),this.UV[b+3]||(this.UV[b+3]=a[c+1]),b=b+4;this.setBuffer("UV",this.UV,4);return this},a.Mesh.prototype.setUV2=function(a){var b=0;for(var c=0;c<a.length;c=c+2)this.UV[b]||(this.UV[b]=a[c]),this.UV[b+1]||(this.UV[b+1]=a[c+1]),this.UV[b+2]=a[c],this.UV[b+3]=a[c+1],b=b+4;this.setBuffer("UV",this.UV,4);return this},a.Mesh.prototype.setPositions=function(a){this.loaded=!0,this.positions=a,this.setBuffer("position",a,3);return this},a.Mesh.prototype.setNormals=function(a){this.normals=a,this.setBuffer("normal",a,3);return this},a.Mesh.prototype.setBuffer=function(a,b,c){for(var d=0;d<b.length;d++)b[d]=parseFloat(b[d]);var e;for(var d=0;d<this.buffers.length;d++)this.buffers[d].name==a&&(e=d);e?this.buffers[e]={name:a,data:b,size:c,GL:!1}:this.buffers.push({name:a,data:b,size:c,GL:!1});return this},a.Mesh.prototype.tangentFromUV=function(b,c,d,e,f,g,h){var i=a.toUnitVec3,j=a.subVec3,k=a.scaleVec3,l=a.dotVec3,m=a.crossVec3;uv21=[f[0]-e[0],f[1]-e[1]],uv31=[g[0]-e[0],g[1]-e[1]],p21=a.subVec3(c,b),p31=a.subVec3(d,b);var n=uv21[0]*uv31[1]-uv31[0]*uv21[1];if(n!=0){n=1/n;var o=j(k(p21,uv31[1]*n),k(p31,uv21[1]*n)),p=j(k(p31,uv21[0]*n),k(p21,uv31[0]*n))}else o=[0,0,0],p=[0,0,0];a.dotVec3(a.crossVec3(p21,p31),h)>0&&(o=k(o,-1),p=k(p,-1));return[o,p]},a.Mesh.prototype.setFaces=function(b){this.faces={data:b,GL:!1},this.normals||this.calcNormals();for(var c=0;c<this.buffers.length;c++){if(this.buffers[c].name=="position")var d=this.buffers[c].data;if(this.buffers[c].name=="UV")var e=this.buffers[c].data;if(this.buffers[c].name=="normal")var f=this.buffers[c].data}if(d&&e){var g=[],h={},i;for(var c=0;c<d.length;c++)g[c]=0;for(var c=0;c<this.faces.data.length;c=c+3){var j=[d[parseInt(this.faces.data[c])*3],d[parseInt(this.faces.data[c])*3+1],d[parseInt(this.faces.data[c])*3+2]],k=[d[parseInt(this.faces.data[c+1])*3],d[parseInt(this.faces.data[c+1])*3+1],d[parseInt(this.faces.data[c+1])*3+2]],l=[d[parseInt(this.faces.data[c+2])*3],d[parseInt(this.faces.data[c+2])*3+1],d[parseInt(this.faces.data[c+2])*3+2]],m=[f[parseInt(this.faces.data[c])*3],f[parseInt(this.faces.data[c])*3+1],f[parseInt(this.faces.data[c])*3+2]],n=[f[parseInt(this.faces.data[c+1])*3],f[parseInt(this.faces.data[c+1])*3+1],f[parseInt(this.faces.data[c+1])*3+2]],o=[f[parseInt(this.faces.data[c+2])*3],f[parseInt(this.faces.data[c+2])*3+1],f[parseInt(this.faces.data[c+2])*3+2]],p=[e[parseInt(this.faces.data[c])*4],e[parseInt(this.faces.data[c])*4+1]],q=[e[parseInt(this.faces.data[c+1])*4],e[parseInt(this.faces.data[c+1])*4+1]],r=[e[parseInt(this.faces.data[c+2])*4],e[parseInt(this.faces.data[c+2])*4+1]],s=this.tangentFromUV(k,j,l,q,p,r,n);h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")]?(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][0]+=s[0][0],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][1]+=s[0][1],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][2]+=s[0][2],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][0]+=s[1][0],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][1]+=s[1][1],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][2]+=s[1][2]):h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")]=s,h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")]?(h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][0]+=s[0][0],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][1]+=s[0][1],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][2]+=s[0][2],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][0]+=s[1][0],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][1]+=s[1][1],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][2]+=s[1][2]):h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")]=s,h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")]?(h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][0]+=s[0][0],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][1]+=s[0][1],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][2]+=s[0][2],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][0]+=s[1][0],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][1]+=s[1][1],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][2]+=s[1][2]):h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")]=s}for(var c=0;c<d.length/3;c++){var j=[d[c*3],d[c*3+1],d[c*3+2]],m=[f[c*3],f[c*3+1],f[c*3+2]],p=[e[c*4],e[c*4+1]],t=a.toUnitVec3(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0]),u=a.toUnitVec3(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1]);t&&(g[c*3]=t[0],g[c*3+1]=t[1],g[c*3+2]=t[2])}this.setBuffer("tangent",g,3)}return this},a.Mesh.prototype.GLSetFaceBuffer=function(a){this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces.data),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=this.faces.data.length},a.Mesh.prototype.GLSetBuffer=function(a,b,c,d){this.GLbuffers[b]||(this.GLbuffers[b]=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.GLbuffers[b]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW),this.GLbuffers[b].itemSize=d,this.GLbuffers[b].numItems=c.length/d},a.Mesh.prototype.calcNormals=function(){var b=[],c=this.positions,d=this.faces.data;if(!d){d=[];for(var e=0;e<c.length/3;e++)d[e]=e}for(var e=0;e<d.length;e=e+3){var f=[c[d[e]*3],c[d[e]*3+1],c[d[e]*3+2]],g=[c[d[e+1]*3],c[d[e+1]*3+1],c[d[e+1]*3+2]],h=[c[d[e+2]*3],c[d[e+2]*3+1],c[d[e+2]*3+2]],i=a.subVec3(g,f),j=a.subVec3(h,f),k=a.toUnitVec3(a.crossVec3(i,j));b[d[e]]==undefined&&(b[d[e]]=[]),b[d[e]].push(k),b[d[e+1]]==undefined&&(b[d[e+1]]=[]),b[d[e+1]].push(k),b[d[e+2]]==undefined&&(b[d[e+2]]=[]),b[d[e+2]].push(k)}var l=[];for(e=0;e<b.length;e++){var m=0,n=0,o=0;if(b[e]!=undefined){for(var p=0;p<b[e].length;p++)m+=b[e][p][0],n+=b[e][p][1],o+=b[e][p][2];m/=b[e].length,n/=b[e].length,o/=b[e].length,l[e*3]=m,l[e*3+1]=n,l[e*3+2]=o}}this.setNormals(l)},a.Mesh.prototype.GLAttributes=function(b,c){this.gl=b,this.normals||this.calcNormals();for(var d=0;d<8;d++)b.disableVertexAttribArray(d);!this.faces.GL&&this.faces.data&&this.faces.data.length>0&&(this.GLSetFaceBuffer(b),this.faces.GL=!0);for(d=0;d<this.buffers.length;d++)this.buffers[d].GL||(this.GLSetBuffer(b,this.buffers[d].name,this.buffers[d].data,this.buffers[d].size),this.buffers[d].GL=!0),attribslot=a.getAttribLocation(b,c,this.buffers[d].name),attribslot>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.GLbuffers[this.buffers[d].name]),b.enableVertexAttribArray(attribslot),b.vertexAttribPointer(attribslot,this.GLbuffers[this.buffers[d].name].itemSize,b.FLOAT,!1,0,0))}}(GLGE),function(a){var b=0;a.Material=function(c){a.Assets.registerAsset(this,c),this.layers=[],this.layerlisteners=[],this.textures=[],this.lights=[],this.color={r:1,g:1,b:1,a:1},this.specColor={r:1,g:1,b:1},this.reflect=.8,this.shine=10,this.specular=1,this.emit=0,this.alpha=1,this.materialIdx=b++},a.augment(a.Animatable,a.Material),a.augment(a.QuickNotation,a.Material),a.augment(a.JSONLoader,a.Material),a.augment(a.Events,a.Material),a.M_COLOR=1,a.M_NOR=2,a.M_ALPHA=4,a.M_SPECCOLOR=8,a.M_SPECULAR=16,a.M_SHINE=32,a.M_REFLECT=64,a.M_EMIT=128,a.M_ALPHA=256,a.M_MSKR=512,a.M_MSKG=1024,a.M_MSKB=2048,a.M_MSKA=4096,a.M_HEIGHT=8192,a.M_AMBIENT=16384,a.UV1=0,a.UV2=1,a.MAP_NORM=3,a.MAP_OBJ=4,a.MAP_REF=5,a.MAP_ENV=6,a.MAP_VIEW=7,a.BL_MIX=0,a.BL_MUL=1,a.Material.prototype.layers=null,a.Material.prototype.className="Material",a.Material.prototype.textures=null,a.Material.prototype.color=null,a.Material.prototype.specColor=null,a.Material.prototype.specular=null,a.Material.prototype.emit=null,a.Material.prototype.shine=null,a.Material.prototype.reflect=null,a.Material.prototype.lights=null,a.Material.prototype.alpha=null,a.Material.prototype.ambient=null,a.Material.prototype.shadow=!0,a.Material.prototype.downloadComplete=!1,a.Material.prototype.setShadow=function(a){this.shadow=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getShadow=function(a){return this.shadow},a.Material.prototype.setColor=function(b){b.r||(b=a.colorParse(b)),this.color={r:b.r,g:b.g,b:b.b},this.fireEvent("shaderupdate",{});return this},a.Material.prototype.setColorR=function(a){this.color.r=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.setColorG=function(a){this.color.g=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.setColorB=function(a){this.color.b=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getColor=function(){return this.color},a.Material.prototype.setSpecularColor=function(b){b.r||(b=a.colorParse(b)),this.specColor={r:parseFloat(b.r),g:parseFloat(b.g),b:parseFloat(b.b)},this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getAmbient=function(){return this.ambient},a.Material.prototype.setAmbient=function(b){b.r||(b=a.colorParse(b)),this.ambient={r:parseFloat(b.r),g:parseFloat(b.g),b:parseFloat(b.b)},this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getSpecularColor=function(){return this.specColor},a.Material.prototype.setAlpha=function(a){this.alpha=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getAlpha=function(){return this.alpha},a.Material.prototype.setSpecular=function(a){this.specular=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getSpecular=function(){return this.specular},a.Material.prototype.setShininess=function(a){a<=0&&(a=.001),this.shine=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getShininess=function(){return this.shine},a.Material.prototype.setEmit=function(a){this.emit=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getEmit=function(){return this.emit},a.Material.prototype.setReflectivity=function(a){this.reflect=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getReflectivity=function(){return this.reflect},a.Material.prototype.setBinaryAlpha=function(a){this.binaryAlpha=a,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.getBinaryAlpha=function(){return this.binaryAlpha},a.Material.prototype.addMaterialLayer=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.layers.push(b);var c=this,d=function(a){c.fireEvent("shaderupdate",{})};this.layerlisteners.push(d),b.addEventListener("shaderupdate",d),this.fireEvent("shaderupdate",{});return this},a.Material.prototype.removeMaterialLayer=function(a){var b=this.layers.indexOf(a);b>=0&&(this.layers.splice(b,1),a.removeEventListener("shaderupdate",this.layerlisteners[b]),this.layerlisteners.splice(b,1),this.fireEvent("shaderupdate",{}));return this},a.Material.prototype.getLayers=function(){return this.layers},a.Material.prototype.getLayerCoords=function(){var b=[];b.push("vec4 texturePos;\n");for(i=0;i<this.layers.length;i++)b.push("textureCoords"+i+"=vec3(0.0,0.0,0.0);\n"),(this.layers[i].mapinput==a.UV1||this.layers[i].mapinput==a.UV2)&&b.push("texturePos=vec4(vec2(UVCoord["+this.layers[i].mapinput*2+"],(1.0-UVCoord["+(this.layers[i].mapinput*2+1)+"])),1.0,1.0);\n"),this.layers[i].mapinput==a.MAP_NORM&&b.push("texturePos=vec4(normalize(n.xyz),1.0);\n"),this.layers[i].mapinput==a.MAP_OBJ&&b.push("texturePos=vec4(normalize(OBJCoord.xyz),1.0);\n"),this.layers[i].mapinput==a.MAP_REF&&b.push("texturePos=vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"),this.layers[i].mapinput==a.MAP_ENV&&b.push("texturePos=envMat * vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"),b.push("textureCoords"+i+"=(layer"+i+"Matrix * texturePos).xyz;\n");return b.join("")},a.Material.prototype.getVertexVarying=function(){var a=[];for(i=0;i<this.layers.length;i++)a.push("uniform mat4 layer"+i+"Matrix;\n"),a.push("varying vec3 textureCoords"+i+";\n");return a.join("")},a.Material.prototype.registerPasses=function(a,b){for(var c=0;c<this.textures.length;c++)this.textures[c].registerPasses&&this.textures[c].registerPasses(a,b)},a.Material.prototype.getFragmentShader=function(b){var c="#ifdef GL_ES\nprecision highp float;\n#endif\n",d=!1;for(var e=0;e<b.length;e++)if(b[e].type==a.L_POINT||b[e].type==a.L_SPOT||b[e].type==a.L_DIR)c=c+"varying vec3 lightvec"+e+";\n",c=c+"varying float lightdist"+e+";\n";c=c+"varying vec3 n;\n",c=c+"varying vec3 t;\n",c=c+"varying vec4 UVCoord;\n",c=c+"varying vec3 eyevec;\n",c=c+"varying vec3 OBJCoord;\n";for(var e=0;e<this.textures.length;e++)this.textures[e].className=="Texture"&&(c=c+"uniform sampler2D TEXTURE"+e+";\n"),this.textures[e].className=="TextureCanvas"&&(c=c+"uniform sampler2D TEXTURE"+e+";\n"),this.textures[e].className=="TextureVideo"&&(c=c+"uniform sampler2D TEXTURE"+e+";\n"),this.textures[e].className=="TextureCube"&&(c=c+"uniform samplerCube TEXTURE"+e+";\n");var f=0,g=[],h;for(var e=0;e<b.length;e++)c=c+"uniform vec3 lightcolor"+e+";\n",c=c+"uniform vec3 lightAttenuation"+e+";\n",c=c+"uniform float spotCosCutOff"+e+";\n",c=c+"uniform float spotExp"+e+";\n",c=c+"uniform vec3 lightdir"+e+";\n",c=c+"uniform mat4 lightmat"+e+";\n",c=c+"uniform float shadowbias"+e+";\n",c=c+"uniform int shadowsamples"+e+";\n",c=c+"uniform float shadowsoftness"+e+";\n",c=c+"uniform bool castshadows"+e+";\n",b[e].getCastShadows()&&this.shadow&&(c=c+"varying vec4 spotcoord"+e+";\n",h=this.textures.length+f++,c=c+"uniform sampler2D TEXTURE"+h+";\n",g[e]=h);for(e=0;e<this.layers.length;e++)c=c+"varying vec3 textureCoords"+e+";\n",c=c+"uniform float layeralpha"+e+";\n",(this.layers[e].mapto&a.M_HEIGHT)==a.M_HEIGHT&&(c=c+"uniform float layerheight"+e+";\n");c=c+"uniform vec4 baseColor;\n",c=c+"uniform vec3 specColor;\n",c=c+"uniform float shine;\n",c=c+"uniform float specular;\n",c=c+"uniform float reflective;\n",c=c+"uniform float emit;\n",c=c+"uniform float alpha;\n",c=c+"uniform vec3 amb;\n",c=c+"uniform float fognear;\n",c=c+"uniform float fogfar;\n",c=c+"uniform int fogtype;\n",c=c+"uniform vec3 fogcolor;\n",c=c+"uniform float far;\n",c=c+"uniform mat4 worldInverseTranspose;\n",c=c+"uniform mat4 projection;\n",c=c+"uniform bool emitpass;\n",c=c+"void main(void)\n",c=c+"{\n",c=c+"float att;\n",c=c+"int texture;\n",c=c+"float mask=1.0;\n",c=c+"float spec=specular;\n",c=c+"vec3 specC=specColor;\n",c=c+"vec4 view;\n",c=c+"vec3 textureCoords=vec3(0.0,0.0,0.0);\n",c=c+"float ref=reflective;\n",c=c+"float sh=shine;\n",c=c+"float em=emit;\n",c=c+"float al=alpha;\n",c=c+"vec3 amblight=amb;\n",c=c+"vec4 normalmap= vec4(n,0.0);\n",c=c+"vec4 color = baseColor;",c=c+"float pheight=0.0;\n",c=c+"vec3 textureHeight=vec3(0.0,0.0,0.0);\n",c=c+"vec3 normal = normalize(n);\n",c=c+"vec3 b = vec3(0.0,0.0,0.0);\n";var i=0,j=!1;for(e=0;e<this.layers.length;e++){c=c+"textureCoords=textureCoords"+e+"+textureHeight;\n",c=c+"mask=layeralpha"+e+"*mask;\n",this.layers[e].mapinput==a.MAP_VIEW&&(c=c+"view=projection * vec4(-eyevec,1.0);\n",c=c+"textureCoords=view.xyz/view.w*0.5+0.5;\n",c=c+"textureCoords=textureCoords+textureHeight;\n");if(this.layers[e].getTexture().className=="Texture"||this.layers[e].getTexture().className=="TextureCanvas"||this.layers[e].getTexture().className=="TextureVideo")var k="xy",l="2D";else var k="xyz",l="Cube";(this.layers[e].mapto&a.M_COLOR)==a.M_COLOR&&(i=e,this.layers[e].blendMode==a.BL_MUL?c=c+"color = color*(1.0-mask) + color*texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+")*mask;\n":c=c+"color = color*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+")*mask;\n"),(this.layers[e].mapto&a.M_HEIGHT)==a.M_HEIGHT&&(c=c+"pheight = texture2D(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").x;\n",c=c+"textureHeight =vec3((layerheight"+e+"* (pheight-0.5)  * normalize(eyevec).xy*vec2(1.0,-1.0)),0.0);\n"),(this.layers[e].mapto&a.M_SPECCOLOR)==a.M_SPECCOLOR&&(c=c+"specC = specC*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").rgb*mask;\n"),(this.layers[e].mapto&a.M_MSKR)==a.M_MSKR&&(c=c+"mask = texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").r;\n"),(this.layers[e].mapto&a.M_MSKG)==a.M_MSKG&&(c=c+"mask = texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").g;\n"),(this.layers[e].mapto&a.M_MSKB)==a.M_MSKB&&(c=c+"mask = texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").b;\n"),(this.layers[e].mapto&a.M_MSKA)==a.M_MSKA&&(c=c+"mask = texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").a;\n"),(this.layers[e].mapto&a.M_SPECULAR)==a.M_SPECULAR&&(c=c+"spec = spec*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").r*mask;\n"),(this.layers[e].mapto&a.M_REFLECT)==a.M_REFLECT&&(c=c+"ref = ref*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").g*mask;\n"),(this.layers[e].mapto&a.M_SHINE)==a.M_SHINE&&(c=c+"sh = sh*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").b*mask*255.0;\n"),(this.layers[e].mapto&a.M_EMIT)==a.M_EMIT&&(c=c+"em = em*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").r*mask;\n"),(this.layers[e].mapto&a.M_NOR)==a.M_NOR&&(c=c+"normalmap = normalmap*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+")*mask;\n",c=c+"normal = normalmap.rgb;\n",c=c+"normal = 2.0*(vec3(normal.r, -normal.g, normal.b) - vec3(0.5, -0.5, 0.5));",c=c+"b=normalize(cross(t.xyz,n));\n",c=c+"normal = normal.x*t + normal.y*b + normal.z*n;",c=c+"normal = normalize(normal);"),(this.layers[e].mapto&a.M_ALPHA)==a.M_ALPHA&&(j=!0,c=c+"al = al*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").a*mask;\n"),(this.layers[e].mapto&a.M_AMBIENT)==a.M_AMBIENT&&(c=c+"amblight = amblight*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[e].texture.idx+", textureCoords."+k+").rgb*mask;\n")}if(!j&&this.layers.length){if(this.layers[i].getTexture().className=="Texture"||this.layers[i].getTexture().className=="TextureCanvas"||this.layers[i].getTexture().className=="TextureVideo")var k="xy",l="2D";else var k="xyz",l="Cube";c=c+"al = al*(1.0-mask) + texture"+l+"(TEXTURE"+this.layers[i].texture.idx+", textureCoords."+k+").a*mask;\n"}this.binaryAlpha?(c=c+"if(al<0.5) discard;\n",c=c+"al=1.0;\n"):c=c+"if(al<0.0625) discard;\n",c=c+"vec3 lightvalue=amblight;\n",c=c+"float dotN,spotEffect;",c=c+"vec3 lightvec=vec3(0.0,0.0,0.0);",c=c+"vec3 viewvec=vec3(0.0,0.0,0.0);",c=c+"vec3 specvalue=vec3(0.0,0.0,0.0);",c=c+"vec2 scoord=vec2(0.0,0.0);",c=c+"float spotmul=0.0;",c=c+"float rnd=0.0;",c=c+"float spotsampleX=0.0;",c=c+"float spotsampleY=0.0;",c=c+"float totalweight=0.0;",c=c+"int cnt=0;",c=c+"float specularSmoothStepValue=.125;\n",c=c+"vec2 spotoffset=vec2(0.0,0.0);",c=c+"float dp=0.0;",c=c+"if (normal.z<0.0) {normal.z=0.0;}\n",c=c+"float fogfact=1.0;",c=c+"if(fogtype=="+a.FOG_QUADRATIC+") fogfact=clamp(pow(max((fogfar - length(eyevec)) / (fogfar - fognear),0.0),2.0),0.0,1.0);\n",c=c+"if(fogtype=="+a.FOG_LINEAR+") fogfact=clamp((fogfar - length(eyevec)) / (fogfar - fognear),0.0,1.0);\n",c=c+"if (emitpass) {gl_FragColor=vec4(color.rgb*em,1.0);} else {\n";for(var e=0;e<b.length;e++)c=c+"lightvec=lightvec"+e+";\n",c=c+"viewvec=eyevec;\n",b[e].type==a.L_POINT&&(c=c+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n",c=c+"att = 1.0 / (lightAttenuation"+e+"[0] + lightAttenuation"+e+"[1] * lightdist"+e+" + lightAttenuation"+e+"[2] * lightdist"+e+" * lightdist"+e+");\n",c=c+"if(dotN>0.0){\n",b[e].diffuse&&(c=c+"lightvalue += att * dotN * lightcolor"+e+";\n"),c=c+"}\n",b[e].specular&&(c=c+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN)*att * specC * lightcolor"+e+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3*sh);\n")),c=c+"spotEffect = 0.0;\n",b[e].type==a.L_SPOT&&(c=c+"spotEffect = dot(normalize(lightdir"+e+"), normalize(-lightvec"+e+"));",c=c+"if (spotEffect > spotCosCutOff"+e+") {\n",c=c+"spotEffect = pow(spotEffect, spotExp"+e+");",b[e].getCastShadows()&&this.shadow&&(c=c+"scoord=(((spotcoord"+e+".xy)/spotcoord"+e+".w)+1.0)/2.0;\n",c=c+"if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0){\n",c=c+"vec4 dist=texture2D(TEXTURE"+g[e]+", scoord);\n",c=c+"float depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+b[e].distance+".0;\n",c=c+"spotmul=0.0;\n",c=c+"totalweight=0.0;\n",c=c+"if((depth+shadowbias"+e+"-length(lightvec"+e+"))<0.0) {spotmul=1.0; totalweight=1.0;}\n",b[e].samples>0&&(c=c+"for(int cnt=0; cnt<4; cnt++){;\n",c=c+"spotsampleX=-0.707106781;spotsampleY=-0.707106781;\n",c=c+"if(cnt==0 || cnt==3) spotsampleX=0.707106781;\n",c=c+"if(cnt==1 || cnt==3) spotsampleY=0.707106781;\n",c=c+"spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n",c=c+"dist=texture2D(TEXTURE"+g[e]+", scoord+spotoffset*shadowsoftness"+e+");\n",c=c+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+b[e].distance+".0;\n",c=c+"if((depth+shadowbias"+e+"-length(lightvec"+e+"))<0.0){\n",c=c+"spotmul+=length(spotoffset);\n",c=c+"}\n",c=c+"totalweight+=length(spotoffset);\n",c=c+"};\n",c=c+"if(totalweight!=spotmul){\n",c=c+"spotmul=0.0;\n",c=c+"totalweight=0.0;\n",c=c+"for(int cnt=0; cnt<"+b[e].samples+"; cnt++){;\n",c=c+"rnd=(fract(sin(dot(scoord,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;\n",c=c+"spotsampleX=cos(float(cnt)*"+(360/b[e].samples).toFixed(2)+"+rnd);\n",c=c+"spotsampleY=sin(float(cnt)*"+(360/b[e].samples).toFixed(2)+"+rnd);\n",c=c+"spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n",c=c+"dist=texture2D(TEXTURE"+g[e]+", scoord+spotoffset*shadowsoftness"+e+");\n",c=c+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+b[e].distance+".0;\n",c=c+"if((depth+shadowbias"+e+"-length(lightvec"+e+"))<0.0){\n",c=c+"spotmul+=length(spotoffset);\n",c=c+"}\n",c=c+"totalweight+=length(spotoffset);\n",c=c+"};\n",c=c+"}\n"),c=c+"if(totalweight>0.0) spotEffect=spotEffect*pow(1.0-spotmul/totalweight,3.0);\n",c=c+"}\n"),c=c+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n",b[e].negativeShadow?(c=c+"if(dotN>0.0){\n",b[e].diffuse&&(c=c+"lightvalue -= (1.0-spotEffect) / (lightAttenuation"+e+"[0] + lightAttenuation"+e+"[1] * lightdist"+e+" + lightAttenuation"+e+"[2] * lightdist"+e+" * lightdist"+e+");\n"),c=c+"}\n"):(c=c+"att = spotEffect / (lightAttenuation"+e+"[0] + lightdist"+e+"*(lightAttenuation"+e+"[1]  + lightAttenuation"+e+"[2] * lightdist"+e+"));\n",c=c+"if(dotN>0.0){\n",b[e].diffuse&&(c=c+"lightvalue += att * dotN * lightcolor"+e+";\n"),c=c+"}\n",b[e].specular&&(c=c+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * att * specC * lightcolor"+e+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n")),c=c+"}\n"),b[e].type==a.L_DIR&&(c=c+"dotN=max(dot(normal,-normalize(lightvec)),0.0);\n",b[e].diffuse&&(c=c+"lightvalue += dotN * lightcolor"+e+";\n"),b[e].specular&&(c=c+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * specC * lightcolor"+e+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n"));c=c+"lightvalue = (lightvalue)*ref;\n",c=c+"if(em>0.0){lightvalue=vec3(1.0,1.0,1.0);}\n",c=c+"gl_FragColor =vec4(specvalue.rgb+color.rgb*(em+1.0)*lightvalue.rgb,al)*fogfact+vec4(fogcolor,al)*(1.0-fogfact);\n",c=c+"}\n",c=c+"}\n";return c},a.Material.prototype.textureUniforms=function(b,c,d,e){this.animation&&this.animate();var f=c.caches;f.baseColor!=this.color&&(this.ccache!=this.color&&(this.ccache=this.color,this.glColor=new Float32Array([this.color.r,this.color.g,this.color.b,this.color.a])),b.uniform4fv(a.getUniformLocation(b,c,"baseColor"),this.glColor),f.baseColor=this.color),f.specColor!=this.specColor&&(this.sccache!=this.specColor&&(this.sccache=this.specColor,this.glspecColor=new Float32Array([this.specColor.r,this.specColor.g,this.specColor.b])),b.uniform3fv(a.getUniformLocation(b,c,"specColor"),this.glspecColor),f.specColor=this.specColor),f.specular!=this.specular&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"specular"),this.specular),f.specular=this.specular),f.shine!=this.shine&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"shine"),this.shine),f.shine=this.shine),f.reflect!=this.reflect&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"reflective"),this.reflect),f.reflect=this.reflect),f.emit!=this.emit&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"emit"),this.emit),f.emit=this.emit),f.alpha!=this.alpha&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"alpha"),this.alpha),f.alpha=this.alpha);var g=0,h=0;f.lightcolor||(f.lightcolor=[],f.lightAttenuation=[],f.spotCosCutOff=[],f.spotExponent=[],f.shadowbias=[],f.castshadows=[],f.shadowsamples=[],f.shadowsoftness=[]);for(var i=0;i<d.length;i++)f.lightcolor[i]!=d[i].color&&(a.setUniform3(b,"3f",a.getUniformLocation(b,c,"lightcolor"+i),d[i].color.r,d[i].color.g,d[i].color.b),f.lightcolor[i]=d[i].color),f.lightAttenuation[i]!=d[i].constantAttenuation&&(a.setUniform3(b,"3f",a.getUniformLocation(b,c,"lightAttenuation"+i),d[i].constantAttenuation,d[i].linearAttenuation,d[i].quadraticAttenuation),f.lightAttenuation[i]=d[i].constantAttenuation),f.spotCosCutOff[i]!=d[i].spotCosCutOff&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"spotCosCutOff"+i),d[i].spotCosCutOff),f.spotCosCutOff[i]=d[i].spotCosCutOff),f.spotExponent[i]!=d[i].spotExponent&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"spotExp"+i),d[i].spotExponent),f.spotExponent[i]=d[i].spotExponent),f.shadowbias[i]!=d[i].shadowBias&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"shadowbias"+i),d[i].shadowBias),f.shadowbias[i]=d[i].shadowBias),f.shadowsoftness[i]!=d[i].softness&&(a.setUniform(b,"1f",a.getUniformLocation(b,c,"shadowsoftness"+i),d[i].softness),f.shadowsoftness[i]=d[i].softness),d[i].getCastShadows()&&this.shadow&&this.emit==0&&(h=this.textures.length+g++,b.activeTexture(b["TEXTURE"+h]),b.bindTexture(b.TEXTURE_2D,d[i].texture),a.setUniform(b,"1i",a.getUniformLocation(b,c,"TEXTURE"+h),h));c.glarrays.layermat||(c.glarrays.layermat=[]);var j,k;for(i=0;i<this.layers.length;i++){this.layers[i].animation&&this.layers[i].animate(),j=this.layers[i].getScale(),k=this.layers[i].getOffset(),c.glarrays.layermat[i]?a.mat4gl(this.layers[i].getMatrix(),c.glarrays.layermat[i]):c.glarrays.layermat[i]=new Float32Array(this.layers[i].getMatrix());try{a.setUniformMatrix(b,"Matrix4fv",a.getUniformLocation(b,c,"layer"+i+"Matrix"),!0,c.glarrays.layermat[i])}catch(l){}a.setUniform(b,"1f",a.getUniformLocation(b,c,"layeralpha"+i),this.layers[i].getAlpha()),a.setUniform(b,"1f",a.getUniformLocation(b,c,"layerheight"+i),this.layers[i].getHeight())}for(var i=0;i<this.textures.length;i++)b.activeTexture(b["TEXTURE"+i]),!this.textures[i].doTexture(b,e),a.setUniform(b,"1i",a.getUniformLocation(b,c,"TEXTURE"+i),i)},a.Material.prototype.isComplete=function(){for(var a=0;a<this.textures.length;a++)if(!this.textures[a].isComplete())return!1;return!0},a.Material.prototype.addTexture=function(b){typeof b=="string"&&(b=a.Assets.get(b));var c=this;b.addEventListener("downloadComplete",function(){c.isComplete()&&c.fireEvent("downloadComplete")}),this.textures.push(b),b.idx=this.textures.length-1,this.fireEvent("shaderupdate",{});return this},a.Material.prototype.addTextureCube=a.Material.prototype.addTexture,a.Material.prototype.addTextureCamera=a.Material.prototype.addTexture,a.Material.prototype.addTextureCanvas=a.Material.prototype.addTexture,a.Material.prototype.addTextureVideo=a.Material.prototype.addTexture,a.DEFAULT_MATERIAL=new a.Material}(GLGE),function(a){a.MaterialLayer=function(b){a.Assets.registerAsset(this,b),this.blendMode=a.BL_MIX},a.augment(a.Animatable,a.MaterialLayer),a.augment(a.QuickNotation,a.MaterialLayer),a.augment(a.JSONLoader,a.MaterialLayer),a.augment(a.Events,a.MaterialLayer),a.MaterialLayer.prototype.className="MaterialLayer",a.MaterialLayer.prototype.texture=null,a.MaterialLayer.prototype.blendMode=null,a.MaterialLayer.prototype.mapto=a.M_COLOR,a.MaterialLayer.prototype.mapinput=a.UV1,a.MaterialLayer.prototype.scaleX=1,a.MaterialLayer.prototype.offsetX=0,a.MaterialLayer.prototype.rotX=0,a.MaterialLayer.prototype.scaleY=1,a.MaterialLayer.prototype.offsetY=0,a.MaterialLayer.prototype.rotY=0,a.MaterialLayer.prototype.scaleZ=1,a.MaterialLayer.prototype.offsetZ=0,a.MaterialLayer.prototype.rotZ=0,a.MaterialLayer.prototype.dScaleX=0,a.MaterialLayer.prototype.dOffsetX=0,a.MaterialLayer.prototype.dRotX=0,a.MaterialLayer.prototype.dScaleY=0,a.MaterialLayer.prototype.dOffsetY=0,a.MaterialLayer.prototype.dRotY=0,a.MaterialLayer.prototype.dScaleZ=0,a.MaterialLayer.prototype.dOffsetZ=0,a.MaterialLayer.prototype.dRotZ=0,a.MaterialLayer.prototype.alpha=1,a.MaterialLayer.prototype.height=.05,a.MaterialLayer.prototype.matrix=null,a.MaterialLayer.prototype.getMatrix=function(){if(!this.matrix){var b=this.getOffset(),c=this.getScale(),d=this.getRotation();this.matrix=a.mulMat4(a.mulMat4(a.translateMatrix(b.x,b.y,b.z),a.scaleMatrix(c.x,c.y,c.z)),a.rotateMatrix(d.x,d.y,d.z))}return this.matrix},a.MaterialLayer.prototype.setHeight=function(a){this.height=a;return this},a.MaterialLayer.prototype.getHeight=function(){return this.height},a.MaterialLayer.prototype.setAlpha=function(a){this.alpha=a;return this},a.MaterialLayer.prototype.getAlpha=function(){return this.alpha},a.MaterialLayer.prototype.setTexture=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.texture=b,this.fireEvent("shaderupdate",{});return this},a.MaterialLayer.prototype.getTexture=function(){return this.texture},a.MaterialLayer.prototype.setMapto=function(a){this.mapto=a,this.fireEvent("shaderupdate",{});return this},a.MaterialLayer.prototype.getMapto=function(){return this.mapto},a.MaterialLayer.prototype.setMapinput=function(a){this.mapinput=a,this.fireEvent("shaderupdate",{});return this},a.MaterialLayer.prototype.getMapinput=function(){return this.mapinput},a.MaterialLayer.prototype.getOffset=function(){var a={};a.x=parseFloat(this.getOffsetX())+parseFloat(this.getDOffsetX()),a.y=parseFloat(this.getOffsetY())+parseFloat(this.getDOffsetY()),a.z=parseFloat(this.getOffsetZ())+parseFloat(this.getDOffsetZ());return a},a.MaterialLayer.prototype.getRotation=function(){var a={};a.x=parseFloat(this.getRotX())+parseFloat(this.getDRotX()),a.y=parseFloat(this.getRotY())+parseFloat(this.getDRotY()),a.z=parseFloat(this.getRotZ())+parseFloat(this.getDRotZ());return a},a.MaterialLayer.prototype.getScale=function(){var a={};a.x=parseFloat(this.getScaleX())+parseFloat(this.getDScaleX()),a.y=parseFloat(this.getScaleY())+parseFloat(this.getDScaleY()),a.z=parseFloat(this.getScaleZ())+parseFloat(this.getDScaleZ());return a},a.MaterialLayer.prototype.setOffsetX=function(a){this.matrix=null,this.offsetX=a;return this},a.MaterialLayer.prototype.getOffsetX=function(){return this.offsetX},a.MaterialLayer.prototype.setOffsetY=function(a){this.matrix=null,this.offsetY=a;return this},a.MaterialLayer.prototype.getOffsetY=function(){return this.offsetY},a.MaterialLayer.prototype.setOffsetZ=function(a){this.matrix=null,this.offsetZ=a;return this},a.MaterialLayer.prototype.getOffsetZ=function(){return this.offsetZ},a.MaterialLayer.prototype.setDOffsetX=function(a){this.matrix=null,this.dOffsetX=a;return this},a.MaterialLayer.prototype.getDOffsetX=function(){return this.dOffsetX},a.MaterialLayer.prototype.setDOffsetY=function(a){this.matrix=null,this.dOffsetY=a;return this},a.MaterialLayer.prototype.getDOffsetY=function(){return this.dOffsetY},a.MaterialLayer.prototype.setDOffsetZ=function(a){this.matrix=null,this.dOffsetZ=a;return this},a.MaterialLayer.prototype.getDOffsetZ=function(){return this.dOffsetZ},a.MaterialLayer.prototype.setScaleX=function(a){this.matrix=null,this.scaleX=a;return this},a.MaterialLayer.prototype.getScaleX=function(){return this.scaleX},a.MaterialLayer.prototype.setScaleY=function(a){this.matrix=null,this.scaleY=a;return this},a.MaterialLayer.prototype.getScaleY=function(){return this.scaleY},a.MaterialLayer.prototype.setScaleZ=function(a){this.matrix=null,this.scaleZ=a;return this},a.MaterialLayer.prototype.getScaleZ=function(){return this.scaleZ},a.MaterialLayer.prototype.setDScaleX=function(a){this.matrix=null,this.dScaleX=a;return this},a.MaterialLayer.prototype.getDScaleX=function(){return this.dScaleX},a.MaterialLayer.prototype.setDScaleY=function(a){this.matrix=null,this.dScaleY=a;return this},a.MaterialLayer.prototype.getDScaleY=function(){return this.dScaleY},a.MaterialLayer.prototype.setDScaleZ=function(a){this.matrix=null,this.dScaleZ=a;return this},a.MaterialLayer.prototype.getDScaleZ=function(){return this.dScaleZ},a.MaterialLayer.prototype.setRotX=function(a){this.matrix=null,this.rotX=a;return this},a.MaterialLayer.prototype.getRotX=function(){return this.rotX},a.MaterialLayer.prototype.setRotY=function(a){this.matrix=null,this.rotY=a;return this},a.MaterialLayer.prototype.getRotY=function(){return this.rotY},a.MaterialLayer.prototype.setRotZ=function(a){this.matrix=null,this.rotZ=a;return this},a.MaterialLayer.prototype.getRotZ=function(){return this.rotZ},a.MaterialLayer.prototype.setDRotX=function(a){this.matrix=null,this.dRotX=a;return this},a.MaterialLayer.prototype.getDRotX=function(){return this.dRotX},a.MaterialLayer.prototype.setDRotY=function(a){this.matrix=null,this.dRotY=a;return this},a.MaterialLayer.prototype.getDRotY=function(){return this.dRotY},a.MaterialLayer.prototype.setDRotZ=function(a){this.matrix=null,this.dRotZ=a;return this},a.MaterialLayer.prototype.getDRotZ=function(){return this.dRotZ},a.MaterialLayer.prototype.setBlendMode=function(a){this.blendMode=a,this.fireEvent("shaderupdate",{});return this},a.MaterialLayer.prototype.getBlendMode=function(){return this.blendMode}}(GLGE),function(a){a.MultiMaterial=function(b){a.Assets.registerAsset(this,b);var c=this;this.downloadComplete=function(){c.isComplete()&&c.fireEvent("downloadComplete")},this.lods=[new a.ObjectLod],this.lods[0].addEventListener("downloadComplete",this.downloadComplete)},a.augment(a.QuickNotation,a.MultiMaterial),a.augment(a.JSONLoader,a.MultiMaterial),a.augment(a.Events,a.MultiMaterial),a.MultiMaterial.prototype.className="MultiMaterial",a.MultiMaterial.prototype.isComplete=function(){for(var a=0;a<this.lods.length;a++)if(!this.lods[a].isComplete())return!1;return!0},a.MultiMaterial.prototype.setMesh=function(a){this.lods[0].setMesh(a);return this},a.MultiMaterial.prototype.getMesh=function(){return this.lods[0].getMesh()},a.MultiMaterial.prototype.setMaterial=function(a){this.lods[0].setMaterial(a);return this},a.MultiMaterial.prototype.getMaterial=function(){return this.lods[0].getMaterial()},a.MultiMaterial.prototype.getLOD=function(a){var b=0,c=this.lods[0];if(this.lods.length>1)for(var d=1;d<this.lods.length;d++){var e=this.lods[d].pixelSize;e>b&&e<a&&this.lods[d].mesh&&this.lods[d].mesh.loaded&&(b=e,c=this.lods[d])}return c},a.MultiMaterial.prototype.addObjectLod=function(a){this.lods.push(a),a.addEventListener("downloadComplete",this.downloadComplete);return this},a.MultiMaterial.prototype.updateProgram=function(){for(var a=0;a<this.lods.length;a++)this.lods[a].GLShaderProgram=null;return this},a.MultiMaterial.prototype.removeObjectLod=function(a){var b=this.lods.indexOf(a);lods[b].removeEventListener(this.downloadComplete),b&&this.lods.splice(b,1);return this}}(GLGE),function(a){a.Texture=function(b){a.Assets.registerAsset(this,b)},a.augment(a.QuickNotation,a.Texture),a.augment(a.JSONLoader,a.Texture),a.augment(a.Events,a.Texture),a.Texture.prototype.className="Texture",a.Texture.prototype.image=null,a.Texture.prototype.glTexture=null,a.Texture.prototype.url=null,a.Texture.prototype.state=0,a.Texture.prototype.getSrc=function(){return this.url},a.Texture.prototype.setSrc=function(a){this.url=a,this.state=0,this.image=new Image;var b=this;this.image.onload=function(){b.state=1,b.fireEvent("downloadComplete")},this.image.src=a,this.glTexture&&this.gl&&(this.gl.deleteTexture(this.glTexture),this.glTexture=null);return this},a.Texture.prototype.doTexture=function(a){this.gl=a,this.glTexture||(this.glTexture=a.createTexture()),this.state==1&&(a.bindTexture(a.TEXTURE_2D,this.glTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.image),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),this.state=2),a.bindTexture(a.TEXTURE_2D,this.glTexture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT);return this.state==2?!0:!1},a.Texture.prototype.isComplete=function(){return this.state>0}}(GLGE),function(a){a.TextureCamera=function(b){a.Assets.registerAsset(this,b)},a.augment(a.QuickNotation,a.TextureCamera),a.augment(a.JSONLoader,a.TextureCamera),a.TextureCamera.prototype.className="Texture",a.TextureCamera.prototype.texture=null,a.TextureCamera.prototype.glTexture=null,a.TextureCamera.prototype.object=null,a.TextureCamera.prototype.camera=null,a.TextureCamera.prototype.bufferHeight=0,a.TextureCamera.prototype.bufferWidth=0,a.TextureCamera.prototype.mirrorAxis=a.NONE,a.TextureCamera.prototype.clipAxis=a.NONE,a.TextureCamera.prototype.setBufferWidth=function(a){this.bufferWidth=a,this.update=!0;return this},a.TextureCamera.prototype.getBufferWidth=function(){return this.bufferWidth},a.TextureCamera.prototype.setBufferHeight=function(a){this.bufferHeight=a,this.update=!0;return this},a.TextureCamera.prototype.getBufferHeight=function(){return this.bufferHeight},a.TextureCamera.prototype.setClipAxis=function(a){this.clipAxis=a;return this},a.TextureCamera.prototype.getClipAxis=function(){return this.clipAxis},a.TextureCamera.prototype.setMirrorAxis=function(a){this.mirrorAxis=a;return this},a.TextureCamera.prototype.getMirrorAxis=function(){return this.mirrorAxis},a.TextureCamera.prototype.setCamera=function(a){this.camera=a;return this},a.TextureCamera.prototype.getCamera=function(){return this.camera},a.TextureCamera.prototype.doTexture=function(b,c){if(this.camera){this.gl=b;var d=c.getModelMatrix(),e=b.scene.camera.getProjectionMatrix(),f=this.camera.getViewMatrix(),g;if(this.mirrorAxis)switch(this.mirrorAxis){case a.XAXIS:g=a.mulMat4(a.mulMat4(a.mulMat4(f,d),a.scaleMatrix(-1,1,1)),a.inverseMat4(d));break;case a.YAXIS:g=a.mulMat4(a.mulMat4(a.mulMat4(f,d),a.scaleMatrix(1,-1,1)),a.inverseMat4(d));break;case a.ZAXIS:g=a.mulMat4(a.mulMat4(a.mulMat4(f,d),a.scaleMatrix(1,1,-1)),a.inverseMat4(d))}else g=f;if(this.clipAxis){var h;switch(this.clipAxis){case a.NEG_XAXIS:var i=a.toUnitVec3([-d[0],-d[4],-d[8]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)];break;case a.POS_XAXIS:var i=a.toUnitVec3([d[0],d[4],d[8]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)];break;case a.NEG_YAXIS:var i=a.toUnitVec3([-d[1],-d[5],-d[9]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)];break;case a.POS_YAXIS:var i=a.toUnitVec3([d[1],d[5],d[9]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)];break;case a.NEG_ZAXIS:var i=a.toUnitVec3([-d[2],-d[6],-d[10]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)];break;case a.POS_ZAXIS:var i=a.toUnitVec3([d[2],d[6],d[10]]);h=[i[0],i[1],i[2],-a.dotVec3([d[3],d[7],d[11]],i)]}var j=a.transposeMat4(a.inverseMat4(a.mulMat4(e,g)));h=a.mulMat4Vec4(j,h),h=a.scaleVec4(h,e[10]),h[3]-=1,h[2]<0&&a.scaleVec4(h,-1);var k=[1,0,0,0,0,1,0,0,h[0],h[1],h[2],h[3],0,0,0,1];e=a.mulMat4(k,e)}var l=this.bufferHeight?this.bufferHeight:b.scene.renderer.canvas.height,m=this.bufferWidth?this.bufferWidth:b.scene.renderer.canvas.width;if(!this.glTexture||this.update){this.createFrameBuffer(b),b.scene.addRenderPass(this.frameBuffer,g,b.scene.camera.getProjectionMatrix(),m,l,c),b.bindTexture(b.TEXTURE_2D,this.glTexture),this.update=!1;return!1}b.bindTexture(b.TEXTURE_2D,this.glTexture),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.scene.addRenderPass(this.frameBuffer,g,e,m,l,c);return!0}return!1},a.TextureCamera.prototype.registerPasses=a.TextureCamera.prototype.doTexture,a.TextureCamera.prototype.createFrameBuffer=function(a){var b=this.bufferHeight?this.bufferHeight:a.scene.renderer.canvas.height,c=this.bufferWidth?this.bufferWidth:a.scene.renderer.canvas.width;this.frameBuffer||(this.frameBuffer=a.createFramebuffer()),this.renderBuffer||(this.renderBuffer=a.createRenderbuffer()),this.glTexture||(this.glTexture=a.createTexture()),a.bindTexture(a.TEXTURE_2D,this.glTexture);var d=new Uint8Array(c*b*4);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,b,0,a.RGBA,a.UNSIGNED_BYTE,d),a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.bindRenderbuffer(a.RENDERBUFFER,this.renderBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,c,b),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this.renderBuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.glTexture,0),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null)}}(GLGE),function(a){a.TextureCanvas=function(b){a.Assets.registerAsset(this,b),this.canvas=document.createElement("canvas")},a.augment(a.QuickNotation,a.TextureCanvas),a.augment(a.JSONLoader,a.TextureCanvas),a.TextureCanvas.prototype.className="TextureCanvas",a.TextureCanvas.prototype.glTexture=null,a.TextureCanvas.prototype.autoUpdate=!0,a.TextureCanvas.prototype.getAutoUpdate=function(){return this.autoUpdate},a.TextureCanvas.prototype.setAutoUpdate=function(a){this.autoUpdate=a;return this},a.TextureCanvas.prototype.getCanvas=function(){return this.canvas},a.TextureCanvas.prototype.setCanvas=function(a){this.canvas=a;return this},a.TextureCanvas.prototype.setHeight=function(a){this.canvas.height=a;return this},a.TextureCanvas.prototype.setWidth=function(a){this.canvas.width=a;return this},a.TextureCanvas.prototype.getHeight=function(){return this.canvas.height},a.TextureCanvas.prototype.getWidth=function(){return this.canvas.width},a.TextureCanvas.prototype.doTexture=function(a){this.gl=a,this.glTexture?(a.bindTexture(a.TEXTURE_2D,this.glTexture),(this.autoUpdate||this.doUpdate)&&this.updateCanvas(a)):(this.glTexture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateCanvas(a)),this.doUpdate=!1;return!0},a.TextureCanvas.prototype.update=function(){this.doUpdate=!0},a.TextureCanvas.prototype.updateCanvas=function(a){var b=this.canvas;a.bindTexture(a.TEXTURE_2D,this.glTexture);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)}catch(c){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D)}}(GLGE),function(a){a.TextureCube=function(b){a.Assets.registerAsset(this,b)},a.augment(a.QuickNotation,a.TextureCube),a.augment(a.JSONLoader,a.TextureCube),a.TextureCube.prototype.className="TextureCube",a.TextureCube.prototype.posX=null,a.TextureCube.prototype.negX=null,a.TextureCube.prototype.posY=null,a.TextureCube.prototype.negY=null,a.TextureCube.prototype.posZ=null,a.TextureCube.prototype.negZ=null,a.TextureCube.prototype.texture=null,a.TextureCube.prototype.glTexture=null,a.TextureCube.prototype.loadState=0,a.TextureCube.prototype.setSrc=function(a,b,c){this.url=a,this.state=0,this[b]=new Image;var d=this;this[b].onload=function(){d.loadState+=c},this[b].src=a,this.glTexture&&this.gl&&(this.gl.deleteTexture(this.glTexture),this.glTexture=null);return this},a.TextureCube.prototype.setSrcPosX=function(a){this.setSrc(a,"posX",1);return this},a.TextureCube.prototype.setSrcNegX=function(a){this.setSrc(a,"negX",2);return this},a.TextureCube.prototype.setSrcPosY=function(a){this.setSrc(a,"posY",4);return this},a.TextureCube.prototype.setSrcNegY=function(a){typeof a!="string"?(this.negY=a,this.loadState+=8):this.setSrc(a,"negY",8);return this},a.TextureCube.prototype.setSrcPosZ=function(a){this.setSrc(a,"posZ",16);return this},a.TextureCube.prototype.setSrcNegZ=function(a){this.setSrc(a,"negZ",32);return this},a.TextureCube.prototype.doTexture=function(a,b){this.gl=a,this.glTexture||(this.glTexture=a.createTexture()),a.bindTexture(a.TEXTURE_CUBE_MAP,this.glTexture),this.loadState==63&&this.state==0&&(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posX),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negX),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posY),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negY),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posZ),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negZ),a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null),this.state=1),a.bindTexture(a.TEXTURE_CUBE_MAP,this.glTexture);return this.state==1?!0:!1}}(GLGE),function(a){a.TextureVideo=function(b){a.Assets.registerAsset(this,b),this.video=document.createElement("video"),this.video.style.display="none",this.video.setAttribute("loop","loop"),this.video.autoplay=!0,this.video.addEventListener("ended",function(){this.play()},!0),document.getElementsByTagName("body")[0].appendChild(this.video),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")},a.augment(a.QuickNotation,a.TextureVideo),a.augment(a.JSONLoader,a.TextureVideo),a.TextureVideo.prototype.className="TextureVideo",a.TextureVideo.prototype.glTexture=null,a.TextureVideo.prototype.getVideo=function(){return this.video},a.TextureVideo.prototype.setVideo=function(a){this.video=a;return this},a.TextureVideo.prototype.setSrc=function(a){this.video.src=a;return this},a.TextureVideo.prototype.getSrc=function(a){return this.video.src},a.TextureVideo.prototype.doTexture=function(a){this.gl=a,this.glTexture?(a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateTexture(a)):(this.glTexture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateTexture(a));return!0},a.TextureVideo.prototype.updateTexture=function(a){var b=this.video;a.bindTexture(a.TEXTURE_2D,this.glTexture);if(b.readyState>0){b.height<=0&&(b.style.display="",b.height=b.offsetHeight,b.width=b.offsetWidth,b.style.display="none"),this.canvas.height=b.height,this.canvas.width=b.width,this.ctx.drawImage(b,0,0);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas)}catch(c){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D)}}}(GLGE),function(a){a.ObjectLod=function(b){a.Assets.registerAsset(this,b),this.setMaterial(a.DEFAULT_MATERIAL)},a.augment(a.QuickNotation,a.ObjectLod),a.augment(a.JSONLoader,a.ObjectLod),a.augment(a.Events,a.ObjectLod),a.ObjectLod.prototype.mesh=null,a.ObjectLod.prototype.className="ObjectLod",a.ObjectLod.prototype.material=null,a.ObjectLod.prototype.program=null,a.ObjectLod.prototype.GLShaderProgramPick=null,a.ObjectLod.prototype.GLShaderProgramShadow=null,a.ObjectLod.prototype.GLShaderProgram=null,a.ObjectLod.prototype.pixelSize=0,a.ObjectLod.prototype.setMesh=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.mesh&&this.mesh.removeEventListener("shaderupdate",this.meshupdated);var c=this;this.meshupdated=function(a){c.GLShaderProgram=null},b.addEventListener("shaderupdate",this.meshupdated),this.GLShaderProgram=null,this.mesh=b;return this},a.ObjectLod.prototype.isComplete=function(){return this.material.isComplete()},a.ObjectLod.prototype.getMesh=function(){return this.mesh},a.ObjectLod.prototype.setMaterial=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.material&&(this.material.removeEventListener("shaderupdate",this.materialupdated),this.material.removeEventListener("downloadComplete",this.downloadComplete));var c=this;this.materialupdated=function(a){c.GLShaderProgram=null},b.addEventListener("shaderupdate",this.materialupdated),this.downloadComplete=function(){c.fireEvent("downloadComplete")},b.addEventListener("downloadComplete",this.downloadComplete),this.GLShaderProgram=null,this.material=b;return this},a.ObjectLod.prototype.getMaterial=function(){return this.material},a.ObjectLod.prototype.getPixelSize=function(){return this.pixelSize},a.ObjectLod.prototype.setPixelSize=function(a){this.pixelSize=parseFloat(a)}}(GLGE),function(a){a.Object=function(b){a.Assets.registerAsset(this,b),this.multimaterials=[],this.renderCaches=[];var c=this;this.downloadComplete=function(){c.isComplete()&&c.fireEvent("downloadComplete")}},a.augment(a.Placeable,a.Object),a.augment(a.Animatable,a.Object),a.augment(a.QuickNotation,a.Object),a.augment(a.JSONLoader,a.Object),a.Object.prototype.className="Object",a.Object.prototype.mesh=null,a.Object.prototype.skeleton=null,a.Object.prototype.scene=null,a.Object.prototype.transformMatrix=a.identMatrix(),a.Object.prototype.material=null,a.Object.prototype.gl=null,a.Object.prototype.multimaterials=null,a.Object.prototype.zTrans=!1,a.Object.prototype.renderCaches=null,a.Object.prototype.id="",a.Object.prototype.pickable=!0,a.Object.prototype.drawType=a.DRAW_TRIS,a.Object.prototype.pointSize=1,a.Object.prototype.lineWidth=1,a.Object.prototype.cull=!1;var b=[];b.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),b.push("uniform float distance;\n"),b.push("varying vec3 eyevec;\n"),b.push("void main(void)\n"),b.push("{\n"),b.push("float depth=length(eyevec);\n"),b.push("vec4 rgba=fract(depth/distance * vec4(16777216.0, 65536.0, 256.0, 1.0));\n"),b.push("gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);\n"),b.push("}\n"),a.Object.prototype.shfragStr=b.join("");var c=[];c.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),c.push("varying vec3 n;\n"),c.push("void main(void)\n"),c.push("{\n"),c.push("gl_FragColor=vec4(n,1.0);\n"),c.push("}\n"),a.Object.prototype.nfragStr=c.join("");var d=[];d.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),d.push("uniform float far;\n"),d.push("uniform vec3 pickcolor;\n"),d.push("varying vec3 n;\n"),d.push("varying vec4 UVCoord;\n"),d.push("void main(void)\n"),d.push("{\n"),d.push("float Xcoord = gl_FragCoord.x+0.5;\n"),d.push("if(Xcoord>0.0) gl_FragColor = vec4(pickcolor,1.0);\n"),d.push("if(Xcoord>1.0) gl_FragColor = vec4(n,1.0);\n"),d.push("if(Xcoord>2.0){"),d.push("vec3 rgb=fract((gl_FragCoord.z/gl_FragCoord.w) * vec3(65536.0, 256.0, 1.0));\n"),d.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),d.push("}"),d.push("if(Xcoord>3.0){"),d.push("vec3 rgb=fract(UVCoord.x * vec3(65536.0, 256.0, 1.0));\n"),d.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),d.push("}"),d.push("if(Xcoord>4.0){"),d.push("vec3 rgb=fract(UVCoord.y * vec3(65536.0, 256.0, 1.0));\n"),d.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),d.push("}"),d.push("}\n"),a.Object.prototype.pkfragStr=d.join(""),a.Object.prototype.getPickable=function(){return this.pickable},a.Object.prototype.setPickable=function(a){this.pickable=a;return this},a.Object.prototype.getCull=function(){return this.cull},a.Object.prototype.setCull=function(a){this.cull=a;return this},a.Object.prototype.getDrawType=function(){return this.drawType},a.Object.prototype.setDrawType=function(a){this.drawType=a;return this},a.Object.prototype.getPointSize=function(){return this.pointSize},a.Object.prototype.setPointSize=function(a){this.pointSize=parseFloat(a);return this},a.Object.prototype.getLineWidth=function(){return this.lineWidth},a.Object.prototype.setLineWidth=function(a){this.lineWidth=parseFloat(a);return this},a.Object.prototype.setUniform=function(a,b,c){this.uniforms||(this.uniforms={}),this.uniforms[b]={type:a,value:c}},a.Object.prototype.getUniform=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].value},a.Object.prototype.getUniformType=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].type},a.Object.prototype.setVertexShaderInjection=function(a){this.shaderVertexInjection=a,this.updateProgram();return this},a.Object.prototype.getVertexShaderInjection=function(a){return this.shaderVertexInjection},a.Object.prototype.getSkeleton=function(){return this.skeleton},a.Object.prototype.setSkeleton=function(a){this.skeleton=a,this.bones=null;return this},a.Object.prototype.getBoundingVolume=function(b){b||(b=0),this.boundingVolume||(this.boundingVolume=[]),this.boundmatrix||(this.boundmatrix=[]);var c=this.getModelMatrix();if(c!=this.boundmatrix[b]||!this.boundingVolume[b]){var d=this.multimaterials,e;for(var f=0;f<d.length;f++)d[f].lods[0].mesh&&(e?e.addBoundingVolume(d[f].lods[0].mesh.getBoundingVolume()):e=d[f].lods[0].mesh.getBoundingVolume().clone());e||(e=new a.BoundingVolume(0,0,0,0,0,0)),b?e.applyMatrix(this.getLocalMatrix()):e.applyMatrix(this.getModelMatrix()),this.boundingVolume[b]=e}this.boundmatrix[b]=c;return this.boundingVolume[b]},a.Object.prototype.setZtransparent=function(a){this.zTrans=a;return this},a.Object.prototype.isZtransparent=function(){return this.zTrans},a.Object.prototype.isComplete=function(){for(var a=0;a<this.multimaterials.length;a++)if(!this.multimaterials[a].isComplete())return!1;return!0},a.Object.prototype.setMaterial=function(b,c){typeof b=="string"&&(b=a.Assets.get(b)),c||(c=0),this.multimaterials[c]||(this.multimaterials[c]=new a.MultiMaterial,this.multimaterials[c].addEventListener("downloadComplete",this.downloadComplete)),this.multimaterials[c].getMaterial()!=b&&(this.multimaterials[c].setMaterial(b),this.updateProgram());return this},a.Object.prototype.getMaterial=function(a){a||(a=0);return this.multimaterials[a]?this.multimaterials[a].getMaterial():!1},a.Object.prototype.setMesh=function(b,c){typeof b=="string"&&(b=a.Assets.get(b)),c||(c=0),this.multimaterials[c]||(this.multimaterials[c]=new a.MultiMaterial,this.multimaterials[c].addEventListener("downloadComplete",this.downloadComplete)),this.multimaterials[c].setMesh(b),this.boundingVolume=null;return this},a.Object.prototype.getMesh=function(a){a||(a=0);return this.multimaterials[a]?this.multimaterials[a].getMesh():!1},a.Object.prototype.GLInit=function(a){this.gl=a},a.Object.prototype.GLDestory=function(a){},a.Object.prototype.updateProgram=function(){for(var a=0;a<this.multimaterials.length;a++)this.multimaterials[a].updateProgram()},a.Object.prototype.addMultiMaterial=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.multimaterials.push(b),b.addEventListener("downloadComplete",this.downloadComplete),this.boundingVolume=null;return this},a.Object.prototype.getMultiMaterials=function(){return this.multimaterials},a.Object.prototype.GLGenerateShader=function(b){var c=joints1=joints2=!1,d=b.lights,e=[],f=!1;this.mesh.normals||this.mesh.calcNormals();for(var g=0;g<this.mesh.buffers.length;g++)this.mesh.buffers[g].name=="tangent"&&(f=!0),this.mesh.buffers[g].size>1?e.push("attribute vec"+this.mesh.buffers[g].size+" "+this.mesh.buffers[g].name+";\n"):e.push("attribute float "+this.mesh.buffers[g].name+";\n"),this.mesh.buffers[g].name=="UV"&&(c=!0),this.mesh.buffers[g].name=="joints1"&&(joints1=this.mesh.buffers[g]),this.mesh.buffers[g].name=="joints2"&&(joints2=this.mesh.buffers[g]);e.push("uniform mat4 worldView;\n"),e.push("uniform mat4 projection;\n"),e.push("uniform mat4 worldInverseTranspose;\n"),e.push("uniform mat4 envMat;\n");for(var g=0;g<d.length;g++)e.push("uniform vec3 lightpos"+g+";\n"),e.push("uniform vec3 lightdir"+g+";\n"),d[g].type==a.L_SPOT&&(e.push("uniform mat4 lightmat"+g+";\n"),e.push("varying vec4 spotcoord"+g+";\n"));e.push("varying vec3 eyevec;\n");for(var g=0;g<d.length;g++)e.push("varying vec3 lightvec"+g+";\n"),e.push("varying float lightdist"+g+";\n");this.mesh.joints&&this.mesh.joints.length>0&&e.push("uniform vec4 jointMat["+3*this.mesh.joints.length+"];\n"),this.material&&e.push(this.material.getVertexVarying(e)),e.push("varying vec3 n;\n"),e.push("varying vec3 t;\n"),e.push("varying vec4 UVCoord;\n"),e.push("varying vec3 OBJCoord;\n"),this.shaderVertexInjection&&e.push(this.shaderVertexInjection),e.push("void main(void)\n"),e.push("{\n"),c?e.push("UVCoord=UV;\n"):e.push("UVCoord=vec4(0.0,0.0,0.0,0.0);\n"),e.push("OBJCoord = position;\n"),e.push("vec3 tang;\n"),e.push("vec4 pos = vec4(0.0, 0.0, 0.0, 1.0);\n"),e.push("vec4 norm = vec4(0.0, 0.0, 0.0, 1.0);\n"),f&&e.push("vec4 tang4 = vec4(0.0, 0.0, 0.0, 1.0);\n");if(joints1){if(joints1.size==1)e.push("pos += vec4(dot(jointMat[int(3.0*joints1)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+2.0)],vec4(position,1.0)),1.0)*weights1;\n"),e.push("norm += vec4(dot(jointMat[int(3.0*joints1)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,normal),1.0)*weights1;\n"),f&&e.push("tang4 += vec4(dot(jointMat[int(3.0*joints1)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,tangent),1.0)*weights1;\n");else for(var g=0;g<joints1.size;g++)e.push("pos += vec4(dot(jointMat[int(3.0*joints1["+g+"])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1["+g+"]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1["+g+"]+2.0)],vec4(position,1.0)),1.0)*weights1["+g+"];\n"),e.push("norm += vec4(dot(jointMat[int(3.0*joints1["+g+"])].xyz,normal),\n               dot(jointMat[int(3.0*joints1["+g+"]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1["+g+"]+2.0)].xyz,normal),1.0)*weights1["+g+"];\n"),f&&e.push("tang4 += vec4(dot(jointMat[int(3.0*joints1["+g+"])].xyz,tangent),\n               dot(jointMat[int(3.0*joints1["+g+"]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1["+g+"]+2.0)].xyz,tangent),1.0)*weights1["+g+"];\n");if(joints2)if(joints2.size==1)e.push("pos += vec4(dot(jointMat[int(3.0*joints2)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+2.0)],vec4(position,1.0)),1.0)*weights2;\n"),e.push("norm += vec4(dot(jointMat[int(3.0*joints2)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,normal),1.0)*weights2;\n"),f&&e.push("tang4 += vec4(dot(jointMat[int(3.0*joints2)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,tangent),1.0)*weights2;\n");else for(var g=0;g<joints2.size;g++)e.push("pos += vec4(dot(jointMat[int(3.0*joints2["+g+"])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2["+g+"]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2["+g+"]+2.0)],vec4(position,1.0)),1.0)*weights2["+g+"];\n"),e.push("norm += vec4(dot(jointMat[int(3.0*joints2["+g+"])].xyz,normal),\n               dot(jointMat[int(3.0*joints2["+g+"]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2["+g+"]+2.0)].xyz,normal),1.0)*weights2["+g+"];\n"),f&&e.push("tang4 += vec4(dot(jointMat[int(3.0*joints2["+g+"])].xyz,tangent),\n               dot(jointMat[int(3.0*joints2["+g+"]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2["+g+"]+2.0)].xyz,tangent),1.0)*weights2["+g+"];\n");for(var g=0;g<d.length;g++)d[g].type==a.L_SPOT&&e.push("spotcoord"+g+"=lightmat"+g+"*vec4(pos.xyz,1.0);\n");this.shaderVertexInjection&&e.push("pos=GLGE_Position(vec4(pos.xyz, 1.0));\n"),e.push("pos = worldView * vec4(pos.xyz, 1.0);\n"),e.push("norm = worldInverseTranspose * vec4(norm.xyz, 1.0);\n"),f&&e.push("tang = (worldInverseTranspose*vec4(tang4.xyz,1.0)).xyz;\n")}else{e.push("vec4 pos4=vec4(position,1.0);\n");for(var g=0;g<d.length;g++)d[g].type==a.L_SPOT&&e.push("spotcoord"+g+"=lightmat"+g+"*pos4;\n");this.shaderVertexInjection&&e.push("pos4=GLGE_Position(pos4);\n"),e.push("pos = worldView * pos4;\n"),e.push("norm = worldInverseTranspose * vec4(normal, 1.0);\n"),f&&e.push("tang = (worldInverseTranspose*vec4(tangent,1.0)).xyz;\n")}e.push("gl_Position = projection * pos;\n"),e.push("gl_PointSize="+this.pointSize.toFixed(5)+";\n"),e.push("eyevec = -pos.xyz;\n"),f?e.push("t = normalize(tang);"):e.push("t = vec3(0.0,0.0,0.0);"),e.push("n = norm.rgb;");for(var g=0;g<d.length;g++)d[g].getType()==a.L_DIR?e.push("lightvec"+g+" = -lightdir"+g+";\n"):e.push("lightvec"+g+" = pos.xyz-lightpos"+g+";\n"),e.push("lightdist"+g+" = length(lightpos"+g+".xyz-pos.xyz);\n");this.material&&e.push(this.material.getLayerCoords(e)),e.push("}\n"),e=e.join(""),fragStr=this.material.getFragmentShader(d),this.GLFragmentShaderNormal=a.getGLShader(b,b.FRAGMENT_SHADER,this.nfragStr),this.GLFragmentShaderShadow=a.getGLShader(b,b.FRAGMENT_SHADER,this.shfragStr),this.GLFragmentShaderPick=a.getGLShader(b,b.FRAGMENT_SHADER,this.pkfragStr),this.GLFragmentShader=a.getGLShader(b,b.FRAGMENT_SHADER,fragStr),this.GLVertexShader=a.getGLShader(b,b.VERTEX_SHADER,e),this.GLVertexShaderShadow=a.getGLShader(b,b.VERTEX_SHADER,e+"\n"),this.GLVertexShaderPick=a.getGLShader(b,b.VERTEX_SHADER,e+"\n\n"),this.GLVertexShaderNormal=a.getGLShader(b,b.VERTEX_SHADER,e+"\n\n\n"),this.GLShaderProgramPick=a.getGLProgram(b,this.GLVertexShaderPick,this.GLFragmentShaderPick),this.GLShaderProgramNormal=a.getGLProgram(b,this.GLVertexShaderNormal,this.GLFragmentShaderNormal),this.GLShaderProgramShadow=a.getGLProgram(b,this.GLVertexShaderShadow,this.GLFragmentShaderShadow),this.GLShaderProgram=a.getGLProgram(b,this.GLVertexShader,this.GLFragmentShader)},a.Object.prototype.createShaders=function(a){this.gl&&(this.mesh=a.mesh,this.material=a.material,this.GLGenerateShader(this.gl),a.GLShaderProgramPick=this.GLShaderProgramPick,a.GLShaderProgramShadow=this.GLShaderProgramShadow,a.GLShaderProgram=this.GLShaderProgram)},a.Object.prototype.GLUniforms=function(b,c,d){var e;switch(c){case a.RENDER_DEFAULT:e=this.GLShaderProgram,a.setUniform(b,"1i",a.getUniformLocation(b,e,"emitpass"),0);break;case a.RENDER_EMIT:e=this.GLShaderProgram,a.setUniform(b,"1i",a.getUniformLocation(b,e,"emitpass"),1);break;case a.RENDER_SHADOW:e=this.GLShaderProgramShadow;break;case a.RENDER_NORMAL:e=this.GLShaderProgramNormal;break;case a.RENDER_PICK:e=this.GLShaderProgramPick;var f=d>>16&255,g=d>>8&255,h=d&255;a.setUniform3(b,"3f",a.getUniformLocation(b,e,"pickcolor"),h/255,g/255,f/255)}b.lineWidth(this.lineWidth);for(key in this.uniforms){var i=this.uniforms[key];i.type=="Matrix4fv"?a.setUniformMatrix(b,"Matrix4fv",a.getUniformLocation(b,e,key),!1,i.value):a.setUniform(b,i.type,a.getUniformLocation(b,e,key),i.value)}e.caches||(e.caches={}),e.glarrays||(e.glarrays={});var j=e.caches,k=e.glarrays,l=b.scene,m=l.camera;j.far!=m.far&&(a.setUniform(b,"1i",a.getUniformLocation(b,e,"far"),m.far),j.far=m.far);if(c==a.RENDER_DEFAULT||c==a.RENDER_EMIT){if(j.ambientColor!=l.ambientColor){var n=l.ambientColor;a.setUniform3(b,"3f",a.getUniformLocation(b,e,"amb"),n.r,n.g,n.b),j.ambientColor=n}j.fogFar!=l.fogFar&&(a.setUniform(b,"1f",a.getUniformLocation(b,e,"fogfar"),l.fogFar),j.fogFar=l.fogFar),j.fogNear!=l.fogNear&&(a.setUniform(b,"1f",a.getUniformLocation(b,e,"fognear"),l.fogNear),j.fogNear=l.fogNear),j.fogType!=l.fogType&&(a.setUniform(b,"1i",a.getUniformLocation(b,e,"fogtype"),l.fogType),j.fogType=l.fogType),j.fogType!=l.fogcolor&&(a.setUniform3(b,"3f",a.getUniformLocation(b,e,"fogcolor"),l.fogColor.r,l.fogColor.g,l.fogColor.b),j.fogcolor=l.fogcolor)}var o=m.getViewMatrix(),p=this.getModelMatrix();j.mvMatrix||(j.mvMatrix={cameraMatrix:null,modelMatrix:null});var q=j.mvMatrix;if(q.camerMatrix!=o||q.modelMatrix!=p){this.caches.mvMatrix||(this.caches.mvMatrix=a.mulMat4(o,p)),mvMatrix=this.caches.mvMatrix,this.mesh.joints&&(mvMatrix=o);var r=a.getUniformLocation(b,e,"worldView");k.mvMatrix?a.mat4gl(a.transposeMat4(mvMatrix),k.mvMatrixT):k.mvMatrixT=new Float32Array(a.transposeMat4(mvMatrix)),k.mvMatrix=mvMatrix,a.setUniformMatrix(b,"Matrix4fv",r,!1,e.glarrays.mvMatrixT);var s=a.getUniformLocation(b,e,"envMat");if(s){if(!this.caches.envMat){var t=a.inverseMat4(mvMatrix);t[3]=0,t[7]=0,t[11]=0,this.caches.envMat=t}t=this.caches.envMat,e.glarrays.envMat?a.mat4gl(a.transposeMat4(t),k.envMatT):k.envMatT=new Float32Array(a.transposeMat4(t)),k.envMat=t,a.setUniformMatrix(b,"Matrix4fv",s,!1,k.envMatT)}if(!this.caches.normalMatrix){var u=a.inverseMat4(mvMatrix);this.caches.normalMatrix=u}u=this.caches.normalMatrix;var v=a.getUniformLocation(b,e,"worldInverseTranspose");k.normalMatrix?a.mat4gl(u,k.normalMatrix):k.normalMatrix=new Float32Array(u),a.setUniformMatrix(b,"Matrix4fv",v,!1,k.normalMatrix);var w=a.getUniformLocation(b,e,"view");k.cameraMatrix?a.mat4gl(a.transposeMat4(o),k.cameraMatrixT):k.cameraMatrixT=new Float32Array(a.transposeMat4(o)),k.cameraMatrix=o,a.setUniformMatrix(b,"Matrix4fv",w,!1,k.cameraMatrixT),q.camerMatrix=o,q.modelMatrix=p}var x=a.getUniformLocation(b,e,"projection");k.pMatrix?a.mat4gl(a.transposeMat4(m.getProjectionMatrix()),k.pMatrixT):k.pMatrixT=new Float32Array(a.transposeMat4(m.getProjectionMatrix())),k.pMatrix=m.getProjectionMatrix(),a.setUniformMatrix(b,"Matrix4fv",x,!1,k.pMatrixT);if(c==a.RENDER_DEFAULT||c==a.RENDER_SHADOW||c==a.RENDER_EMIT){var y,z,A=b.lights;j.lights||(j.lights=[]),k.lights||(k.lights=[]),this.caches.lights||(this.caches.lights=[]);var B=j.lights;for(var C=0;C<A.length;C++){B[C]||(B[C]={modelMatrix:null,cameraMatrix:null});if(B[C].modelMatrix!=p||B[C].cameraMatrix!=o){this.caches.lights[C]||(this.caches.lights[C]={}),this.caches.lights[C].pos||(this.caches.lights[C].pos=a.mulMat4Vec4(a.mulMat4(o,A[C].getModelMatrix()),[0,0,0,1])),y=this.caches.lights[C].pos,a.setUniform3(b,"3f",a.getUniformLocation(b,e,"lightpos"+C),y[0],y[1],y[2]),this.caches.lights[C].lpos||(this.caches.lights[C].lpos=a.mulMat4Vec4(a.mulMat4(o,A[C].getModelMatrix()),[0,0,1,1])),z=this.caches.lights[C].lpos,a.setUniform3(b,"3f",a.getUniformLocation(b,e,"lightdir"+C),z[0]-y[0],z[1]-y[1],z[2]-y[2]);if(A[C].s_cache){var D=a.mulMat4(A[C].s_cache.smatrix,p);k.lights[C]?a.mat4gl(D,k.lights[C]):k.lights[C]=new Float32Array(D),a.setUniformMatrix(b,"Matrix4fv",a.getUniformLocation(b,e,"lightmat"+C),!0,k.lights[C]),B[C].modelMatrix=p,B[C].cameraMatrix=o}else B[C].modelMatrix=p,B[C].cameraMatrix=o}}}if(this.mesh.joints){j.joints||(j.joints=[]),k.joints||(k.joints=[]),k.jointsT||(k.jointsT=[]),k.jointsinv||(k.jointsinv=[]);if(!k.jointsCombined||k.jointsCombined.length!=this.mesh.joints.length*12)k.jointsCombined=new Float32Array(this.mesh.joints.length*12);var E=j.joints,F=a.identMatrix();for(C=0;C<this.mesh.joints.length;C++){E[C]||(E[C]={modelMatrix:null,invBind:null});if(typeof this.mesh.joints[C]=="string"){this.bones||(this.bones=this.skeleton.getNames());if(this.bones)var p=this.bones[this.mesh.joints[C]].getModelMatrix()}else var p=this.mesh.joints[C].getModelMatrix();var G=this.mesh.invBind[C];if(E[C].modelMatrix!=p||E[C].invBind!=G){var H=a.mulMat4(p,G);k.joints[C]?a.mat4gl(a.transposeMat4(H),k.jointsT[C]):k.jointsT[C]=new Float32Array(a.transposeMat4(H)),k.joints[C]=H,k.jointsinv[C]?a.mat4gl(a.inverseMat4(H),k.jointsinv[C]):k.jointsinv[C]=new Float32Array(a.inverseMat4(H));var I=k.jointsT[C],J=k.jointsCombined;J[C*12]=I[0],J[C*12+1]=I[4],J[C*12+2]=I[8],J[C*12+3]=I[12],J[C*12+4]=I[1],J[C*12+5]=I[5],J[C*12+6]=I[9],J[C*12+7]=I[13],J[C*12+8]=I[2],J[C*12+9]=I[6],J[C*12+10]=I[10],J[C*12+11]=I[14],E[C].modelMatrix=p,E[C].invBind=G}}b.uniform4fv(a.getUniformLocation(b,e,"jointMat"),k.jointsCombined)}this.material&&(c==a.RENDER_DEFAULT||c==a.RENDER_EMIT)&&b.scene.lastMaterial!=this.material&&(this.material.textureUniforms(b,e,A,this),b.scene.lastMaterial=this.material)},a.Object.prototype.GLRender=function(b,c,d,e,f){if(b){this.gl||this.GLInit(b),this.lookAt&&this.Lookat(this.lookAt),c==a.RENDER_DEFAULT&&(this.animation&&this.animate()),this.renderCaches[c]||(this.renderCaches[c]={});var g=b.scene.camera.getViewMatrix(),h=this.getModelMatrix();if(this.renderCaches[c].camerMatrix!=g||this.renderCaches[c].modelMatrix!=h)this.renderCaches[c]={},this.renderCaches[c].camerMatrix=g,this.renderCaches[c].modelMatrix=h;this.caches=this.renderCaches[c];var i;if(e==undefined)var j=0,k=this.multimaterials.length;else var j=e,k=e+1;for(var l=j;l<k;l++){if(this.multimaterials[l].lods.length>1&&!i){var m=b.scene.camera.getPosition(),n=this.getPosition(),o=a.lengthVec3([m.x-n.x,m.y-n.y,m.z-n.z]);o=a.mulMat4Vec4(b.scene.camera.getProjectionMatrix(),[this.getBoundingVolume().getSphereRadius(),0,-o,1]),i=o[0]/o[3]*b.scene.renderer.canvas.width}var p=this.multimaterials[l].getLOD(i);if(p.mesh&&p.mesh.loaded){if(c==a.RENDER_NULL){p.material&&p.material.registerPasses(b,this);break}p.GLShaderProgram?(this.GLShaderProgramPick=p.GLShaderProgramPick,this.GLShaderProgramShadow=p.GLShaderProgramShadow,this.GLShaderProgram=p.GLShaderProgram):this.createShaders(p),this.mesh=p.mesh,this.material=p.material;var q;switch(this.drawType){case a.DRAW_LINES:q=b.LINES;break;case a.DRAW_POINTS:q=b.POINTS;break;case a.DRAW_LINELOOPS:q=b.LINE_LOOP;break;case a.DRAW_LINESTRIPS:q=b.LINE_STRIP;break;default:q=b.TRIANGLES}switch(c){case a.RENDER_DEFAULT:case a.RENDER_EMIT:b.program!=this.GLShaderProgram&&(b.useProgram(this.GLShaderProgram),b.program=this.GLShaderProgram),this.mesh.GLAttributes(b,this.GLShaderProgram);break;case a.RENDER_SHADOW:b.program!=this.GLShaderProgramShadow&&(b.useProgram(this.GLShaderProgramShadow),b.program=this.GLShaderProgramShadow),f||(f=b.scene.camera.getFar()),a.setUniform(b,"1f",a.getUniformLocation(b,this.GLShaderProgramShadow,"distance"),f),this.mesh.GLAttributes(b,this.GLShaderProgramShadow);break;case a.RENDER_NORMAL:b.program!=this.GLShaderProgramNormal&&(b.useProgram(this.GLShaderProgramNormal),b.program=this.GLShaderProgramNormal),this.mesh.GLAttributes(b,this.GLShaderProgramNormal);break;case a.RENDER_PICK:b.program!=this.GLShaderProgramPick&&(b.useProgram(this.GLShaderProgramPick),b.program=this.GLShaderProgramPick),this.mesh.GLAttributes(b,this.GLShaderProgramPick),q=b.TRIANGLES}this.GLUniforms(b,c,d);switch(this.mesh.windingOrder){case a.Mesh.WINDING_ORDER_UNKNOWN:b.disable(b.CULL_FACE);break;case a.Mesh.WINDING_ORDER_COUNTER:b.cullFace(b.FRONT);default:}this.mesh.GLfaces?(b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.mesh.GLfaces),b.drawElements(q,this.mesh.GLfaces.numItems,b.UNSIGNED_SHORT,0)):b.drawArrays(q,0,this.mesh.positions.length/3);switch(this.mesh.windingOrder){case a.Mesh.WINDING_ORDER_UNKNOWN:b.scene.renderer.cullFaces&&b.enable(b.CULL_FACE);break;case a.Mesh.WINDING_ORDER_COUNTER:b.cullFace(b.BACK);default:}var r=this.matrix,s=this.caches;this.matrix=r,this.caches=s}}}}}(GLGE),function(a){a.Text=function(b){a.Assets.registerAsset(this,b),this.canvas=document.createElement("canvas"),this.color={r:1,g:1,b:1}},a.augment(a.Placeable,a.Text),a.augment(a.Animatable,a.Text),a.augment(a.QuickNotation,a.Text),a.augment(a.JSONLoader,a.Text),a.Text.prototype.className="Text",a.Text.prototype.zTrans=!0,a.Text.prototype.canvas=null,a.Text.prototype.aspect=1,a.Text.prototype.color=null,a.Text.prototype.text="",a.Text.prototype.font="Times",a.Text.prototype.size=100,a.Text.prototype.pickType=a.TEXT_TEXTPICK,a.Text.prototype.getPickType=function(){return this.pickType},a.Text.prototype.setPickType=function(a){this.pickType=a;return this},a.Text.prototype.getFont=function(){return this.size},a.Text.prototype.setFont=function(a){this.font=a,this.gl&&this.updateCanvas(this.gl);return this},a.Text.prototype.getSize=function(){return this.size},a.Text.prototype.setSize=function(a){this.size=a,this.gl&&this.updateCanvas(this.gl);return this},a.Text.prototype.getText=function(){return this.text},a.Text.prototype.setText=function(a){this.text=a,this.gl&&this.updateCanvas(this.gl);return this},a.Text.prototype.setColor=function(b){b=a.colorParse(b),this.color={r:b.r,g:b.g,b:b.b};return this},a.Text.prototype.setColorR=function(a){this.color.r=a;return this},a.Text.prototype.setColorG=function(a){this.color.g=a;return this},a.Text.prototype.setColorB=function(a){this.color.b=a;return this},a.Text.prototype.getColor=function(){return this.color},a.Text.prototype.setZtransparent=function(a){this.zTrans=a;return this},a.Text.prototype.isZtransparent=function(){return this.zTrans},a.Text.prototype.GLGenerateShader=function(b){this.GLShaderProgram&&b.deleteProgram(this.GLShaderProgram);var c="";c+="attribute vec3 position;\n",c+="attribute vec2 uvcoord;\n",c+="varying vec2 texcoord;\n",c+="uniform mat4 Matrix;\n",c+="uniform mat4 PMatrix;\n",c+="varying vec4 pos;\n",c+="void main(void){\n",c+="texcoord=uvcoord;\n",c+="pos = Matrix * vec4(position,1.0);\n",c+="gl_Position = PMatrix * pos;\n",c+="}\n";var d="#ifdef GL_ES\nprecision highp float;\n#endif\n";d=d+"uniform sampler2D TEXTURE;\n",d=d+"varying vec2 texcoord;\n",d=d+"varying vec4 pos;\n",d=d+"uniform float far;\n",d=d+"uniform int picktype;\n",d=d+"uniform vec3 pickcolor;\n",d=d+"uniform vec3 color;\n",d=d+"void main(void){\n",d=d+"float alpha=texture2D(TEXTURE,texcoord).a;\n",d=d+"if(picktype=="+a.TEXT_BOXPICK+"){gl_FragColor = vec4(pickcolor,1.0);}",d=d+"else if(picktype=="+a.TEXT_TEXTPICK+"){gl_FragColor = vec4(pickcolor,alpha);}",d=d+"else{gl_FragColor = vec4(color.rgb*alpha,alpha);};\n",d=d+"}\n",this.GLFragmentShader=b.createShader(b.FRAGMENT_SHADER),this.GLVertexShader=b.createShader(b.VERTEX_SHADER),b.shaderSource(this.GLFragmentShader,d),b.compileShader(this.GLFragmentShader);if(b.getShaderParameter(this.GLFragmentShader,b.COMPILE_STATUS)){b.shaderSource(this.GLVertexShader,c),b.compileShader(this.GLVertexShader);if(!b.getShaderParameter(this.GLVertexShader,b.COMPILE_STATUS)){a.error(b.getShaderInfoLog(this.GLVertexShader));return}this.GLShaderProgram=b.createProgram(),b.attachShader(this.GLShaderProgram,this.GLVertexShader),b.attachShader(this.GLShaderProgram,this.GLFragmentShader),b.linkProgram(this.GLShaderProgram)}else a.error(b.getShaderInfoLog(this.GLFragmentShader))},a.Text.prototype.GLInit=function(a){this.gl=a,this.createPlane(a),this.GLGenerateShader(a),this.glTexture=a.createTexture(),this.updateCanvas(a)},a.Text.prototype.updateCanvas=function(a){var b=this.canvas;b.width=1,b.height=this.size*1.2;var c=b.getContext("2d");c.font=this.size+"px "+this.font,b.width=c.measureText(this.text).width,b.height=this.size*1.2,c=b.getContext("2d"),c.textBaseline="top",c.font=this.size+"px "+this.font,this.aspect=b.width/b.height,c.fillText(this.text,0,0),a.bindTexture(a.TEXTURE_2D,this.glTexture);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)}catch(d){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null)},a.Text.prototype.GLRender=function(b,c,d){this.gl||this.GLInit(b);if(c==a.RENDER_DEFAULT||c==a.RENDER_PICK){this.lookAt&&this.Lookat(this.lookAt),b.program!=this.GLShaderProgram&&(b.useProgram(this.GLShaderProgram),b.program=this.GLShaderProgram);var e;for(var f=0;f<8;f++)b.disableVertexAttribArray(f);e=a.getAttribLocation(b,this.GLShaderProgram,"position"),b.bindBuffer(b.ARRAY_BUFFER,this.posBuffer),b.enableVertexAttribArray(e),b.vertexAttribPointer(e,this.posBuffer.itemSize,b.FLOAT,!1,0,0),e=a.getAttribLocation(b,this.GLShaderProgram,"uvcoord"),b.bindBuffer(b.ARRAY_BUFFER,this.uvBuffer),b.enableVertexAttribArray(e),b.vertexAttribPointer(e,this.uvBuffer.itemSize,b.FLOAT,!1,0,0),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.glTexture),a.setUniform(b,"1i",a.getUniformLocation(b,this.GLShaderProgram,"TEXTURE"),0),d||(d=0);var g=d>>16&255,h=d>>8&255,i=d&255;a.setUniform3(b,"3f",a.getUniformLocation(b,this.GLShaderProgram,"pickcolor"),i/255,h/255,g/255),c==a.RENDER_PICK?a.setUniform(b,"1i",a.getUniformLocation(b,this.GLShaderProgram,"picktype"),this.pickType):a.setUniform(b,"1i",a.getUniformLocation(b,this.GLShaderProgram,"picktype"),0),this.GLShaderProgram.glarrays||(this.GLShaderProgram.glarrays={});var j=this.size/100,k=a.mulMat4(b.scene.camera.getViewMatrix(),a.mulMat4(this.getModelMatrix(),a.scaleMatrix(this.aspect*j,j,j))),l=a.getUniformLocation(b,this.GLShaderProgram,"Matrix");this.GLShaderProgram.glarrays.mMatrix?a.mat4gl(k,this.GLShaderProgram.glarrays.mMatrix):this.GLShaderProgram.glarrays.mMatrix=new Float32Array(k),a.setUniformMatrix(b,"Matrix4fv",l,!0,this.GLShaderProgram.glarrays.mMatrix);var l=a.getUniformLocation(b,this.GLShaderProgram,"PMatrix");this.GLShaderProgram.glarrays.pMatrix?a.mat4gl(b.scene.camera.getProjectionMatrix(),this.GLShaderProgram.glarrays.pMatrix):this.GLShaderProgram.glarrays.pMatrix=new Float32Array(b.scene.camera.getProjectionMatrix()),a.setUniformMatrix(b,"Matrix4fv",l,!0,this.GLShaderProgram.glarrays.pMatrix);var m=a.getUniformLocation(b,this.GLShaderProgram,"far");a.setUniform(b,"1f",m,b.scene.camera.getFar()),a.setUniform3(b,"3f",a.getUniformLocation(b,this.GLShaderProgram,"color"),this.color.r,this.color.g,this.color.b),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.GLfaces),b.drawElements(b.TRIANGLES,this.GLfaces.numItems,b.UNSIGNED_SHORT,0),b.scene.lastMaterial=null}},a.Text.prototype.createPlane=function(a){this.posBuffer||(this.posBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.posBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),a.STATIC_DRAW),this.posBuffer.itemSize=3,this.posBuffer.numItems=4,this.uvBuffer||(this.uvBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),a.STATIC_DRAW),this.uvBuffer.itemSize=2,this.uvBuffer.numItems=4,this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=6}}(GLGE),function(a){a.Renderer=function(b,c){this.viewport=[],this.canvas=b;try{this.gl=b.getContext("experimental-webgl",{alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!0})}catch(d){}if(!this.gl){console.log("GLGE err:",typeof globalNoWebGLError=="undefined");if(c||typeof globalNoWebGLError!="undefined"){c();throw"cannot create webgl context"}var e=document.createElement("div");e.setAttribute("style","position: absolute; top: 10px; left: 10px; font-family: sans-serif; font-size: 14px; padding: 10px;background-color: #fcffcb;color: #800; width: 200px; border:2px solid #f00"),e.innerHTML="Cannot detect webgl please download a compatible browser",document.getElementsByTagName("body")[0].appendChild(e);throw"cannot create webgl context"}try{this.gl.canvas=b}catch(d){}this.gl.getProgramParameter||(this.gl.getProgramParameter=this.gl.getProgrami),this.gl.getShaderParameter||(this.gl.getShaderParameter=this.gl.getShaderi),this.gl.uniformMatrix4fvX=this.gl.uniformMatrix4fv,this.gl.uniformMatrix4fv=function(b,c,d){c?(a.mat4gl(a.transposeMat4(d),d),this.uniformMatrix4fvX(b,!1,d)):this.uniformMatrix4fvX(b,!1,d)};var f=this.gl;this.gl.clearDepth(1),this.gl.clearStencil(0),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ZERO,this.gl.ONE)},a.augment(a.QuickNotation,a.Renderer),a.Renderer.prototype.gl=null,a.Renderer.prototype.scene=null,a.C_STENCIL=1,a.C_DEPTH=2,a.C_COLOR=4,a.C_ALL=7,a.Renderer.prototype.clearType=a.C_ALL,a.Renderer.prototype.setViewportWidth=function(a){this.viewport[0]=a;return this},a.Renderer.prototype.setViewportHeight=function(a){this.viewport[1]=a;return this},a.Renderer.prototype.setViewportOffsetX=function(a){this.viewport[2]=a;return this},a.Renderer.prototype.setViewportOffsetY=function(a){this.viewport[3]=a;return this},a.Renderer.prototype.clearViewport=function(){this.viewport=[]},a.Renderer.prototype.getViewportWidth=function(){return this.viewport.length>0?this.viewport[0]:this.canvas.width},a.Renderer.prototype.getViewportHeight=function(){return this.viewport.length>0?this.viewport[1]:this.canvas.height},a.Renderer.prototype.getViewportOffsetX=function(){return this.viewport.length>0?this.viewport[2]:0},a.Renderer.prototype.getViewportOffsetY=function(){return this.viewport.length>0?this.viewport[3]:0},a.Renderer.prototype.setClearType=function(a){this.clearType=a;return this},a.Renderer.prototype.getClearType=function(){return this.clearType},a.Renderer.prototype.GLClear=function(){var b=this.gl,c=this.clearType,d=0;c&a.C_COLOR==a.C_COLOR&&(d=d|b.COLOR_BUFFER_BIT),c&a.C_DEPTH==a.C_DEPTH&&(d=d|b.DEPTH_BUFFER_BIT),c&a.C_STENCIL==a.C_STENCIL&&(d=d|b.STENCIL_BUFFER_BIT),b.clear(d)},a.Renderer.prototype.getScene=function(){return this.scene},a.Renderer.prototype.setScene=function(a){a.renderer=this,this.scene=a,a.GLInit(this.gl),this.render(),a.camera.matrix=null;return this},a.Renderer.prototype.render=function(){this.cullFaces&&this.gl.enable(this.gl.CULL_FACE),this.scene&&this.scene.render(this.gl),!this.rendered&&this.scene&&(this.scene.render(this.gl),this.rendered=!0)}}(GLGE),function(a){a.C_PERSPECTIVE=1,a.C_ORTHO=2,a.Camera=function(b){a.Assets.registerAsset(this,b)},a.augment(a.Placeable,a.Camera),a.augment(a.Animatable,a.Camera),a.augment(a.QuickNotation,a.Camera),a.augment(a.JSONLoader,a.Camera),a.Camera.prototype.className="Camera",a.Camera.prototype.fovy=35,a.Camera.prototype.aspect=1,a.Camera.prototype.near=.1,a.Camera.prototype.far=1e3,a.Camera.prototype.orthoscale=5,a.Camera.prototype.type=a.C_PERSPECTIVE,a.Camera.prototype.pMatrix=null,a.Camera.prototype.getOrthoScale=function(){if(this.type==a.C_ORTHO)return this.orthoscale;a.error("You may only get a scale for a orthographic camera");return 1},a.Camera.prototype.setOrthoScale=function(b){this.type==a.C_ORTHO?(this.orthoscale=b,this.pMatrix=null):a.error("You may only set a scale for a orthographic camera");return this},a.Camera.prototype.getFar=function(){return this.far},a.Camera.prototype.setFar=function(a){this.far=a;return this},a.Camera.prototype.getNear=function(){return this.near},a.Camera.prototype.setNear=function(a){this.near=a;return this},a.Camera.prototype.getType=function(){return this.type},a.Camera.prototype.setType=function(b){b==a.C_PERSPECTIVE||b==a.C_ORTHO?(this.type=b,this.pMatrix=null):a.error("unsuported camera type");return this},a.Camera.prototype.getFovY=function(){if(this.type==a.C_PERSPECTIVE)return this.fovy;a.error("You may only get a yfov for a perspective camera");return 1},a.Camera.prototype.setFovY=function(b){this.type==a.C_PERSPECTIVE?(this.fovy=b,this.ymax=null,this.pMatrix=null):a.error("You may only set a yfov for a perspective camera");return this},a.Camera.prototype.getAspect=function(){if(this.type==a.C_PERSPECTIVE||this.type==a.C_ORTHO)return this.aspect;a.error("You may only set a aspect for a perspective or orthographic camera");return 1},a.Camera.prototype.setAspect=function(b){this.type==a.C_PERSPECTIVE||this.type==a.C_ORTHO?(this.aspect=b,this.pMatrix=null):a.error("You may only set a aspect for a perspective or orthographic camera");return this},a.Camera.prototype.getProjectionMatrix=function(){if(!this.pMatrix)switch(this.type){case a.C_PERSPECTIVE:this.pMatrix=a.makePerspective(this.fovy,this.aspect,this.near,this.far);break;case a.C_ORTHO:this.pMatrix=a.makeOrtho(-this.orthoscale*this.aspect,this.orthoscale*this.aspect,-this.orthoscale,this.orthoscale,this.near,this.far)}return this.pMatrix},a.Camera.prototype.setProjectionMatrix=function(a){this.pMatrix=a;return this},a.Camera.prototype.updateMatrix=function(){var b=this.getPosition(),c=a.translateMatrix(b.x,b.y,b.z);c=a.mulMat4(c,this.getRotMatrix()),this.parent&&(c=a.mulMat4(this.parent.getModelMatrix(),c)),this.matrix=a.inverseMat4(c)},a.Camera.prototype.getViewMatrix=function(){(!this.matrix||!this.rotmatrix)&&this.updateMatrix();return this.matrix},a.Camera.prototype.getViewProjection=function(){var b=this.getProjectionMatrix(),c=this.getViewMatrix();if(b!=this.vpProjectionMatrix||c!=this.vpViewMatrix)this.cameraViewProjection=a.mulMat4(b,c),this.vpProjectionMatrix=b,this.vpViewMatrix=c;return this.cameraViewProjection}}(GLGE),function(a){a.Light=function(b){a.Assets.registerAsset(this,b),this.color={r:1,g:1,b:1}},a.augment(a.Placeable,a.Light),a.augment(a.Animatable,a.Light),a.augment(a.QuickNotation,a.Light),a.augment(a.JSONLoader,a.Light),a.Light.prototype.className="Light",a.L_POINT=1,a.L_DIR=2,a.L_SPOT=3,a.Light.prototype.constantAttenuation=1,a.Light.prototype.linearAttenuation=.002,a.Light.prototype.quadraticAttenuation=8e-4,a.Light.prototype.spotCosCutOff=.95,a.Light.prototype.spotPMatrix=null,a.Light.prototype.spotExponent=10,a.Light.prototype.color=null,a.Light.prototype.diffuse=!0,a.Light.prototype.specular=!0,a.Light.prototype.samples=0,a.Light.prototype.softness=.01,a.Light.prototype.type=a.L_POINT,a.Light.prototype.frameBuffer=null,a.Light.prototype.renderBuffer=null,a.Light.prototype.texture=null,a.Light.prototype.bufferHeight=256,a.Light.prototype.bufferWidth=256,a.Light.prototype.shadowBias=2,a.Light.prototype.distance=100,a.Light.prototype.castShadows=!1,a.Light.prototype.getPMatrix=function(){if(!this.spotPMatrix){var b;this.scene&&this.scene.camera?b=this.scene.camera.far:b=1e3,this.spotPMatrix=a.makePerspective(Math.acos(this.spotCosCutOff)/3.14159*360,1,.1,b)}return this.spotPMatrix},a.Light.prototype.setDistance=function(a){this.distance=a;return this},a.Light.prototype.getDistance=function(){return this.distance},a.Light.prototype.setNegativeShadow=function(a){this.negativeShadow=a,this.fireEvent("shaderupdate",{});return this},a.Light.prototype.getNegative=function(){return this.negativeShadow},a.Light.prototype.setCastShadows=function(a){this.castShadows=a,this.fireEvent("shaderupdate",{});return this},a.Light.prototype.getCastShadows=function(){return this.castShadows},a.Light.prototype.setShadowBias=function(a){this.shadowBias=a;return this},a.Light.prototype.getShadowBias=function(){return this.shadowBias},a.Light.prototype.setShadowSamples=function(a){this.samples=a,this.fireEvent("shaderupdate",{});return this},a.Light.prototype.getShadowSamples=function(){return this.samples},a.Light.prototype.setShadowSoftness=function(a){this.softness=a,this.fireEvent("shaderupdate",{});return this},a.Light.prototype.getShadowSamples=function(){return this.softness},a.Light.prototype.setBufferWidth=function(a){this.bufferWidth=a;return this},a.Light.prototype.getBufferHeight=function(){return this.bufferHeight},a.Light.prototype.setBufferHeight=function(a){this.bufferHeight=a;return this},a.Light.prototype.getBufferWidth=function(){return this.bufferWidth},a.Light.prototype.setSpotCosCutOff=function(a){this.spotPMatrix=null,this.spotCosCutOff=a;return this},a.Light.prototype.getSpotCosCutOff=function(){return this.spotCosCutOff},a.Light.prototype.setSpotExponent=function(a){this.spotExponent=a;return this},a.Light.prototype.getSpotExponent=function(){return this.spotExponent},a.Light.prototype.getAttenuation=function(a,b,c){var d={};d.constant=this.constantAttenuation,d.linear=this.linearAttenuation,d.quadratic=this.quadraticAttenuation;return d},a.Light.prototype.setAttenuation=function(a,b,c){this.constantAttenuation=a,this.linearAttenuation=b,this.quadraticAttenuation=c;return this},a.Light.prototype.setAttenuationConstant=function(a){this.constantAttenuation=a;return this},a.Light.prototype.setAttenuationLinear=function(a){this.linearAttenuation=a;return this},a.Light.prototype.setAttenuationQuadratic=function(a){this.quadraticAttenuation=a;return this},a.Light.prototype.setColor=function(b){b=a.colorParse(b),this.color={r:b.r,g:b.g,b:b.b};return this},a.Light.prototype.setColorR=function(a){this.color.r=a;return this},a.Light.prototype.setColorG=function(a){this.color.g=a;return this},a.Light.prototype.setColorB=function(a){this.color.b=a;return this},a.Light.prototype.getColor=function(){return this.color},a.Light.prototype.getType=function(){return this.type},a.Light.prototype.setType=function(a){this.type=a,this.fireEvent("shaderupdate",{});return this},a.Light.prototype.GLInit=function(b){this.gl=b,this.type==a.L_SPOT&&!this.texture&&this.createSpotBuffer(b)},a.Light.prototype.createSpotBuffer=function(b){this.frameBuffer=b.createFramebuffer(),this.renderBuffer=b.createRenderbuffer(),this.texture=b.createTexture(),b.bindTexture(b.TEXTURE_2D,this.texture);try{b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.bufferWidth,this.bufferHeight,0,b.RGBA,b.UNSIGNED_BYTE,null)}catch(c){a.error("incompatible texture creation method");var d=parseFloat(this.bufferWidth),e=parseFloat(this.bufferHeight),f=new Uint8Array(d*e*4);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,d,e,0,b.RGBA,b.UNSIGNED_BYTE,f)}b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffer),b.bindRenderbuffer(b.RENDERBUFFER,this.renderBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.bufferWidth,this.bufferHeight),b.bindRenderbuffer(b.RENDERBUFFER,null),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.texture,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.renderBuffer),b.bindFramebuffer(b.FRAMEBUFFER,null)}}(GLGE),function(a){a.FOG_NONE=1,a.FOG_LINEAR=2,a.FOG_QUADRATIC=3,a.Scene=function(b){a.Assets.registerAsset(this,b),a.Group.call(this),this.children=[],this.camera=new a.Camera,this.backgroundColor={r:1,g:1,b:1,a:1},this.ambientColor={r:0,g:0,b:0},this.fogColor={r:.5,g:.5,b:.5},this.passes=[]},a.augment(a.Group,a.Scene),a.augment(a.QuickNotation,a.Scene),a.augment(a.JSONLoader,a.Scene),a.Scene.prototype.camera=null,a.Scene.prototype.className="Scene",a.Scene.prototype.renderer=null,a.Scene.prototype.backgroundColor=null,a.Scene.prototype.filter=null,a.Scene.prototype.fogColor=null,a.Scene.prototype.ambientColor=null,a.Scene.prototype.fogNear=10,a.Scene.prototype.fogFar=80,a.Scene.prototype.fogType=a.FOG_NONE,a.Scene.prototype.passes=null,a.Scene.prototype.culling=!0,a.Scene.prototype.getFogType=function(){return this.fogType},a.Scene.prototype.setFogType=function(a){this.fogType=a;return this},a.Scene.prototype.getFogFar=function(){return this.fogFar},a.Scene.prototype.setFogFar=function(a){this.fogFar=a;return this},a.Scene.prototype.getFogNear=function(){return this.fogNear},a.Scene.prototype.setFogNear=function(a){this.fogNear=a;return this},a.Scene.prototype.getFogColor=function(){return this.fogColor},a.Scene.prototype.setFogColor=function(b){b=a.colorParse(b),this.fogColor={r:b.r,g:b.g,b:b.b};return this},a.Scene.prototype.getBackgroundColor=function(){return this.backgroundColor},a.Scene.prototype.setBackgroundColor=function(b){b=a.colorParse(b),this.backgroundColor={r:b.r,g:b.g,b:b.b,a:b.a};return this},a.Scene.prototype.getAmbientColor=function(){return this.ambientColor},a.Scene.prototype.setAmbientColor=function(b){b=a.colorParse(b),this.ambientColor={r:b.r,g:b.g,b:b.b},this.renderer&&this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1);return this},a.Scene.prototype.setAmbientColorR=function(a){this.ambientColor.r=a;return this},a.Scene.prototype.setAmbientColorG=function(a){this.ambientColor.g=a;return this},a.Scene.prototype.setAmbientColorB=function(a){this.ambientColor.b=a;return this},a.Scene.prototype.setCamera=function(b){typeof b=="string"&&(b=a.Assets.get(b)),this.camera=b;return this},a.Scene.prototype.getCamera=function(){return this.camera},a.Scene.prototype.setCull=function(a){this.culling=a;return this},a.Scene.prototype.getCull=function(){return this.culling},a.Scene.prototype.GLInit=function(a){this.gl=a,a.lights=this.getLights(),this.camera.setAspect(this.renderer.canvas.width/this.renderer.canvas.height),this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1);for(var b=0;b<this.children;b++)this.children[b].GLInit&&children[b].GLInit(a)},a.Scene.prototype.GLDestroy=function(a){},a.Scene.sortFunc=function(a,b){return a.zdepth-b.zdepth},a.Scene.prototype.zSort=function(b,c){var d=b.scene.camera.getViewMatrix(),e;for(var f=0;f<c.length;f++){if(c[f].object.getBoundingVolume)var g=c[f].object.getBoundingVolume().getCenter();else var h=c[f].object.getModelMatrix(),g=[h[3],h[7],h[11]];c[f].zdepth=g[0]*d[8]+g[1]*d[9]+g[2]*d[10]+d[11]}c.sort(a.Scene.sortFunc);return c},a.Scene.prototype.setFilter2d=function(a){this.filter=a;return this},a.Scene.prototype.getFilter2d=function(a){return this.filter},a.Scene.prototype.getFrameBuffer=function(a){if(this.filter)return this.filter.getFrameBuffer(a);return null},a.Scene.prototype.objectsInViewFrustum=function(b,c){var d,e=[],f=a.cameraViewProjectionToPlanes(c);for(var g=0;g<b.length;g++){d=b[g];if(d.getBoundingVolume&&d.cull){var h=d.getBoundingVolume(),i=h.getCenter(),j=h.getSphereRadius();if(a.sphereInFrustumPlanes([i[0],i[1],i[2],j],f)){var k=h.getCornerPoints();a.pointsInFrustumPlanes(k,f)&&e.push(d)}}else e.push(d)}return e},a.Scene.prototype.unfoldRenderObject=function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];if(d.getMultiMaterials){var e=d.getMultiMaterials();for(var f=0;f<e.length;f++){var g=e[f].getMaterial(),h=e[f].getMesh();g.meshIdx||(g.matIdx=f),g.meshIdx||(g.meshIdx=f),b.push({object:d,multiMaterial:f})}}else b.push({object:d,multiMaterial:0})}return b},a.Scene.prototype.stateSort=function(a,b){if(!a.object.GLShaderProgram)return 1;if(!b.object.GLShaderProgram)return-1;var c=a.object.GLShaderProgram.progIdx,d=b.object.GLShaderProgram.progIdx;if(c>d)return 1;if(c<d)return-1;if(!a.object.multimaterials||!b.object.multimaterials)return-1;var c=a.object.multimaterials[a.multiMaterial].getMaterial().matIdx,d=b.object.multimaterials[b.multiMaterial].getMaterial().matIdx;if(c>d)return 1;if(c<d)return-1;var e=a.object.multimaterials[a.multiMaterial].getMesh(),f=a.object.multimaterials[a.multiMaterial].getMesh();if(!e)return-1;if(!f)return 1;var c=e.meshIdx,d=f.meshIdx;return c>d?1:c<d?-1:0},a.Scene.prototype.render=function(b){this.camera.lookAt&&this.camera.Lookat(this.camera.lookAt),this.animate(),b.lights=this.getLights();var c=b.lights;b.scene=this,this.lastMaterial=null,b.disable(b.BLEND),this.framebuffer=this.getFrameBuffer(b);var d=this.getObjects(),e=this.camera.getViewProjection();if(this.culling){var e=this.camera.getViewProjection();d=this.objectsInViewFrustum(d,e)}d=this.unfoldRenderObject(d),d=d.sort(this.stateSort);for(var f=0;f<c.length;f++)if(c[f].castShadows){c[f].gl||c[f].GLInit(b);var g=this.camera.matrix,h=this.camera.getProjectionMatrix();c[f].s_cache||(c[f].s_cache={});if(c[f].s_cache.pmatrix!=c[f].getPMatrix()||c[f].s_cache.mvmatrix!=c[f].getModelMatrix())c[f].s_cache.pmatrix=c[f].getPMatrix(),c[f].s_cache.mvmatrix=c[f].getModelMatrix(),c[f].s_cache.imvmatrix=a.inverseMat4(c[f].getModelMatrix()),c[f].s_cache.smatrix=a.mulMat4(c[f].getPMatrix(),c[f].s_cache.imvmatrix),c[f].shadowRendered=!1;b.bindFramebuffer(b.FRAMEBUFFER,c[f].frameBuffer),b.viewport(0,0,parseFloat(c[f].bufferWidth),parseFloat(c[f].bufferHeight)),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),this.camera.setProjectionMatrix(c[f].s_cache.pmatrix),this.camera.matrix=c[f].s_cache.imvmatrix;for(var i=0;i<d.length;i++)d[i].object.GLRender(b,a.RENDER_SHADOW,i,d[i].multiMaterial,c[f].distance);b.flush(),this.camera.matrix=g,this.camera.setProjectionMatrix(h),b.bindTexture(b.TEXTURE_2D,c[f].texture),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.generateMipmap(b.TEXTURE_2D),b.bindFramebuffer(b.FRAMEBUFFER,null)}this.camera.animation&&this.camera.animate(),this.getPasses(b,d);var g=this.camera.matrix,h=this.camera.getProjectionMatrix();this.allowPasses=!1;while(this.passes.length>0){var j=this.passes.pop();b.bindFramebuffer(b.FRAMEBUFFER,j.frameBuffer),this.camera.matrix=j.cameraMatrix,this.camera.setProjectionMatrix(j.projectionMatrix),this.renderPass(b,d,0,0,j.width,j.height,a.RENDER_DEFAULT,j.self)}this.camera.matrix=g,this.camera.setProjectionMatrix(h),b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer),this.renderPass(b,d,this.renderer.getViewportOffsetX(),this.renderer.getViewportOffsetY(),this.renderer.getViewportWidth(),this.renderer.getViewportHeight()),this.applyFilter(b,d,null),this.allowPasses=!0},a.Scene.prototype.getPasses=function(b,c){for(var d=0;d<c.length;d++)c[d].object.GLRender(b,a.RENDER_NULL,0,c[d].multiMaterial)},a.Scene.prototype.renderPass=function(b,c,d,e,f,g,h,i){b.clearDepth(1),b.depthFunc(b.LEQUAL),b.viewport(d,e,f,g),b.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),h?b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT|b.STENCIL_BUFFER_BIT):(b.scissor(d,e,f,g),b.enable(b.SCISSOR_TEST),this.renderer.GLClear(),b.disable(b.SCISSOR_TEST)),h||(h=a.RENDER_DEFAULT);var j=[];b.disable(b.BLEND);for(var k=0;k<c.length;k++)c[k].object.zTrans||c[k]==i?c[k]!=i&&j.push(c[k]):c[k].object.GLRender(b,h,0,c[k].multiMaterial);b.enable(b.BLEND),j=this.zSort(b,j);for(var k=0;k<j.length;k++)c[k]!=i&&j[k].object.GLRender(b,h,0,j[k].multiMaterial)},a.Scene.prototype.applyFilter=function(b,c,d){this.filter&&this.filter.renderDepth&&(b.clearDepth(1),b.depthFunc(b.LEQUAL),b.bindFramebuffer(b.FRAMEBUFFER,this.filter.getDepthBuffer(b)),this.renderPass(b,c,0,0,this.filter.getDepthBufferWidth(),this.filter.getDepthBufferHeight(),a.RENDER_SHADOW)),this.filter&&this.filter.renderEmit&&(b.clearDepth(1),b.depthFunc(b.LEQUAL),b.bindFramebuffer(b.FRAMEBUFFER,this.filter.getEmitBuffer(b)),this.renderPass(b,c,0,0,this.filter.getEmitBufferWidth(),this.filter.getEmitBufferHeight(),a.RENDER_EMIT)),this.filter&&this.filter.renderNormal&&(b.clearDepth(1),b.depthFunc(b.LEQUAL),b.bindFramebuffer(b.FRAMEBUFFER,this.filter.getNormalBuffer(b)),this.renderPass(b,c,0,0,this.filter.getNormalBufferWidth(),this.filter.getNormalBufferHeight(),a.RENDER_NORMAL)),this.filter&&this.filter.GLRender(b,d)},a.Scene.prototype.addRenderPass=function(a,b,c,d,e,f){this.allowPasses&&this.passes.push({frameBuffer:a,cameraMatrix:b,projectionMatrix:c,height:e,width:d,self:f});return this},a.Scene.prototype.ray=function(b,c){var d=this.renderer.gl,e=this.camera.matrix,f=this.camera.pMatrix;this.camera.matrix=a.inverseMat4(a.Mat4([c[2],c[1],c[0],b[0],c[0],c[2],c[1],b[1],c[1],c[0],c[2],b[2],0,0,0,1])),this.pickPMatrix||(this.pickPMatrix=a.makeOrtho(-1e-4,1e-4,-1e-4,1e-4,this.camera.near,this.camera.far)),this.camera.pMatrix=this.pickPMatrix,d.viewport(0,0,8,1),d.clear(d.DEPTH_BUFFER_BIT),d.disable(d.BLEND),d.scene=this;var g=this.getObjects();for(var h=0;h<g.length;h++)g[h].pickable&&g[h].GLRender(d,a.RENDER_PICK,h+1);d.flush();var i=new Uint8Array(32);d.readPixels(0,0,8,1,d.RGBA,d.UNSIGNED_BYTE,i);var j=[i[4]/255,i[5]/255,i[6]/255],k=Math.sqrt(j[0]*j[0]+j[1]*j[1]+j[2]*j[2])*.5;j=[j[0]/k-1,j[1]/k-1,j[2]/k-1];var l=g[i[0]+i[1]*256+i[2]*65536-1],m=(i[10]/255+.00390625*i[9]/255+152587890625e-16*i[8]/255)*this.camera.far,n=[];n[0]=i[14]/255+.00390625*i[13]/255+152587890625e-16*i[12]/255,n[1]=i[18]/255+.00390625*i[17]/255+152587890625e-16*i[16]/255,d.bindFramebuffer(d.FRAMEBUFFER,null),d.viewport(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.camera.matrix=e,this.camera.pMatrix=f;if(l)return{object:l,distance:m,coord:[b[0]-c[0]*m,b[1]-c[1]*m,b[2]-c[2]*m],normal:j,texture:n};return null},a.Scene.prototype.pick=function(a,b){var c=this.makeRay(a,b);if(!c)return null;return this.ray(c.origin,c.coord)},a.Scene.prototype.makeRay=function(b,c){if(this.camera){if(this.camera.matrix&&this.camera.pMatrix){var d=this.renderer.getViewportHeight(),e=this.renderer.getViewportWidth(),f=this.renderer.getViewportOffsetX(),g=this.renderer.getViewportHeight()-this.renderer.canvas.height+this.renderer.getViewportOffsetY(),h=((b-f)/e-.5)*2,i=-((c+g)/d-.5)*2,j=a.mulMat4(a.inverseMat4(this.camera.matrix),a.inverseMat4(this.camera.pMatrix)),k=a.mulMat4Vec4(j,[h,i,-1,1]);k=[k[0]/k[3],k[1]/k[3],k[2]/k[3]];var l=a.mulMat4Vec4(j,[h,i,1,1]);l=[-(l[0]/l[3]-k[0]),-(l[1]/l[3]-k[1]),-(l[2]/l[3]-k[2])],l=a.toUnitVec3(l);return{origin:k,coord:l}}return null}a.error("No camera set for picking");return null}}(GLGE),function(a){a.ParticleSystem=function(a){this.startTime=(new Date).getTime(),this.texture={},this.startMaxVelocity={x:0,y:0,z:0},this.startMinVelocity={x:0,y:0,z:0},this.startMaxAcceleration={x:0,y:0,z:0},this.endMaxAcceleration={x:0,y:0,z:0},this.startMinAcceleration={x:0,y:0,z:0},this.endMinAcceleration={x:0,y:0,z:0},this.startColor={r:0,g:0,b:0,a:1},this.endColor={r:0,g:0,b:0,a:1}},a.augment(a.Placeable,a.ParticleSystem),a.augment(a.Animatable,a.ParticleSystem),a.ParticleSystem.prototype.setMaxVelX=function(a){this.startMaxVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelY=function(a){this.startMaxVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelZ=function(a){this.startMaxVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelocity=function(a,b,c){this.startMaxVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinVelX=function(a){this.startMinVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelY=function(a){this.startMinVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelZ=function(a){this.startMinVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelocity=function(a,b,c){this.startMinVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setVelX=function(a){this.startMaxVelocity.x=parseFloat(a),this.startMinVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelY=function(a){this.startMaxVelocity.y=parseFloat(a),this.startMinVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelZ=function(a){this.startMaxVelocity.z=parseFloat(a),this.startMinVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelocity=function(a,b,c){this.startMaxVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.startMinVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccX=function(a){this.startMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccY=function(a){this.startMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccZ=function(a){this.startMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccelertaion=function(a,b,c){this.startMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinStartAccX=function(a){this.startMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccY=function(a){this.startMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccZ=function(a){this.startMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccelertaion=function(a,b,c){this.startMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setStartAccX=function(a){this.startMaxAcceleration.x=parseFloat(a),this.startMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccY=function(a){this.startMaxAcceleration.y=parseFloat(a),this.startMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccZ=function(a){this.startMaxAcceleration.z=parseFloat(a),this.startMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccelertaion=function(a,b,c){this.startMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.startMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccX=function(a){this.endMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccY=function(a){this.endMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccZ=function(a){this.endMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccelertaion=function(a,b,c){this.endMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinEndAccX=function(a){this.endMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccY=function(a){this.endMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccZ=function(a){this.endMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccelertaion=function(a,b,c){this.endMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setEndAccX=function(a){this.endMinAcceleration.x=parseFloat(a),this.endMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccY=function(a){this.endMinAcceleration.y=parseFloat(a),this.endMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccZ=function(a){this.endMinAcceleration.z=parseFloat(a),this.endMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccelertaion=function(a,b,c){this.endMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.endMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setStartColor=function(b){var c=a.colorParse(b);this.startColor=c,this.attribute=null},a.ParticleSystem.prototype.setEndColor=function(b){var c=a.colorParse(b);this.endColor=c,this.attribute=null},a.ParticleSystem.prototype.setStartSize=function(a){this.startSize=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndSize=function(a){this.endSize=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setLifeTime=function(a){this.maxLifeTime=parseFloat(a),this.minLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxLifeTime=function(a){this.maxLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinLifeTime=function(a){this.minLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setNumParticles=function(a){this.numParticles=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.velocityFunction=function(a){return[(this.startMaxVelocity.x-this.startMinVelocity.x)*Math.random()+this.startMinVelocity.x,(this.startMaxVelocity.y-this.startMinVelocity.y)*Math.random()+this.startMinVelocity.y,(this.startMaxVelocity.z-this.startMinVelocity.z)*Math.random()+this.startMinVelocity.z]},a.ParticleSystem.prototype.accelerationFunction=function(a){return[[(this.startMaxAcceleration.x-this.startMinAcceleration.x)*Math.random()+this.startMinAcceleration.x,(this.startMaxAcceleration.y-this.startMinAcceleration.y)*Math.random()+this.startMinAcceleration.y,(this.startMaxAcceleration.z-this.startMinAcceleration.z)*Math.random()+this.startMinAcceleration.z],[(this.endMaxAcceleration.x-this.endMinAcceleration.x)*Math.random()+this.endMinAcceleration.x,(this.endMaxAcceleration.y-this.endMinAcceleration.y)*Math.random()+this.endMinAcceleration.y,(this.endMaxAcceleration.z-this.endMinAcceleration.z)*Math.random()+this.endMinAcceleration.z]]},a.ParticleSystem.prototype.colorFunction=function(a){return[[this.startColor.r,this.startColor.g,this.startColor.b,this.startColor.a],[this.endColor.r,this.endColor.g,this.endColor.b,this.endColor.a]]},a.ParticleSystem.prototype.positionFunction=function(a){return[0,0,0]},a.ParticleSystem.prototype.sizeFunction=function(a){return[this.startSize,this.endSize]},a.ParticleSystem.prototype.lifeTimeFunction=function(a){return(this.maxLifeTime-this.minLifeTime)*Math.random()+this.minLifeTime},a.ParticleSystem.prototype.minLifeTime=2e3,a.ParticleSystem.prototype.maxLifeTime=2e3,a.ParticleSystem.prototype.numParticles=200,a.ParticleSystem.prototype.startTime=0,a.ParticleSystem.prototype.startSize=0,a.ParticleSystem.prototype.endSize=1,a.ParticleSystem.prototype.toRender=!0,a.ParticleSystem.prototype.renderFirst=!0,a.ParticleSystem.prototype.className="ParticleSystem",a.ParticleSystem.prototype.zTrans=!0,a.ParticleSystem.prototype.velocity=null,a.ParticleSystem.prototype.loop=1,a.ParticleSystem.prototype.setVelocityFunction=function(a){this.vecoityFunction=a,this.particles=null},a.ParticleSystem.prototype.setAccelerationFunction=function(a){this.accelerationFunction=a,this.particles=null},a.ParticleSystem.prototype.setPositionFunction=function(a){this.colorFunction=a,this.particles=null},a.ParticleSystem.prototype.setColorFunction=function(a){this.positionFunction=a,this.particles=null},a.ParticleSystem.prototype.setSizeFunction=function(a){this.sizeFunction=a,this.particles=null},a.ParticleSystem.prototype.generateParticles=function(a){var b=this.numParticles;this.attribute={initPos:[],initAcc:[],endAcc:[],initVel:[],initColor:[],endColor:[],sizeAndOffset:[]},this.faces=[];for(var c=0;c<b;c++){var d=this.positionFunction(c),e=this.velocityFunction(c),f=this.accelerationFunction(c),g=this.colorFunction(c),h=this.sizeFunction(c),i=this.lifeTimeFunction(c),j=Math.floor(Math.random()*i);for(var k=-1;k<=1;k=k+2)for(var l=-1;l<=1;l=l+2)this.attribute.initPos.push(parseFloat(d[0])+l,parseFloat(d[1])+k,parseFloat(d[2])),this.attribute.initAcc.push(f[0][0],f[0][1],f[0][2]),this.attribute.endAcc.push(f[1][0],f[1][1],f[1][2]),this.attribute.initVel.push(e[0],e[1],e[2]),this.attribute.initColor.push(g[0][0],g[0][1],g[0][2],g[0][3]),this.attribute.endColor.push(g[1][0],g[1][1],g[1][2],g[1][3]),this.attribute.sizeAndOffset.push(h[0],h[1],j,i)}for(var c=0;c<b;c=c+4)this.faces.push(0+c,1+c,2+c),this.faces.push(1+c,2+c,3+c);this.facesGL=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces),a.STATIC_DRAW),this.facesGL.num=this.faces.length,this.attribute.initPosGL=this.createBuffer(a,this.attribute.initPos),this.attribute.initAccGL=this.createBuffer(a,this.attribute.initAcc),this.attribute.endAccGL=this.createBuffer(a,this.attribute.endAcc),this.attribute.initVelGL=this.createBuffer(a,this.attribute.initVel),this.attribute.initColorGL=this.createBuffer(a,this.attribute.initColor),this.attribute.endColorGL=this.createBuffer(a,this.attribute.endColor),this.attribute.sizeAndOffsetGL=this.createBuffer(a,this.attribute.sizeAndOffset)},a.ParticleSystem.prototype.setLoop=function(a){this.loop=a},a.ParticleSystem.prototype.reset=function(){this.startTime=(new Date).getTime()},a.ParticleSystem.prototype.generateProgram=function(b){var c=["attribute vec3 position;","attribute vec3 initVel;","attribute vec3 initAcc;","attribute vec3 endAcc;","attribute vec4 initColor;","attribute vec4 endColor;","attribute vec4 sizeTimeLife;","uniform float time;","uniform bool loop;","uniform mat4 mvMatrix;","uniform mat4 pMatrix;","varying vec2 UV;","varying vec4 color;","void main(){","UV = (position.xy+1.0)/2.0;","if((time>sizeTimeLife[2] && (time-sizeTimeLife[2])<sizeTimeLife[3]) || loop){","float localTime = mod((time - sizeTimeLife[2]), sizeTimeLife[3]);","color = (endColor-initColor)/sizeTimeLife[3]*localTime+initColor;","float size = (sizeTimeLife[1]-sizeTimeLife[0])/sizeTimeLife[3]*localTime+sizeTimeLife[0];","vec3 pos = (endAcc-initAcc)*(localTime*log(localTime)-localTime)+0.5*initAcc*localTime*localTime+initVel*localTime;","pos = (mvMatrix*vec4(pos,1.0)).xyz;","vec3 positions = pos+(position*size);","gl_Position = pMatrix*vec4(positions,1.0);","}else{","gl_Position = vec4(0.0,0.0,0.0,1.0);","}","}"].join("");frgShader=["#ifdef GL_ES\nprecision mediump float;\n#endif\n","uniform sampler2D texture;","varying vec2 UV;","varying vec4 color;","void main(){","gl_FragColor=texture2D(texture,UV)*color;","}"].join("");var d=b.createShader(b.VERTEX_SHADER),e=b.createShader(b.FRAGMENT_SHADER);b.shaderSource(d,c),b.compileShader(d);if(b.getShaderParameter(d,b.COMPILE_STATUS)){b.shaderSource(e,frgShader),b.compileShader(e);if(!b.getShaderParameter(e,b.COMPILE_STATUS)){a.error(b.getShaderInfoLog(e));return}this.program&&b.deleteProgram(this.Program),this.program=b.createProgram(),b.attachShader(this.program,d),b.attachShader(this.program,e),b.linkProgram(this.program)}else a.error(b.getShaderInfoLog(d))},a.ParticleSystem.prototype.createBuffer=function(a,b){var c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);return c},a.ParticleSystem.prototype.setUniforms=function(b){var c=this.program;c.glarrays||(c.glarrays={});var d=b.scene.camera.getViewMatrix(),e=this.getPosition(),f=a.mulMat4(d,[1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1]),g=a.getUniformLocation(b,c,"mvMatrix");c.glarrays.mvMatrix?a.mat4gl(f,c.glarrays.mvMatrix):c.glarrays.mvMatrix=new Float32Array(f),b.uniformMatrix4fv(g,!0,c.glarrays.mvMatrix);var h=a.getUniformLocation(b,c,"pMatrix");c.glarrays.pMatrix?a.mat4gl(b.scene.camera.getProjectionMatrix(),c.glarrays.pMatrix):c.glarrays.pMatrix=new Float32Array(b.scene.camera.getProjectionMatrix()),b.uniformMatrix4fv(h,!0,c.glarrays.pMatrix),b.uniform1f(a.getUniformLocation(b,c,"time"),(new Date).getTime()-this.startTime),b.uniform1i(a.getUniformLocation(b,c,"loop"),this.loop),b.activeTexture(b.TEXTURE0),this.glTexture||(this.glTexture=b.createTexture()),this.texture.state==1&&(b.bindTexture(b.TEXTURE_2D,this.glTexture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this.texture.image),b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_LINEAR),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null),this.texture.state=2,c.texture=!0),b.bindTexture(b.TEXTURE_2D,this.glTexture),c.texture&&b.uniform1i(a.getUniformLocation(b,c,"texture"),0)},a.ParticleSystem.prototype.setImage=function(a){var b=this.texture;b.image=new Image,b.image.onload=function(a){b.state=1},b.image.src=a},a.ParticleSystem.prototype.setAttributes=function(b){for(var c=0;c<8;c++)b.disableVertexAttribArray(c);var d=a.getAttribLocation(b,this.program,"position");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initPosGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initAcc");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initAccGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"endAcc");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.endAccGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initColor");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initColorGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"endColor");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.endColorGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"sizeTimeLife");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.sizeAndOffsetGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initVel");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initVelGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0))},a.ParticleSystem.prototype.GLRender=function(a){this.attribute||this.generateParticles(a),this.program||this.generateProgram(a),a.useProgram(this.program),this.setAttributes(a),this.setUniforms(a),a.colorMask(0,0,0,0),a.disable(a.BLEND),a.enable(a.STENCIL_TEST),a.stencilFunc(a.ALWAYS,1,1),a.stencilOp(a.KEEP,a.KEEP,a.REPLACE),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.drawElements(a.TRIANGLES,this.facesGL.num,a.UNSIGNED_SHORT,0),a.stencilFunc(a.EQUAL,1,1),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.colorMask(1,1,1,1),a.disable(a.DEPTH_TEST),a.enable(a.BLEND),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.drawElements(a.TRIANGLES,this.facesGL.num,a.UNSIGNED_SHORT,0),a.stencilOp(a.REPLACE,a.REPLACE,a.REPLACE),a.stencilFunc(a.ALWAYS,0,0),a.enable(a.DEPTH_TEST),a.scene.lastMaterial=null},a.Scene.prototype.addParticleSystem=a.Scene.prototype.addGroup,a.Group.prototype.addParticleSystem=a.Group.prototype.addGroup}(GLGE),window.GLGE||(window.GLGE={}),function(a){a.Filter2d=function(){},a.Filter2d.prototype.renderDepth=!1,a.Filter2d.prototype.renderNormal=!1,a.Filter2d.prototype.renderEmit=!1,a.Filter2d.prototype.passes=null,a.Filter2d.prototype.textures=null,a.Filter2d.prototype.uniforms=null,a.Filter2d.prototype.buffers=null,a.Filter2d.prototype.depthBufferWidth=null,a.Filter2d.prototype.depthBufferHeight=null,a.Filter2d.prototype.emitBufferWidth=null,a.Filter2d.prototype.emitBufferHeight=null,a.Filter2d.prototype.normalBufferWidth=null,a.Filter2d.prototype.normalBufferHeight=null,a.Filter2d.prototype.addTexture=function(a){this.textures||(this.textures=[]),this.textures.push(a)},a.Filter2d.prototype.removeTexture=function(a){var b=this.textures.indexOf(a);b>-1&&this.textures.splice(b,1)},a.Filter2d.prototype.createBuffer=function(a,b,c){b||(b=a.canvas.width),c||(c=a.canvas.height);var d=a.createFramebuffer(),e=a.createRenderbuffer(),f=a.createTexture();a.bindTexture(a.TEXTURE_2D,f);var g=new Uint8Array(b*c*4);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,g),a.bindFramebuffer(a.FRAMEBUFFER,d),a.bindRenderbuffer(a.RENDERBUFFER,e),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b,c),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,e),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,f,0),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null);return[d,e,f]},a.Filter2d.prototype.getFrameBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.buffers||(this.buffers=this.createBuffer(a));return this.buffers[0]},a.Filter2d.prototype.getEmitBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.emitBuffers||(this.emitBuffers=this.createBuffer(a,this.getEmitBufferWidth(),this.getEmitBufferHeight()));return this.emitBuffers[0]},a.Filter2d.prototype.setEmitBufferWidth=function(a){this.emitBufferWidth=a,this.emitBuffers=null},a.Filter2d.prototype.getEmitBufferWidth=function(){return this.emitBufferWidth?this.emitBufferWidth:this.gl.canvas.width},a.Filter2d.prototype.setEmitBufferHeight=function(a){this.emitBufferHeight=a,this.emitBuffers=null},a.Filter2d.prototype.getEmitBufferHeight=function(){return this.emitBufferHeight?this.emitBufferHeight:this.gl.canvas.height},a.Filter2d.prototype.getDepthBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.depthBuffers||(this.depthBuffers=this.createBuffer(a,this.getDepthBufferWidth(),this.getDepthBufferHeight()));return this.depthBuffers[0]},a.Filter2d.prototype.setDepthBufferWidth=function(a){this.depthBufferWidth=a,this.depthBuffers=null},a.Filter2d.prototype.getDepthBufferWidth=function(){return this.depthBufferWidth?this.depthBufferWidth:this.gl.canvas.width},a.Filter2d.prototype.setDepthBufferHeight=function(a){this.depthBufferHeight=a,this.depthBuffers=null},a.Filter2d.prototype.getDepthBufferHeight=function(){return this.depthBufferHeight?this.depthBufferHeight:this.gl.canvas.height},a.Filter2d.prototype.setNormalBufferWidth=function(a){this.normalBufferWidth=a,this.normalBuffers=null},a.Filter2d.prototype.getNormalBufferWidth=function(){return this.normalBufferWidth?this.normalBufferWidth:this.gl.canvas.width},a.Filter2d.prototype.setNormalBufferHeight=function(a){this.normalBufferHeight=a,this.normalBuffers=null},a.Filter2d.prototype.getNormalBufferHeight=function(){return this.normalBufferHeight?this.normalBufferHeight:this.gl.canvas.height},a.Filter2d.prototype.getNormalBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.normalBuffers||(this.normalBuffers=this.createBuffer(a,this.getNormalBufferWidth(),this.getNormalBufferHeight()));return this.normalBuffers[0]},a.Filter2d.prototype.setUniform=function(a,b,c){this.uniforms||(this.uniforms={}),this.uniforms[b]={type:a,value:c}},a.Filter2d.prototype.getUniform=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].value},a.Filter2d.prototype.getUniformType=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].type},a.Filter2d.prototype.addPassFile=function(a){var b=new XMLHttpRequest,c=this;b&&(b.open("GET",a,!1),b.send(""),c.addPass(b.responseText))},a.Filter2d.prototype.addPass=function(a,b,c){this.passes||(this.passes=[]),this.passes.push({GLSL:a,height:c,width:b})},a.Filter2d.prototype.GLRender=function(b,c){c||(c=null);if(this.passes)for(var d=0;d<this.passes.length;d++){this.passes.length-1==d?b.bindFramebuffer(b.FRAMEBUFFER,c):(this.passes[d].buffer||(this.passes[d].buffer=this.createBuffer(b,this.passes[d].width,this.passes[d].height)),b.bindFramebuffer(b.FRAMEBUFFER,this.passes[d].buffer[0]));var e=this.passes[d].width?this.passes[d].width:b.canvas.width,f=this.passes[d].height?this.passes[d].height:b.canvas.height;b.viewport(0,0,e,f),b.clearDepth(1),b.depthFunc(b.LEQUAL),b.clearColor(0,0,0,0),b.clear(b.DEPTH_BUFFER_BIT),this.passes[d].program||(this.passes[d].program=this.GLCreateShader(b,this.passes[d].GLSL)),b.useProgram(this.passes[d].program),b.program=this.passes[d].program;for(var g=0;g<8;g++)b.disableVertexAttribArray(g);attribslot=a.getAttribLocation(b,this.passes[d].program,"position"),this.posBuffer||this.createPlane(b),b.bindBuffer(b.ARRAY_BUFFER,this.posBuffer),b.enableVertexAttribArray(attribslot),b.vertexAttribPointer(attribslot,this.posBuffer.itemSize,b.FLOAT,!1,0,0),this.GLSetUniforms(b,d),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.GLfaces),b.drawElements(b.TRIANGLES,this.GLfaces.numItems,b.UNSIGNED_SHORT,0)}},a.Filter2d.prototype.GLSetUniforms=function(b,c){for(key in this.uniforms){var d=this.uniforms[key];d.type=="Matrix4fv"?a.setUniformMatrix(b,"Matrix4fv",a.getUniformLocation(b,this.passes[c].program,key),!1,d.value):a.setUniform(b,d.type,a.getUniformLocation(b,this.passes[c].program,key),d.value)}var e=1;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.buffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_RENDER"),0),this.renderDepth&&(b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.depthBuffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_DEPTH"),e),e++),this.renderEmit&&(b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.emitBuffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_EMIT"),e),e++),this.renderNormal&&(b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.normalBuffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_NORMAL"),e),e++);for(var f=0;f<c;f++)b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.passes[f].buffer[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_PASS"+f),e),e++;this.textures||(this.textures=[]);for(var f=0;f<this.textures.length;f++)b.activeTexture(b["TEXTURE"+(f+e)]),this.textures[f].doTexture(b,null),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"TEXTURE"+f),f+e)},a.Filter2d.prototype.createPlane=function(a){this.posBuffer||(this.posBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.posBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,.5,-1,1,.5,-1,-1,.5,1,-1,.5]),a.STATIC_DRAW),this.posBuffer.itemSize=3,this.posBuffer.numItems=4,this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=6},a.Filter2d.prototype.GLCreateShader=function(b,c){var d=[];d.push("attribute vec3 position;\n"),d.push("varying vec2 texCoord;\n"),d.push("void main(void){\n"),d.push("texCoord=(position.xy+vec2(1.0,1.0))/2.0;\n"),d.push("gl_Position = vec4(position.xyz,1.0);\n"),d.push("}\n");var e=a.getGLShader(b,b.VERTEX_SHADER,d.join("")),f=a.getGLShader(b,b.FRAGMENT_SHADER,c);return a.getGLProgram(b,e,f)}}(GLGE),typeof GLGE=="undefined"&&(GLGE={}),function(a){function c(a,b){var d=null;if(a.getAttribute("id")==b)return a;for(var e=0;e<a.childNodes.length;e++)if(a.childNodes[e].nodeType==1){d=c(a.childNodes[e],b);if(d!=null)break}return d}a.ColladaDocuments=[],a.Collada=function(b){a.Assets.registerAsset(this,b),a.Group.call(this),this.children=[],this.actions={},this.boneIdx=0,this.actionsIdx=0},a.augment(a.Group,a.Collada),a.Collada.prototype.type=a.G_NODE,a.Collada.prototype.useLights=!1,a.Collada.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,7)=="https://")return a;b||(b=window.location.href);if(b.indexOf("://")==-1)return b.slice(0,b.lastIndexOf("/"))+"/"+a;var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},a.Collada.prototype.getElementById=function(a){if(!this.idcache){var b=this.getElementsByTagName("*"),c;this.idcache={};for(var d=0;d<b.length;d++)c=b[d].getAttribute("id"),c!=""&&(this.idcache[c]=b[d])}return this.idcache[a]},a.Collada.prototype.parseArray=function(a){var b,c=a.firstChild,d="",e=[],f,g;while(c){f=(d+c.nodeValue).replace(/\s+/g," ").replace(/^\s+/g,"").split(" "),c=c.nextSibling,f[0]==""&&f.unshift(),c&&(d=f.pop());for(g=0;g<f.length;g++)f[g]!=""&&e.push(f[g])}return e},a.Collada.prototype.isSketchupFile=function(){var a=this.xml.getElementsByTagName("asset");if(!a||a.length==0)return!1;for(var b=0;b<a.length;++b){var c=a[b].getElementsByTagName("contributor");if(!c||c.length==0)return!1;for(var d=0;d<c.length;++d){var e=c[d].getElementsByTagName("authoring_tool");if(!e||e.length==0)return!1;for(var f=0;f<e.length;++f){var g=e[f].firstChild.nodeValue;if(g.indexOf("Google")==0)return!0}}}return!1},a.Collada.prototype.setUseLights=function(a){this.useLights=a;return this},a.Collada.prototype.getUseLights=function(a){return this.useLights},a.Collada.prototype.setDocument=function(b,c,d){this.url=b,this.loadedCallback=d,b.indexOf("#")!=-1&&(this.rootId=b.substr(b.indexOf("#")+1),b=b.substr(0,b.indexOf("#"))),c&&(b=this.getAbsolutePath(b,c)),this.docURL=b;if(a.ColladaDocuments[b])this.xml=a.ColladaDocuments[b];else{var e=new XMLHttpRequest;if(e){e.overrideMimeType("text/xml");var f=b,g=this;e.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(this.responseXML.getElementById=g.getElementById,g.loaded(f,this.responseXML)):a.error("Error loading Document: "+f+" status "+this.status))},e.open("GET",b,!0),e.send("")}}},a.Collada.prototype.getSource=function(a){var b=this.xml.getElementById(a);if(!b)return[];if(!b.jsArray||this.badAccessor){var c;if(b.tagName=="vertices"){c=[];var d=b.getElementsByTagName("input");for(var e=0;e<d.length;e++)c[e]=this.getSource(d[e].getAttribute("source").substr(1)),c[e].block=d[e].getAttribute("semantic")}else{var f=b.getElementsByTagName("technique_common")[0].getElementsByTagName("accessor")[0],g=this.xml.getElementById(f.getAttribute("source").substr(1)),h=g.tagName;c=this.parseArray(g),stride=parseInt(f.getAttribute("stride")),offset=parseInt(f.getAttribute("offset")),offset||(offset=0),stride||(stride=1),count=parseInt(f.getAttribute("count"));var i=f.getElementsByTagName("param"),j=[];for(var e=0;e<i.length;e++)i[e].hasAttribute("name")||this.exceptions.badAccessor||this.badAccessor?j.push({type:i[e].getAttribute("type"),name:i[e].getAttribute("name")}):j.push(!1);c={array:c,stride:stride,offset:offset,count:count,pmask:j,type:h}}b.jsArray=c}return b.jsArray};var b={};a.Collada.prototype.getMeshes=function(c,d){b[this.url]||(b[this.url]=[]);if(b[this.url][c])return b[this.url][c];var e,f,g,h,i,j,l,m,n,o,p,q=this.xml.getElementById(c);if(!q){a.error("Collada.getMeshes returning [], id: "+c);return[]}var r=q.getElementsByTagName("mesh");if(!r){a.error("Collada.getMeshes returning [], id: "+c);return[]}meshNode=null,r.length?meshNode=r[0]:a.error("Collada.getMeshes returning [], id: "+c);var s=[];if(!meshNode)return s;var t=meshNode.getElementsByTagName("polylist");for(e=0;e<t.length;e++){m=this.parseArray(t[e].getElementsByTagName("p")[0]),vcount=this.parseArray(t[e].getElementsByTagName("vcount")[0]);var u=t[e].getElementsByTagName("input"),v=0;for(f=0;f<u.length;f++)v=Math.max(v,u[f].getAttribute("offset"));var w=[],x=0;for(f=0;f<vcount.length;f++){for(U=0;U<vcount[f]-2;U++){for(k=0;k<=v;k++)w.push(m[x+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+1)+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+2)+k])}x=x+(v+1)*vcount[f]}t[e].getElementsByTagName("p")[0].data=w}var y=meshNode.getElementsByTagName("polygons");for(e=0;e<y.length;e++){var z=y[e].getElementsByTagName("p"),w=[];for(var A=0;A<z.length;A++){var m=this.parseArray(z[A]),u=y[e].getElementsByTagName("input"),v=0;for(f=0;f<u.length;f++)v=Math.max(v,u[f].getAttribute("offset"));var x=0;for(U=0;U<m.length/(v+1)-2;U++){for(k=0;k<=v;k++)w.push(m[x+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+1)+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+2)+k])}x=x+(v+1)*(m.length/(v+1))}z.length>0&&(y[e].getElementsByTagName("p")[0].data=w)}var B=[],w=meshNode.getElementsByTagName("triangles");for(e=0;e<t.length;e++)B.push(t[e]);for(e=0;e<y.length;e++)y[e].getElementsByTagName("p").length>0&&B.push(y[e]);for(e=0;e<w.length;e++)B.push(w[e]);for(e=0;e<B.length;e++){h=B[e].getElementsByTagName("input"),j=[],l=[],i=[],n={};for(f=0;f<h.length;f++){h[f].data=this.getSource(h[f].getAttribute("source").substr(1)),o=h[f].getAttribute("semantic"),o=="TEXCOORD"&&(p=h[f].getAttribute("set"),p||(p=0),o=o+p);if(o=="VERTEX")for(var A=0;A<h[f].data.length;A++)n[h[f].data[A].block]=[];h[f].block=o,h[f].offset=parseInt(h[f].getAttribute("offset")),n[o]=[],i.push(h[f])}B[e].getElementsByTagName("p")[0].data?m=B[e].getElementsByTagName("p")[0].data:m=this.parseArray(B[e].getElementsByTagName("p")[0]);for(var f=0;f<i.length;f++)i[f].block!="VERTEX"&&(i[f].data=[i[f].data],i[f].data[0].block=i[f].block);var v=0;for(f=0;f<i.length;f++)v=Math.max(i[f].offset+1,v);for(U=0;U<m.length;U=U+v)for(f=0;f<i.length;f++)for(var A=0;A<i[f].data.length;A++){var o=i[f].data[A].block,C=i[f].data[A].stride;for(k=0;k<i[f].data[A].stride;k++)i[f].data[A].pmask[k]&&n[o].push(i[f].data[A].array[m[U+i[f].offset]*i[f].data[A].stride+k+i[f].data[A].offset]);if(d&&o=="POSITION")for(k=0;k<d.count;k++)j.push(d.vertexJoints[m[U+i[f].offset]*d.count+k]),l.push(d.vertexWeight[m[U+i[f].offset]*d.count+k]);o=="POSITION"&&C==1&&(n[o].push(0),n[o].push(0)),o=="POSITION"&&C==2&&n[o].push(0),o=="TEXCOORD0"&&C==3&&n[o].pop(),o=="TEXCOORD1"&&C==3&&n[o].pop()}m=[];var D=a.Mesh.WINDING_ORDER_CLOCKWISE;if(n.NORMAL){D=a.Mesh.WINDING_ORDER_CLOCKWISE;for(f=0;f<n.POSITION.length;f=f+9){var E=a.subVec3([n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]],[n.POSITION[f+3],n.POSITION[f+4],n.POSITION[f+5]]),F=a.subVec3([n.POSITION[f+6],n.POSITION[f+7],n.POSITION[f+8]],[n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]]),G=a.crossVec3(F,E),I=0;for(var J=0;J<9;J+=3)G[0]*n.NORMAL[f+J]+G[1]*n.NORMAL[f+J+1]+G[2]*n.NORMAL[f+J+2]<0?I-=1:I+=1;if(I<0){var H=n.POSITION.length/3;m.push(f/3),m.push(f/3+2),m.push(f/3+1)}else m.push(f/3),m.push(f/3+1),m.push(f/3+2)}}else{console.log("Autogenerating normals, do not know facings"),n.NORMAL=[];for(f=0;f<n.POSITION.length;f=f+9){var E=a.subVec3([n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]],[n.POSITION[f+3],n.POSITION[f+4],n.POSITION[f+5]]),F=a.subVec3([n.POSITION[f+6],n.POSITION[f+7],n.POSITION[f+8]],[n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]]),G=a.toUnitVec3(a.crossVec3(a.toUnitVec3(F),a.toUnitVec3(E)));n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2]),n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2]),n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2])}var H=n.POSITION.length/3;for(f=0;f<H;f++)m.push(f)}this.isSketchupFile()||(D=a.Mesh.WINDING_ORDER_UNKNOWN);function K(a,b){return a>b?b:a}var L=21843;L*=3;var M=(m.length-m.length%L)/L+(m.length%L?1:0),N=[],O=3,P=3,Q=2;for(var R=0;R<M;++R)N.push(new a.Mesh(undefined,D)),N[R].setPositions(n.POSITION.slice(L*R*O,K(L*O*(R+1),n.POSITION.length))),N[R].setNormals(n.NORMAL.slice(L*R*P,K(L*(R+1)*P,n.POSITION.length))),n.TEXCOORD0&&N[R].setUV(n.TEXCOORD0.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD0.length))),!n.TEXCOORD0&&n.TEXCOORD1&&N[R].setUV(n.TEXCOORD1.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD1.length))),n.TEXCOORD1&&N[R].setUV2(n.TEXCOORD1.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD1.length)));if(d){if(d.count>8){var S=[],T=[];for(var U=0;U<l.length;U=U+d.count){var V=[];for(k=0;k<d.count;k++)V.push({weight:l[U+k],joint:j[U+k]});V.sort(function(a,b){return parseFloat(b.weight)-parseFloat(a.weight)});for(k=0;k<8;k++)S.push(V[k].joint),T.push(V[k].weight)}j=S,l=T,d.count=8}for(var R=0;R<M;++R){N[R].setJoints(d.joints),N[R].setInvBindMatrix(d.inverseBindMatrix);var W=K(L*(R+1)*d.count,j.length),X=L*R*d.count;N[R].setVertexJoints(j.slice(X,W),d.count),N[R].setVertexWeights(l.slice(X,W),d.count)}}for(var R=0;R<M;++R)N[R].setFaces(m.slice(0,K(L*(R+1),m.length)-L*R)),N[R].matName=B[e].getAttribute("material"),s.push(N[R])}b[this.url][c]=s;return s},a.Collada.prototype.getFloat4=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("float4")[0].firstChild.nodeValue;return null},a.Collada.prototype.getFloat=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("float")[0].firstChild.nodeValue;return null},a.Collada.prototype.getSampler=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("sampler2D")[0].getElementsByTagName("source")[0].firstChild.nodeValue;return null},a.Collada.prototype.getSurface=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("surface")[0].getElementsByTagName("init_from")[0].firstChild.nodeValue;return null},a.Collada.prototype.getImage=function(a){var b=this.xml.getElementById(a);if(b)return this.getAbsolutePath(b.getElementsByTagName("init_from")[0].firstChild.nodeValue,this.docURL)},a.Collada.prototype.createMaterialLayer=function(b,c,d,e,f){var g,h=this.getSurface(d,this.getSampler(d,b.getAttribute("texture")));h||(h=b.getAttribute("texture")),g=this.getImage(h);var i=new a.Texture;i.setSrc(g),c.addTexture(i);var j=new a.MaterialLayer;j.setTexture(i),j.setMapto(e),b.hasAttribute("texcoord")&&f[b.getAttribute("texcoord")]?f[b.getAttribute("texcoord")]==1?j.setMapinput(a.UV2):f[b.getAttribute("texcoord")]==0?j.setMapinput(a.UV1):(a.error("GLGE only supports 2 texture sets\n"),j.setMapinput(a.UV1)):(a.error("Collada material does not specify texture coordinates, but it may have them: defaulting to set 0\n"),j.setMapinput(a.UV1));if(b.getElementsByTagName("blend_mode")[0])var k=b.getElementsByTagName("blend_mode")[0].firstChild.nodeValue;k=="MULTIPLY"&&j.setBlendMode(a.BL_MUL),c.addMaterialLayer(j)};var d={};a.Collada.prototype.getMaterial=function(b,e){d[this.url]||(d[this.url]={});if(d[this.url][b])return d[this.url][b];var f=this.xml.getElementsByTagName("library_materials")[0],g=c(f,b);if(!g){var h=new a.Material;d[this.url][b]=h;return h}var i=g.getElementsByTagName("instance_effect")[0].getAttribute("url").substr(1),j=this.xml.getElementById(i),k=j.getElementsByTagName("profile_COMMON")[0],l=k.getElementsByTagName("technique")[0],h=new a.Material;h.setSpecular(0),d[this.url][b]=h;var m,n,o=l.getElementsByTagName("ambient");if(o.length>0){m=o[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setAmbient({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setAmbient({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_AMBIENT,e)}while(m=m.nextSibling)}var p=l.getElementsByTagName("diffuse");if(p.length>0){m=p[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setColor({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setColor({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_COLOR,e)}while(m=m.nextSibling)}var q=l.getElementsByTagName("bump");if(q.length>0){m=q[0].firstChild;do switch(m.tagName){case"texture":this.createMaterialLayer(m,h,k,a.M_NOR,e)}while(m=m.nextSibling)}var r=l.getElementsByTagName("shininess");if(r.length>0){h.setSpecular(1),m=l.getElementsByTagName("shininess")[0].firstChild;do switch(m.tagName){case"float":parseFloat(m.firstChild.nodeValue)>1?h.setShininess(parseFloat(m.firstChild.nodeValue)):h.setShininess(parseFloat(m.firstChild.nodeValue)*128);break;case"param":var s=parseFloat(this.getFloat(k,m.getAttribute("ref")));s>1?h.setShininess(s):h.setShininess(s*128);break;case"texture":this.createMaterialLayer(m,h,k,a.M_SHINE,e)}while(m=m.nextSibling)}var t=l.getElementsByTagName("specular");if(t.length>0){h.setSpecular(1),m=t[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setSpecularColor({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setSpecularColor({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_SPECCOLOR,e)}while(m=m.nextSibling)}var u=l.getElementsByTagName("emission");if(u.length>0){m=u[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.split(" "),h.setEmit(n[0]);break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).split(" "),h.setEmit(n[0]);break;case"texture":this.createMaterialLayer(m,h,k,a.M_EMIT,e)}while(m=m.nextSibling)}var v=l.getElementsByTagName("reflective");if(v.length>0){m=v[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" ");break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" ");break;case"texture":this.createMaterialLayer(m,h,k,a.M_REFLECT,e)}while(m=m.nextSibling)}var w=l.getElementsByTagName("transparency");if(w.length>0){m=w[0].firstChild;do switch(m.tagName){case"float":break;case"param":}while(m=m.nextSibling)}var x=l.getElementsByTagName("transparent");if(x.length>0){var y=x[0].getAttribute("opaque");y||(y="A_ONE"),m=x[0].firstChild;do switch(m.tagName){case"float":var z=parseFloat(m.firstChild.nodeValue);z<1&&(h.setAlpha(parseFloat(m.firstChild.nodeValue)),h.trans=!0);break;case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" ");var z=this.getMaterialAlpha(n,y,1);z<1&&(h.setAlpha(z),h.trans=!0);break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" ");var z=this.getMaterialAlpha(n,y,1);z<1&&(h.setAlpha(z),h.trans=!0);break;case"texture":this.createMaterialLayer(m,h,k,a.M_ALPHA,e),h.trans=!0}while(m=m.nextSibling)}return h},a.Collada.prototype.getMaterialAlpha=function(a,b,c){var d;switch(b){case"A_ONE":d=parseFloat(a[3])*c;break;case"A_ZERO":d=1-parseFloat(a[3])*c;break;case"RGB_ONE":var e=parseFloat(a[0])*.212671+parseFloat(a[1])*.71516+parseFloat(a[2])*.072169;d=e*c;break;case"RGB_ZERO":var e=parseFloat(a[0])*.212671+parseFloat(a[1])*.71516+parseFloat(a[2])*.072169;d=1-e*c}return d},a.Collada.prototype.setMaterialOntoMesh=function(b,c){var d=c.getElementsByTagName("instance_material"),e={};for(var f=0;f<d.length;f++){var g=d[f].getElementsByTagName("bind_vertex_input"),h={};for(var i=0;i<g.length;i++)if(g[i].hasAttribute("input_set"))h[g[i].getAttribute("semantic")]=g[i].getAttribute("input_set");else{function j(a){var b="";for(var c=a.length-1;c>=0;--c)a[c]>="0"&&a[c]<="9"&&(b=a[c]+b);if(b.length==0)return"0";return b}h[g[i].getAttribute("semantic")]=j(g[i].getAttribute("semantic"))}mat=this.getMaterial(d[f].getAttribute("target").substr(1),h),e[d[f].getAttribute("symbol")]=mat}var k=new a.Object;for(f=0;f<b.length;f++){e[b[f].matName]&&e[b[f].matName].trans&&(k.setZtransparent(!0),k.setPickable(!1));var l=new a.MultiMaterial;l.setMesh(b[f]),e[b[f].matName]||(e[b[f].matName]=new a.Material,e[b[f].matName].setColor("lightgrey")),l.setMaterial(e[b[f].matName]),k.addMultiMaterial(l)}k.setSkeleton(this),c.GLGEObj=k},a.Collada.prototype.getInstanceGeometry=function(b){if(b.GLGEObj&&!1){var c=new a.ObjectInstance;c.setObject(b.GLGEObj);return c}var d=this.getMeshes(b.getAttribute("url").substr(1));this.setMaterialOntoMesh(d,b);return b.GLGEObj},a.Collada.prototype.getAnimationSampler=function(b,c){var d=30,e=this.xml.getElementById(b).getElementsByTagName("input"),f={},g=[],h,i;for(var j=0;j<e.length;j++)h=this.getSource(e[j].getAttribute("source").substr(1)),i=e[j].getAttribute("semantic"),g.push({block:i,data:h});for(n=0;n<g.length;n++){i=g[n].block,f[i]={},f[i].data=[],f[i].names=[];for(k=0;k<g[n].data.array.length;k=k+g[n].data.stride){var l=0;for(j=0;j<g[n].data.pmask.length;j++)if(g[n].data.pmask[j]){f[i].names.push(g[n].data.pmask[j].name);if(g[n].data.pmask[j].type=="float4x4"){f[i].stride=16;for(p=0;p<16;p++)f[i].data.push(g[n].data.array[p+k+g[n].data.offset+j])}else l++,f[i].stride=l,f[i].data.push(g[n].data.array[k+g[n].data.offset+j])}}}var m,o=[];for(var j=0;j<f.OUTPUT.stride;j++)o.push(new a.AnimationCurve);for(var j=0;j<f.INPUT.data.length;j++)for(var p=0;p<f.OUTPUT.stride;p++){o[p].name=f.OUTPUT.names[p],f.INTERPOLATION&&f.INTERPOLATION.data[j]=="BEZIER"&&!f.IN_TANGENT&&(f.INTERPOLATION.data[j]="LINEAR");if(!f.INTERPOLATION||f.INTERPOLATION.data[j]=="LINEAR"){m=new a.LinearPoint,m.setX(f.INPUT.data[j]*d);var q=parseFloat(f.OUTPUT.data[j*f.OUTPUT.stride+p]);q==-180&&(q=-179.9),q==180&&(q=179.9),this.exceptions.flipangle&&c&&(o[p].lastval&&(Math.abs(o[p].lastval-(360+q))<Math.abs(o[p].lastval-q)?q=360+q:Math.abs(o[p].lastval-(q-360))<Math.abs(o[p].lastval-q)&&(q=q-360))),m.setY(q),o[p].lastval=q,o[p].addPoint(m)}f.INTERPOLATION&&f.INTERPOLATION.data[j]=="BEZIER"&&(m=new a.BezTriple,m.setX1(f.IN_TANGENT.data[(j*f.OUTPUT.stride+p)*2]*d),m.setY1(f.IN_TANGENT.data[(j*f.OUTPUT.stride+p)*2+1]),m.setX2(Math.round(f.INPUT.data[j]*d)),m.setY2(f.OUTPUT.data[j*f.OUTPUT.stride+p]),m.setX3(f.OUT_TANGENT.data[(j*f.OUTPUT.stride+p)*2]*d),m.setY3(f.OUT_TANGENT.data[(j*f.OUTPUT.stride+p)*2+1]),o[p].addPoint(m))}return o},a.Collada.prototype.getAnimationVector=function(b){var c=0,d=this.xml.getElementById(b[0].target[0]),e=d.firstChild,f=[],g={};do{switch(e.tagName){case"matrix":case"translate":case"rotate":case"scale":def={type:e.tagName,data:this.parseArray(e),animations:[]},e.hasAttribute("sid")&&(g[e.getAttribute("sid")]=def),f.push(def)}e=e.nextSibling}while(e);var h={};for(var i=0;i<b.length;i++){var j=b[i].target,k=this.getAnimationSampler(b[i].source,/ANGLE/i.test(j));for(n=0;n<k.length;n++)c=Math.max(c,k[n].keyFrames[k[n].keyFrames.length-1].x);if(j[1].indexOf(".")!=-1){var l=j[1].split(".");switch(l[1]){case"X":g[l[0]].animations[0]=k[0];break;case"Y":g[l[0]].animations[1]=k[0];break;case"Z":g[l[0]].animations[2]=k[0];break;case"ANGLE":g[l[0]].animations[3]=k[0]}}else if(j[1].indexOf("(")!=-1){var m=j[1].split("(");sidtarget=m.shift(),m.length>1?m=parseInt(m[0])+4*parseInt(m[1]):m=parseInt(m[0]),g[sidtarget].animations[m]=k[0]}else for(var n=0;n<k.length;n++)switch(k[n].name){case"X":g[j[1]].animations[0]=k[n];break;case"Y":g[j[1]].animations[1]=k[n];break;case"Z":g[j[1]].animations[2]=k[n];break;case"ANGLE":g[j[1]].animations[3]=k[n];break;default:g[j[1]].animations[n]=k[n]}}var o=new a.AnimationVector;o.setFrames(c);var p=new a.AnimationCurve;p.setChannel("QuatX");var q=new a.AnimationCurve;q.setChannel("QuatY");var r=new a.AnimationCurve;r.setChannel("QuatZ");var s=new a.AnimationCurve;s.setChannel("QuatW");var t=new a.AnimationCurve;t.setChannel("LocX");var u=new a.AnimationCurve;u.setChannel("LocY");var v=new a.AnimationCurve;v.setChannel("LocZ");var w=new a.AnimationCurve;w.setChannel("ScaleX");var x=new a.AnimationCurve;x.setChannel("ScaleY");var y=new a.AnimationCurve;y.setChannel("ScaleZ"),o.addAnimationCurve(p),o.addAnimationCurve(q),o.addAnimationCurve(r),o.addAnimationCurve(s),o.addAnimationCurve(t),o.addAnimationCurve(u),o.addAnimationCurve(v),o.addAnimationCurve(w),o.addAnimationCurve(x),o.addAnimationCurve(y);var z=null;for(var A=0;A<c;A++){var B=a.identMatrix();for(var i=0;i<f.length;i++)switch(f[i].type){case"matrix":var C=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2],f[i].animations[3]?f[i].animations[3].getValue(A):f[i].data[3],f[i].animations[4]?f[i].animations[4].getValue(A):f[i].data[4],f[i].animations[5]?f[i].animations[5].getValue(A):f[i].data[5],f[i].animations[6]?f[i].animations[6].getValue(A):f[i].data[6],f[i].animations[7]?f[i].animations[7].getValue(A):f[i].data[7],f[i].animations[8]?f[i].animations[8].getValue(A):f[i].data[8],f[i].animations[9]?f[i].animations[9].getValue(A):f[i].data[9],f[i].animations[10]?f[i].animations[10].getValue(A):f[i].data[10],f[i].animations[11]?f[i].animations[11].getValue(A):f[i].data[11],f[i].animations[12]?f[i].animations[12].getValue(A):f[i].data[12],f[i].animations[13]?f[i].animations[13].getValue(A):f[i].data[13],f[i].animations[14]?f[i].animations[14].getValue(A):f[i].data[14],f[i].animations[15]?f[i].animations[15].getValue(A):f[i].data[15]];B=a.mulMat4(B,a.Mat4(C));break;case"rotate":var D=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2],f[i].animations[3]?f[i].animations[3].getValue(A):f[i].data[3]];B=a.mulMat4(B,a.angleAxis(D[3]*.017453278,[D[0],D[1],D[2]]));break;case"translate":var E=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2]];B=a.mulMat4(B,a.translateMatrix(E[0],E[1],E[2]));break;case"scale":var F=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2]];B=a.mulMat4(B,a.scaleMatrix(F[0],F[1],F[2]))}scale=a.matrix2Scale(B),B=a.mulMat4(B,a.scaleMatrix(1/scale[0],1/scale[1],1/scale[2])),quat=a.rotationMatrix2Quat(B),z&&(z[0]*quat[0]+z[1]*quat[1]+z[2]*quat[2]+z[3]*quat[3]<0&&(quat[0]=quat[0]*-1,quat[1]=quat[1]*-1,quat[2]=quat[2]*-1,quat[3]=quat[3]*-1)),z=quat,point=new a.LinearPoint,point.setX(A),point.setY(quat[0]),p.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[1]),q.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[2]),r.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[3]),s.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[3]),t.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[7]),u.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[11]),v.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[0].toFixed(4)),w.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[1].toFixed(4)),x.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[2].toFixed(4)),y.addPoint(point)}return o};var e={};a.Collada.prototype.getAnimations=function(){if(e[this.url])this.actions=e[this.url];else{var b=this.xml.getElementsByTagName("animation_clip"),c=this.xml.getElementsByTagName("animation");if(b.length==0){c.name="default";var d=[c]}else{var d=[];for(var f=0;f<b.length;f++){var g=[],h=b[f].getElementsByTagName("instance_animation");for(var i=0;i<h.length;i++)g.push(this.xml.getElementById(h[i].getAttribute("url").substr(1)));g.name=b[f].getAttribute("id"),d.push(g)}}for(var j=0;j<d.length;j++){var c=d[j],k,l,m,o={};for(var f=0;f<c.length;f++){k=c[f].getElementsByTagName("channel");for(var i=0;i<k.length;i++){var l=k[i].getAttribute("target").split("/");m=k[i].getAttribute("source").substr(1),o[l[0]]||(o[l[0]]=[]),o[l[0]].push({source:m,target:l})}}var p=new a.Action;for(l in o){var q=this.getAnimationVector(o[l]),r=this.xml.getElementById(l);for(var f=0;f<r.GLGEObjects.length;f++){var s=new a.ActionChannel,t=r.GLGEObjects[f].getName();s.setTarget(t),s.setAnimation(q),p.addActionChannel(s)}}this.addColladaAction({name:c.name,action:p})}}e[this.url]=this.actions;for(n in this.actions){this.setAction(this.actions[n],0,!0);break}},a.Collada.prototype.addColladaAction=function(a){this.actions[a.name]=a.action},a.Collada.prototype.getColladaActions=function(){return this.actions},a.Collada.prototype.getInstanceController=function(b){var c=new a.Object,d=this.xml.getElementById(b.getAttribute("url").substr(1)),e=b.getElementsByTagName("skeleton"),f=d.getElementsByTagName("joints")[0],g=f.getElementsByTagName("input"),h;d.getElementsByTagName("bind_shape_matrix").length>0?h=this.parseArray(d.getElementsByTagName("bind_shape_matrix")[0]):h=a.identMatrix();var i=[h],j=new a.Group;this.addGroup(j);var f=[j],k;for(var l=0;l<g.length;l++)if(g[l].getAttribute("semantic")=="JOINT"){var m=this.getSource(g[l].getAttribute("source").substr(1));if(m.type=="IDREF_array"){var n=m.array.length!=0;for(var o=0;o<m.array.length;o=o+m.stride){var p=this.getNode(this.xml.getElementById(m.array[o]),!0),q=p.getName();this.xml.getElementById(m.array[o])?n=!1:(a.error("Bone is not specified "+m.array[o]),i=[h=a.identMatrix()]),f.push(q)}n&&(i=[h=a.identMatrix()])}else if(m.type=="Name_array"){var r={},s,q;if(e.length==0){var t=this.xml.getElementsByTagName("node");for(o=0;o<t.length;o++)s=t[o].getAttribute("sid"),s&&(r[s]=t[o]),q=t[o].getAttribute("name"),q&&!r[q]&&(r[q]=t[o])}else for(var u=0;u<e.length;u++){var v=this.xml.getElementById(e[u].firstChild.nodeValue.substr(1));s=v.getAttribute("sid"),s&&(r[s]=v);var t=v.getElementsByTagName("*");for(o=0;o<t.length;o++)s=t[o].getAttribute("sid"),s&&(r[s]=t[o]),q=t[o].getAttribute("name"),q&&!r[q]&&(r[q]=t[o])}for(var o=0;o<m.array.length;o=o+m.stride)if(m.array[o]!=""){var q=this.getNode(r[m.array[o]],!0).getName();f.push(q)}}}for(var l=0;l<g.length;l++)if(g[l].getAttribute("semantic")=="INV_BIND_MATRIX"){var w=this.getSource(g[l].getAttribute("source").substr(1));for(var o=0;o<w.array.length;o=o+w.stride)k=w.array.slice(o,o+16),i.push(a.mulMat4(a.Mat4(k),a.Mat4(h.slice(0,16))))}var x=d.getElementsByTagName("vertex_weights")[0];g=x.getElementsByTagName("input");var y=[],z={};for(u=0;u<g.length;u++){E=g[u].getAttribute("semantic"),g[u].data=this.getSource(g[u].getAttribute("source").substr(1)),g[u].block=E,z[E]=[];var A=g[u].getAttribute("offset");y[A]||(y[A]=[]),y[A].push(g[u])}var B=this.parseArray(x.getElementsByTagName("vcount")[0]),C=this.parseArray(x.getElementsByTagName("v")[0]),D=0;for(var l=0;l<B.length;l++)B[l]&&(D=Math.max(D,parseInt(B[l])));vPointer=0;var E;for(var l=0;l<B.length;l++){for(var F=0;F<B[l];F++)for(var o=0;o<y.length;o++)for(var G=0;G<y[o].length;++G){E=y[o][G].block;for(u=0;u<y[o][G].data.stride;u++)y[o][G].data.pmask[u]&&(E!="JOINT"?z[E].push(y[o][G].data.array[parseInt(C[vPointer])+parseInt(y[o][G].data.offset)]):z[E].push(parseInt(C[vPointer])),vPointer++)}for(F=F;F<D;F++)for(var o=0;o<y.length;o++)for(var G=0;G<y[o].length;++G)E=y[o][G].block,z[E].push(0)}if(!this.badAccessor&&z.JOINT.length==0){this.badAccessor=!0;return this.getInstanceController(b)}for(var l=0;l<z.JOINT.length;l++)z.JOINT[l]++;if(this.exceptions.negjoints)for(var l=0;l<z.JOINT.length;l++)z.JOINT[l]==0&&(z.WEIGHT[l]=0);var H={vertexJoints:z.JOINT,vertexWeight:z.WEIGHT,joints:f,inverseBindMatrix:i,count:D},I=this.getMeshes(d.getElementsByTagName("skin")[0].getAttribute("source").substr(1),H);this.setMaterialOntoMesh(I,b);return b.GLGEObj},a.Collada.prototype.getInstanceLight=function(b){var c=b.getElementsByTagName("technique_common")[0].getElementsByTagName("*")[0],d=new a.Light,e=c.getElementsByTagName("color");if(e.length>0){var f=e[0].firstChild.nodeValue.split(" "),g="rgb("+(f[0]*255|0)+","+(f[1]*255|0)+","+(f[2]*255|0)+")";d.setColor(g)}switch(c.tagName){case"point":case"spot":d.setType(a.L_POINT);var h=c.getElementsByTagName("constant_attenuation");h.length>0&&d.setAttenuationConstant(parseFloat(h[0].firstChild.nodeValue));var i=c.getElementsByTagName("linear_attenuation");i.length>0&&d.setAttenuationLinear(parseFloat(i[0].firstChild.nodeValue));var j=c.getElementsByTagName("quadratic_attenuation");j.length>0&&d.setAttenuationQuadratic(parseFloat(j[0].firstChild.nodeValue));case"spot":d.setType(a.L_SPOT);var k=c.getElementsByTagName("falloff_exponent");if(k.length>0){var l=parseFloat(k[0].firstChild.nodeValue);l<1.0001&&(l*=128),d.setSpotExponent(l)}var m=c.getElementsByTagName("falloff_angle");m.length>0&&d.setSpotCosCutOff(Math.cos(parseFloat(m[0].firstChild.nodeValue)/180*Math.PI))}return d},a.Collada.prototype.getNode=function(b,c){if(!c&&b.GLGEObject){d=b.GLGEObject,delete this.GLGEObject;return d}if(c&&b&&b.GLGEObjects)return b.GLGEObjects[0];var d=new a.Group,e="bone"+ ++this.boneIdx;d.setName(e);if(!b)return d;b.GLGEObjects||(b.GLGEObjects=[]),b.GLGEObjects.push(d);var f=b.firstChild,g=a.identMatrix(),h;if(f)do switch(f.tagName){case"node":d.addGroup(this.getNode(f));break;case"instance_node":d.addGroup(this.getNode(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"instance_visual_scene":d.addGroup(this.getNode(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"instance_light":this.useLights&&d.addLight(this.getInstanceLight(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"instance_geometry":d.addObject(this.getInstanceGeometry(f));break;case"instance_controller":d.addObject(this.getInstanceController(f));break;case"matrix":g=this.parseArray(f);break;case"translate":h=this.parseArray(f),g=a.mulMat4(g,a.translateMatrix(h[0],h[1],h[2]));break;case"rotate":h=this.parseArray(f),g=a.mulMat4(g,a.angleAxis(h[3]*.017453278,[h[0],h[1],h[2]]));break;case"scale":h=this.parseArray(f),g=a.mulMat4(g,a.scaleMatrix(h[0],h[1],h[2]))}while(f=f.nextSibling);d.setLoc(g[3],g[7],g[11]);var i=a.Mat4([g[0],g[1],g[2],0,g[4],g[5],g[6],0,g[8],g[9],g[10],0,0,0,0,1]);d.setRotMatrix(i),c&&(b.GLGEObject=d);return d},a.Collada.prototype.initVisualScene=function(){var b=this.xml.getElementsByTagName("asset"),c="Z_UP";if(b.length){var d=b[0].getElementsByTagName("up_axis");if(d.length){d=d[0];var e=d.firstChild.nodeValue;e.length&&(c=e)}}var f=this;c[0]!="Y"&&c[0]!="y"&&(f=new a.Group,this.addChild(f),c[0]!="Z"&&c[0]!="z"?this.setRotMatrix(a.Mat4([0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1])):this.setRotMatrix(a.Mat4([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1])));if(this.rootId){var h=this.xml.getElementById(this.rootId);h?f.addGroup(this.getNode(h)):a.error("Asset "+this.rootId+" not found in document"+this.url)}else{var g=this.xml.getElementsByTagName("scene");g.length>0?f.addGroup(this.getNode(g[0])):a.error("Please indicate the asset to render in Collada Document"+this.url)}};var f={"default":{},"COLLADA Mixamo exporter":{badAccessor:!0},"Blender2.5":{flipangle:!0,negjoints:!0}};a.Collada.prototype.getExceptions=function(){if(this.xml.getElementsByTagName("authoring_tool").length>0&&this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue=="COLLADA Mixamo exporter")return f["COLLADA Mixamo exporter"];if(this.xml.getElementsByTagName("authoring_tool").length>0&&/Blender 2.5/.test(this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue))return f["Blender2.5"]},a.Collada.prototype.loaded=function(a,b){this.xml=b,b.getElementsByTagName("authoring_tool").length>0&&(this.exceptions=f[b.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue]),this.exceptions=this.getExceptions(),this.exceptions||(this.exceptions=f["default"]),this.initVisualScene(),this.getAnimations(),this.loadedCallback&&this.loadedCallback(this);var c=this;setTimeout(function(){c.fireEvent("loaded",{url:this.url}),c.isComplete()&&c.fireEvent("downloadComplete",{})},1)},a.Scene.prototype.addCollada=a.Scene.prototype.addGroup,a.Group.prototype.addCollada=a.Group.prototype.addGroup,a.Document&&(a.Document.prototype.getCollada=function(b){b.object||(b.object=new(a[this.classString(b.tagName)]),b.object.setDocument(b.getAttribute("document"),this.getAbsolutePath(this.rootURL,null)),b.removeAttribute("document"),this.setProperties(b));return b.object})}(GLGE);if(!GLGE)var GLGE={};(function(a){a.HeightMap=function(a,b,c,d,e,f,g,h,i){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=b,this.canvas.height=c,this.minX=d,this.maxX=e,this.minY=f,this.maxY=g,this.minZ=h,this.maxZ=i;var j=new Image;j.heightmap=this,j.onload=function(a){this.heightmap.context.drawImage(this,0,0),this.heightmap.data=this.heightmap.context.getImageData(0,0,this.heightmap.canvas.width,this.heightmap.canvas.height).data},j.src=a},a.HeightMap.prototype.canvas=null,a.HeightMap.prototype.context=null,a.HeightMap.prototype.minZ=null,a.HeightMap.prototype.maxZ=null,a.HeightMap.prototype.minY=null,a.HeightMap.prototype.maxY=null,a.HeightMap.prototype.minX=null,a.HeightMap.prototype.maxX=null,a.HeightMap.prototype.data=null,a.HeightMap.prototype.getPixelAt=function(a,b){return this.data?this.data[(this.canvas.width*b+a)*4]/255*(this.maxZ-this.minZ):0},a.HeightMap.prototype.getHeightAt=function(a,b){var c;if(this.lastx!=undefined&&a==this.lastx&&b==this.lasty)c=this.lastValue;else{var d=Math.round((a-this.minX)/(this.maxX-this.minX)*this.canvas.width),e=Math.round((b-this.minY)/(this.maxY-this.minY)*this.canvas.height);c=this.getPixelAt(d,e),this.lastValue=c}this.lastx=a,this.lasty=b;return c},a.KeyInput=function(){document.keyStates||(document.keyStates=[]),document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1)},a.KeyInput.prototype.isKeyPressed=function(a){return document.keyStates[a]?!0:!1};var b=null;a.KeyInput.prototype.onKeyDown=function(a){document.keyStates[a.keyCode]=!0},a.KeyInput.prototype.onKeyUp=function(a){document.keyStates[a.keyCode]=!1},a.MouseInput=function(a){this.element=a,this.element.mouseX=0,this.element.mouseY=0,this.element.buttonState||(this.element.buttonState=[]),a.addEventListener("mousemove",this.onMouseMove,!1),a.addEventListener("mousedown",this.onMouseDown,!1),a.addEventListener("mouseup",this.onMouseUp,!1)},a.MouseInput.prototype.element=null,a.MouseInput.prototype.onMouseMove=function(a){this.mouseX=a.clientX,this.mouseY=a.clientY},a.MouseInput.prototype.onMouseDown=function(a){this.buttonState[a.button]=!0},a.MouseInput.prototype.onMouseUp=function(a){this.buttonState[a.button]=!1},a.MouseInput.prototype.isButtonDown=function(a){return this.element.buttonState[a]?!0:!1},a.MouseInput.prototype.getMousePosition=function(){return{x:this.element.mouseX,y:this.element.mouseY}},a.MI_LEFT=0,a.MI_MIDDLE=1,a.MI_RIGHT=2,a.KI_BACKSPACE=8,a.KI_TAB=9,a.KI_ENTER=13,a.KI_SHIFT=16,a.KI_CTRL=17,a.KI_ALT=18,a.KI_PAUSE_BREAK=19,a.KI_CAPS_LOCK=20,a.KI_ESCAPE=27,a.KI_PAGE_UP=33,a.KI_PAGE_DOWN=34,a.KI_END=35,a.KI_HOME=36,a.KI_LEFT_ARROW=37,a.KI_UP_ARROW=38,a.KI_RIGHT_ARROW=39,a.KI_DOWN_ARROW=40,a.KI_INSERT=45,a.KI_DELETE=46,a.KI_0=48,a.KI_1=49,a.KI_2=50,a.KI_3=51,a.KI_4=52,a.KI_5=53,a.KI_6=54,a.KI_7=55,a.KI_8=56,a.KI_9=57,a.KI_A=65,a.KI_B=66,a.KI_C=67,a.KI_D=68,a.KI_E=69,a.KI_F=70,a.KI_G=71,a.KI_H=72,a.KI_I=73,a.KI_J=74,a.KI_K=75,a.KI_L=76,a.KI_M=77,a.KI_N=78,a.KI_O=79,a.KI_P=80,a.KI_Q=81,a.KI_R=82,a.KI_S=83,a.KI_T=84,a.KI_U=85,a.KI_V=86,a.KI_W=87,a.KI_X=88,a.KI_Y=89,a.KI_Z=90,a.KI_LEFT_WINDOW_KEY=91,a.KI_RIGHT_WINDOW_KEY=92,a.KI_SELECT_KEY=93,a.KI_NUMPAD_0=96,a.KI_NUMPAD_1=97,a.KI_NUMPAD_2=98,a.KI_NUMPAD_3=99,a.KI_NUMPAD_4=100,a.KI_NUMPAD_5=101,a.KI_NUMPAD_6=102,a.KI_NUMPAD_7=103,a.KI_NUMPAD_8=104,a.KI_NUMPAD_9=105,a.KI_MULTIPLY=106,a.KI_ADD=107,a.KI_SUBTRACT=109,a.KI_DECIMAL_POINT=110,a.KI_DIVIDE=111,a.KI_F1=112,a.KI_F2=113,a.KI_F3=114,a.KI_F4=115,a.KI_F5=116,a.KI_F6=117,a.KI_F7=118,a.KI_F8=119,a.KI_F9=120,a.KI_F10=121,a.KI_F11=122,a.KI_F12=123,a.KI_NUM_LOCK=144,a.KI_SCROLL_LOCK=145,a.KI_SEMI_COLON=186,a.KI_EQUAL_SIGN=187,a.KI_COMMA=188,a.KI_DASH=189,a.KI_PERIOD=190,a.KI_FORWARD_SLASH=191,a.KI_GRAVE_ACCENT=192,a.KI_OPEN_BRACKET=219,a.KI_BACK_SLASH=220,a.KI_CLOSE_BRAKET=221,a.KI_SINGLE_QUOTE=222,a.KI_SPACE=32})(GLGE),function(a){a.Wavefront=function(b){a.Assets.registerAsset(this,b),this.multimaterials=[],this.materials={},this.instances=[],this.queue=[]},a.augment(a.Object,a.Wavefront),a.Wavefront.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,7)=="https://")return a;b||(b=window.location.href);var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},a.Wavefront.prototype.loadMaterials=function(a){this.loading?this.queue.push(a):this.loadFile(a,null,function(a,b){this.parseMaterials(b.split("\n"));if(this.queue.length>0){var c=this.queue.pop();this.loadMaterial(c)}else this.parseMesh()})},a.Wavefront.prototype.parseMaterials=function(b){for(var c=0;c<b.length;c++){if(b[c].substr(0,6)=="newmtl"){var d=b[c].split(" "),e=new a.Material;this.materials[d[1]]=e,c++}var d=b[c].split(" ");if(d.length>1)switch(d[0]){case"Kd":e.setColorR(parseFloat(d[1])),e.setColorG(parseFloat(d[2])),e.setColorB(parseFloat(d[3]));break;case"Ks":e.setSpecularColor({r:parseFloat(d[1]),g:parseFloat(d[2]),b:parseFloat(d[3])});break;case"Ns":e.setShininess(parseFloat(d[1]));break;case"d":case"Tr":this.setZtransparent(!0),e.setAlpha(parseFloat(d[1]));break;case"map_Kd":var f=new a.MaterialLayer;f.setMapto(a.M_COLOR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f);case"map_Ks":case"map_spec":var f=new a.MaterialLayer;f.setMapto(a.M_SPECULAR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f);case"bump":case"map_bump":var f=new a.MaterialLayer;f.setMapto(a.M_NOR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f)}}},a.Wavefront.prototype.loadFile=function(b,c,d){this.relativeTo&&!c?c=this.relativeTo:this.relativeTo=b,this.loading=!0,d||(d=this.loaded),b=this.getAbsolutePath(b,c);var e=new XMLHttpRequest,f=this;e&&(e.overrideMimeType("text/plain"),e.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(f.loading=!1,d.call(f,b,this.responseText)):a.error("Error loading Document: "+b+" status "+this.status))},e.open("GET",b,!0),e.send(""))},a.Wavefront.prototype.setSrc=function(a,b){this.loadFile(a,b)},a.Wavefront.prototype.loaded=function(a,b){this.file=objArray=b.split("\n");var c=!1;for(var d=0;d<objArray.length;d++){var e=objArray[d].split(" ");e.length>1&&(e[0]=="mtllib"&&(c=!0,this.loadMaterials(e[1])))}c||this.parseMesh()},a.Wavefront.prototype.createMultiMaterial=function(b,c,d,e,f,g,h){var j=[],k=[],l=[],m=[],n=[];for(i=0;i<f.length;i++){var o=b[f[i]];n.indexOf(o)!=-1&&h?m.push(n.indexOf(o)):(n.push(o),m.push(n.length-1))}f=m;for(i=0;i<n.length;i++){var p=n[i].split("/");c[p[0]-1]||a.error(p[0]),j.push(c[p[0]-1][1]),j.push(c[p[0]-1][2]),j.push(c[p[0]-1][3]),p[1]&&(l.push(e[p[1]-1][1]),l.push(e[p[1]-1][2])),p[2]&&(k.push(d[p[2]-1][1]),k.push(d[p[2]-1][2]),k.push(d[p[2]-1][3]))}var q=new a.MultiMaterial,r=new a.Mesh;r.setPositions(j),l.length>0&&r.setUV(l),k.length>0&&r.setNormals(k),r.setFaces(f),q.setMesh(r),q.setMaterial(g),this.addMultiMaterial(q)},a.Wavefront.prototype.parseMesh=function(){objArray=this.file;var b=[],c=[],d=[],e=[],f=[],g=0,h=!0,i=new a.Material;for(var j=0;j<objArray.length;j++)if(objArray[j][0]!="#"){var k=objArray[j].split(" ");if(k.length>0)switch(k[0]){case"s":k[1]=="1"?h=!0:h=!1;case"o":e.length>0&&(this.createMultiMaterial(f,c,d,b,e,i,h),e=[],i=new a.Material);break;case"usemtl":e.length>0&&(this.createMultiMaterial(f,c,d,b,e,i,h),e=[]),i=this.materials[k[1]];break;case"v":c.push(k);break;case"vt":b.push(k);break;case"vn":d.push(k);break;case"f":var l=[];for(var m=1;m<k.length;m++){var n=f.indexOf(k[m]);if(n==-1||!h)f.push(k[m]),n=f.length-1;l.push(n)}for(m=0;m<l.length-2;m++)e.push(l[0]-g),e.push(l[1+m]-g),e.push(l[2+m]-g)}}this.createMultiMaterial(f,c,d,b,e,i,h)},a.Document.prototype.getWavefront=function(b){if(!b.object){var c=this.getAbsolutePath(this.rootURL,null);b.object=new(a[this.classString(b.tagName)]),b.object.setSrc(this.getAbsolutePath(b.getAttribute("src"),c)),b.removeAttribute("src"),this.setProperties(b)}return b.object}}(GLGE)