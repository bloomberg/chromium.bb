<!--
Copyright(c) 2022 The Chromium Authors.All rights reserved.
Use of this source code is governed by a BSD - style license that can be
found in the LICENSE file.
-->
<html>
<head>
  <title>WebGL MxN Video playbacks</title>
  <style>
    #message {
      position: absolute;
      width: 1600px;
      height: 900px;
      top: 200px;
      left: 400px;
    }
  </style>
  <script type="text/javascript" src="../third_party/stats-js/stats.js"></script>
  <script type="text/javascript" src="video_utils.js"></script>
  <script type="text/javascript" src="webgl_video.js"></script>
  <script>
    const _defaultRows = 7;
    const _defaultColumns = 7;
    const _totalVideoWidth = 1600;
    const _totalVideoHeight = 900;
    var hasUIOnTop = true;
    var hasFPSOnTop = true;
    var codec = 'vp9';

    async function startMxNVideos() {
      const container = document.getElementById('container');
      const p = document.getElementById('message');

      // Initialize WebGL

      const gl = await webglInit(_totalVideoWidth, _totalVideoHeight);
      if (!gl) {
        p.innerHTML = "WebGL not supported!";
        return;
      }

      // Get the UI rendering options from the string.
      const uiOption = parsedString['ui'];
      if (uiOption == 'none')
        hasUIOnTop = false;

      const fpsOption = parsedString['fps'];
      if (fpsOption == 'none')
        hasFPSOnTop = false;

      codecString = parsedString['codec']
      if (codecString == 'vp8')
        codec = 'vp8';
      else if (codecString != 'vp9' && codecString != undefined)
        console.warn('Unsupported video codec format! Switch to default VP9.');

      // Get the number of video rows and columns from the string.
      var videoRows = parsedString['rows'];
      var videoColumns = parsedString['columns'];
      if (videoRows == undefined)
        videoRows = _defaultRows;
      if (videoColumns == undefined)
        videoColumns = _defaultColumns;

      // Limite the number of videos to 20x20.
      // The video will not load when the number is too big.
      const maxColRow = Math.max(videoRows, videoColumns);
      if (maxColRow > 20) {
        p.innerHTML = "Cannot support videos more than 20 x 20 !" + "<br />" +
          "Please change the number of rows/columns.";
        return;
      }

      // Calculate the video onscreen size
      const videoWidth = _totalVideoWidth / maxColRow;
      const videoHeight = _totalVideoHeight / maxColRow;

      // Create MxN videos and a small video (size = 89x50) at the upper right
      // corner to similate the one from the local camera.
      p.innerHTML = "Uploading videos...";
      var videos = [];
      const videoCount = videoRows * videoColumns;
      for (let i = 0; i < videoCount + 1; i++) {
        const video = document.createElement('video');
        video.id = i;
        video.loop = true;
        video.autoplay = true;
        video.muted = true;
        video.display = "none";
        video.src = GetVideoSource(videoCount, i, codec);
        video.width = videoWidth;
        video.height = videoHeight;
        video.crossorigin = "anonymous";
        videos.push(video);
      }
      // For the small video at the upper right corner.
      videos[videoRows * videoColumns].width = videoWidth / 3;
      videos[videoRows * videoColumns].height = videoHeight / 3;
      // Use the 640x360 source to simulate the local camera.
      videos[videoRows * videoColumns].src = GetVideoSource(1, 1, codec);

      await Promise.all(videos.map(video => video.play()));
      p.remove();

      // Simulate video playback by WebGL rendering.
      webglDrawVideoFrames(gl, videos, videoRows, videoColumns,
        hasUIOnTop , hasFPSOnTop);
    }

  </script>
</head>
<body onload="startMxNVideos()">
  <div id="container" style="position:absolute; top:0px; left:0px">
    <p id="message"></p>
  </div>
</body>
</html>
